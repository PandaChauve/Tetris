function Grid(c){var a,b,d=0!==CONFIG.groundUpSpeedPerTic||0!==CONFIG.groundSpeedPerTic;this.container=Array(CONFIG.columnCount);for(a=0;a<CONFIG.columnCount;a+=1)for(this.container[a]=Array(CONFIG.hiddenRowCount),b=0;b<this.container[a].length;b+=1)this.container[a][b]=new Block,this.container[a][b].verticalPosition=b*CONFIG.pixelPerBox,d||(this.container[a][b].type=Block.EType.PlaceHolder,this.container[a][b].state=Block.EState.Blocked);if(void 0===c||""===c)for(a=0;a<CONFIG.columnCount;a+=1)for(b=
this.container[a].length;b<CONFIG.startRows;b+=1)this.container[a].push(new Block),this.container[a][b].verticalPosition=b*CONFIG.pixelPerBox;else this.Load(c)}Grid.prototype.AddNewLine=function(){var c,a;for(c=0;c<CONFIG.columnCount;c+=1){for(a=0;a<this.container[c].length;a+=1)this.container[c][a].verticalPosition+=CONFIG.pixelPerBox;this.container[c].unshift(new Block)}};
Grid.prototype.RemoveBlockFixed=function(c,a){var b=this.container[c][a];this.container[c].splice(a,1);this.MakeTopBlockFall(c,a);return b};Grid.prototype.RemoveBlock=function(c,a){var b=this.FindBlockIndex(c,a);if(-1===b)throw"Not my day";return this.RemoveBlockFixed(c,b)};Grid.prototype.InsertBlock=function(c,a){for(var b=0;b<this.container[a].length;b+=1)if(this.container[a][b].verticalPosition>c.verticalPosition){this.container[a].splice(b,0,c);return}this.container[a].push(c)};
Grid.prototype.FindBlock=function(c,a){var b=this.FindBlockIndex(c,a);return-1===b?null:this.container[c][b]};Grid.prototype.FindBlockIndex=function(c,a){for(var b in this.container[c])if(this.container[c].hasOwnProperty(b)&&this.container[c][b].verticalPosition===CONFIG.pixelPerBox*a)return parseInt(b);return-1};
Grid.prototype.IsBlockIndexFree=function(c,a){for(var b in this.container[c])if(this.container[c].hasOwnProperty(b)&&this.container[c][b].verticalPosition>=CONFIG.pixelPerBox*a&&this.container[c][b].verticalPosition<CONFIG.pixelPerBox*(a+1))return!1;return!0};Grid.prototype.MakeTopBlockFall=function(c,a){if(0>a)throw"Not my day";for(var b=a;b<this.container[c].length&&this.container[c][b].state===Block.EState.Blocked;b+=1)this.container[c][b].SetState(Block.EState.Falling)};
Grid.prototype.AnimateBlockFall=function(c,a,b,d){b.verticalPosition-=CONFIG.fallSpeedPerTic;b.verticalPosition<d&&(b.verticalPosition=d,this.container[c][a-1].state!==Block.EState.Falling&&b.SetState(Block.EState.Blocked));return{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateBlockDisappear=function(c,a,b,d){b.animationState+=CONFIG.disapearSpeedPerTic;return 100<b.animationState&&-1===b.id?(this.container[c].splice(a,1),this.MakeTopBlockFall(c,a),{min:d,deltaY:-1}):{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateSwapped=function(c,a,b,d){b.animationState+=15;if(100<b.animationState){if(b.type===Block.EType.PlaceHolder)return this.RemoveBlockFixed(c,a),{min:d,deltaY:-1};this.container[c][a-1].state===Block.EState.Falling||this.container[c][a-1].verticalPosition<b.verticalPosition-CONFIG.pixelPerBox?(b.SetState(Block.EState.Falling),this.MakeTopBlockFall(c,a+1)):b.SetState(Block.EState.Blocked)}return{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateBlock=function(c,a,b){var d=this.container[c][a];switch(d.state){case Block.EState.Blocked:return{min:d.verticalPosition+CONFIG.pixelPerBox,deltaY:0};case Block.EState.Disappearing:return this.AnimateBlockDisappear(c,a,d,b);case Block.EState.Falling:return this.AnimateBlockFall(c,a,d,b);case Block.EState.SwappedRight:case Block.EState.SwappedLeft:return this.AnimateSwapped(c,a,d,b)}throw"Unsupported animation";};
Grid.prototype.AnimateColumn=function(c){var a,b,d;b=CONFIG.hiddenRowCount*CONFIG.pixelPerBox;for(a=CONFIG.hiddenRowCount;a<this.container[c].length;a+=1)d=this.AnimateBlock(c,a,b),b=d.min,a+=d.deltaY};Grid.prototype.Animate=function(){for(var c=0;c<CONFIG.columnCount;c+=1)this.AnimateColumn(c)};
Grid.prototype.GetMaxFixed=function(){var c,a,b=0;for(c=0;c<CONFIG.columnCount;c+=1)for(a=CONFIG.hiddenRowCount;a<this.container[c].length&&this.container[c][a].state===Block.EState.Blocked;a+=1)this.container[c][a].verticalPosition>b&&(b=this.container[c][a].verticalPosition);return b};Grid.prototype.NewBlockFall=function(c){var a=new Block;a.SetState(Block.EState.Falling);a.verticalPosition=(CONFIG.hiddenRowCount+CONFIG.displayedRowCount+1)*CONFIG.pixelPerBox;this.container[c].push(a)};
Grid.prototype.Swap=function(c,a){var b=this.FindBlock(c,a),d=this.FindBlock(c+1,a);if(null!==b&&null!==d){if(b.state===Block.EState.Blocked&&d.state===Block.EState.Blocked)return this.SwapBlocks(b,d),!0}else{if(null!==b&&this.IsBlockIndexFree(c+1,a)&&b.state===Block.EState.Blocked)return d=new Block,d.type=Block.EType.PlaceHolder,d.state=Block.EState.SwappedLeft,d.verticalPosition=b.verticalPosition,this.InsertBlock(d,c+1),this.SwapBlocks(b,d),!0;if(null!==d&&this.IsBlockIndexFree(c,a)&&d.state===
Block.EState.Blocked)return b=new Block,b.type=Block.EType.PlaceHolder,b.state=Block.EState.SwappedRight,b.verticalPosition=d.verticalPosition,this.InsertBlock(b,c),this.SwapBlocks(b,d),!0}return!1};Grid.prototype.SwapBlocks=function(c,a){var b=c.GetCopy();c.LoadFrom(a);a.LoadFrom(b);c.SetState(Block.EState.SwappedLeft);a.SetState(Block.EState.SwappedRight)};
Grid.prototype.Load=function(c){var a,b;for(a=0;a<c.grid.length;a+=1)for(b=0;b<c.grid[a].length;b+=1){var d=new Block;d.state=c.grid[a][b].state;d.type=c.grid[a][b].type;d.verticalPosition=this.container[a].length*CONFIG.pixelPerBox;this.container[a].push(d)}};Grid.prototype.Evaluate=function(c){return(new GridEvaluator(c)).Evaluate(this.container)};Grid.prototype.BlockCount=function(){for(var c=0,a=0;a<this.container.length;a+=1)c+=this.container[a].length-CONFIG.hiddenRowCount;return c};
