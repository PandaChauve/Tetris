GridEvaluator=function(a){this.series=[];this.stats=a};
GridEvaluator.prototype.EvaluateColumn=function(a,b){for(var c=0,e=null,f=-1,d=CONFIG.hiddenRowCount;d<a[b].length;d+=1)a[b][d].state!==Block.EState.Blocked?(c=0,e=null):a[b][d].type!==e?(e=a[b][d].type,c=1):(c+=1,3===c?(a[b][d].SetState(Block.EState.Disappearing),a[b][d-1].SetState(Block.EState.Disappearing),a[b][d-2].SetState(Block.EState.Disappearing),this.series.push([]),f=this.series.length-1,this.series[f].push(a[b][d].id),this.series[f].push(a[b][d-1].id),this.series[f].push(a[b][d-2].id)):
3<c&&(a[b][d].SetState(Block.EState.Disappearing),this.series[f].push(a[b][d].id)))};GridEvaluator.prototype.EvaluateVertical=function(a){for(var b=0;b<CONFIG.columnCount;b+=1)this.EvaluateColumn(a,b)};GridEvaluator.prototype.FindBlockIndex=function(a,b,c){for(var e in a[b])if(a[b].hasOwnProperty(e)&&a[b][e].verticalPosition===CONFIG.pixelPerBox*c)return parseInt(e);return-1};
GridEvaluator.prototype.EvaluateLine=function(a,b){var c,e,f,d=-1,h=-1,l=-1;f=0;e=null;var g=-1;for(c=0;c<CONFIG.columnCount;c+=1)if(l=h,h=d,d=this.FindBlockIndex(a,c,b),-1===d)f=0;else{var k=a[c][d];k.state===Block.EState.Blocked||k.state===Block.EState.Disappearing&&0===k.animationState?(k.type!==e&&(e=a[c][d].type,f=0),f+=1,3===f?(a[c][d].SetState(Block.EState.Disappearing),a[c-1][h].SetState(Block.EState.Disappearing),a[c-2][l].SetState(Block.EState.Disappearing),this.series.push([]),g=this.series.length-
1,this.series[g].push(a[c][d].id),this.series[g].push(a[c-1][h].id),this.series[g].push(a[c-2][l].id)):3<f&&(a[c][d].SetState(Block.EState.Disappearing),this.series[g].push(a[c][d].id))):f=0}};GridEvaluator.prototype.EvaluateHorizontal=function(a){for(var b=CONFIG.hiddenRowCount;b<CONFIG.displayedRowCount+CONFIG.hiddenRowCount;b+=1)this.EvaluateLine(a,b)};
GridEvaluator.prototype.GetScore=function(){for(var a=this.series.length,b=0,c=0;c<a;c+=1)b+=(this.series[c].length-2)*a;this.stats.AddLines(this.series,b);return b};GridEvaluator.prototype.GetSerie=function(a,b){for(var c=b-1;0<=c;--c)for(var e=0;e<this.series[c].length;e+=1)if(this.series[c][e]===a)return c;return-1};
GridEvaluator.prototype.MergeSeries=function(){for(var a=this.series.length-1;0<=a;--a)for(var b=0;b<this.series[a].length;b+=1){var c=this.GetSerie(this.series[a][b],a);if(-1!==c){this.series[c]=this.series[c].concat(this.series[a]);this.series.splice(a,1);break}}};GridEvaluator.prototype.Evaluate=function(a){this.EvaluateVertical(a);this.EvaluateHorizontal(a);this.MergeSeries();return this.GetScore()};
