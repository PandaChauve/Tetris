function ThreeRenderer(b){void 0===b&&(b=1);this.camera=this.CreateCamera();this.renderer=this.CreateRenderer();this.light=this.CreateLight();this.cursor=[this.CreateCursor(32896)];for(var a=1;a<b;a+=1)this.cursor.push(this.CreateCursor(8388736));this.scene=this.CreateScene();this.offset=0;this.id=String.fromCharCode(65+Math.floor(26*Math.random()))+Date.now()}ThreeRenderer.prototype.clear=function(){this.renderer=this.cursor=this.camera=this.light=this.scene=null};
ThreeRenderer.prototype.CreateLight=function(){var b=new THREE.DirectionalLight(13421772);b.position.set(500,1E3,2E3);b.castShadow=!0;b.shadowCameraVisible=!1;b.shadowDarkness=.2;b.shadowMapWidth=b.shadowMapHeight=1E3;return b};
ThreeRenderer.prototype.CreateScene=function(){var b=new THREE.Scene;b.add(this.light);for(var a=0;a<this.cursor.length;a+=1)b.add(this.cursor[a]);var a=new THREE.PlaneGeometry(1E3,400),c=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.5}),a=new THREE.Mesh(a,c);a.rotation.x+=1.62;a.position.setY(CONFIG.hiddenRowCount*CONFIG.pixelPerBox-CONFIG.pixelPerBox/2);a.renderDepth=1;b.add(a);a=new THREE.BoxGeometry(1E3,3,3);c=new THREE.MeshPhongMaterial({color:3342336,emissive:10027008});
a=new THREE.Mesh(a,c);a.position.set(0,(CONFIG.hiddenRowCount+CONFIG.displayedRowCount)*CONFIG.pixelPerBox,10);b.add(a);a=new THREE.BoxGeometry(1E3,3,3);c=new THREE.MeshPhongMaterial({color:13056,emissive:39168});a=new THREE.Mesh(a,c);a.position.set(0,CONFIG.hiddenRowCount*CONFIG.pixelPerBox-CONFIG.pixelPerBox/2+5,10);b.add(a);return b};ThreeRenderer.prototype.CreateCamera=function(){var b=new THREE.PerspectiveCamera(75,.7,.3,1E3);b.position.z=450;b.position.x=-27;b.position.y=410;return b};
ThreeRenderer.prototype.CreateRenderer=function(){var b=new THREE.WebGLRenderer({antialias:!0});b.setClearColor(0);b.setSize(420,600);b.shadowMapEnabled=!0;b.shadowMapSoft=!0;return b};ThreeRenderer.prototype.AddCube=function(b){var a=new THREE.BoxGeometry(.7*CONFIG.pixelPerBox,.7*CONFIG.pixelPerBox,CONFIG.pixelPerBox/4);b=new THREE.MeshPhongMaterial({color:b,emissive:1118481});a=new THREE.Mesh(a,b);this.scene.add(a);return a.id};
function CalculateX(b,a){return b.state===Block.EState.SwappedLeft?a+CONFIG.pixelPerBox/100*(100-b.animationState):b.state===Block.EState.SwappedRight?a-CONFIG.pixelPerBox/100*(100-b.animationState):a}
ThreeRenderer.prototype.UpdateCube=function(b,a){var c=this.scene.getObjectById(a.id);c.position.setY(a.verticalPosition+this.offset);c.position.setX(CalculateX(a,b));c.material.color=new THREE.Color(a.GetHexColor());a.state===Block.EState.Disappearing&&(c.material.opacity=Math.max(1-a.animationState/100,0),c.material.transparent=!0);0===c.material.opacity&&(this.scene.remove(c),a.id=-1)};
ThreeRenderer.prototype.Render=function(){this.light.position.setY(1E3+this.offset);this.renderer.render(this.scene,this.camera)};ThreeRenderer.prototype.LinkDom=function(b){this.renderer.domElement.setAttribute("id",this.id);var a=$("#"+b+" .gamePlaceHolder");if(0===a.length)throw b+"missing gameplaceHolder";a.empty();a.append($(this.renderer.domElement))};ThreeRenderer.prototype.UnlinkDom=function(){var b=document.getElementById(this.id);null!==b&&b.parentNode.removeChild(b)};
ThreeRenderer.prototype.CreateCursor=function(b){var a=new THREE.Shape;a.absarc(72,-13,10,-Math.PI/2,0,!0);a.lineTo(82,0);a.absarc(72,13,10,0,Math.PI/2,!0);a.lineTo(35,20);a.lineTo(35,0);a.absarc(-2,-13,10,3*Math.PI/2,Math.PI,!0);a.lineTo(-12,0);a.absarc(-2,13,10,Math.PI,Math.PI/2,!0);a.lineTo(35,-20);return new THREE.PointCloud(a.createPointsGeometry(),new THREE.PointCloudMaterial({color:b,size:4}))};
ThreeRenderer.prototype.DrawCursorOn=function(b,a,c){void 0===c&&(c=0);this.cursor[c].position.set((b-CONFIG.columnCount/2)*CONFIG.pixelPerBox-10,a*(CONFIG.pixelPerBox-.5)+this.offset+5,7)};ThreeRenderer.prototype.Freeze=function(){for(var b=0;b<this.cursor.length;b+=1)this.scene.remove(this.cursor[b]);this.Render()};
ThreeRenderer.prototype.RenderTetris=function(b){this.offset=b.groundPos;for(var a,c=0;c<CONFIG.columnCount;c+=1)for(var d=0;d<b.grid.container[c].length;d+=1)a=b.grid.container[c][d],a.type!==Block.EType.PlaceHolder&&(-1===a.id&&(a.id=this.AddCube(a.GetHexColor())),this.UpdateCube((c-CONFIG.columnCount/2)*CONFIG.pixelPerBox,a));for(c=0;c<b.cursor.length;c+=1)this.DrawCursorOn(b.cursor[c].x,b.cursor[c].y,c);this.Render()};
