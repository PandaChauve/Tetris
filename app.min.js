var css=localStorage.getItem("dynamic_css_content");if(css){document.getElementById("switchableTheme").innerHTML=css;var element=document.getElementById("switchableThemeCss");element.parentNode.removeChild(element)}angular.module("angularApp.base",["cgNotify"]),angular.module("angularApp.factories",["angularApp.base"]),angular.module("angularApp.controllers",["ui.bootstrap","angularApp.factories"]),angular.module("angularApp.directives",["ngTouch","angularApp.base","angularApp.factories"]);var angularApp=angular.module("angularApp",["ngRoute","angularApp.base","angularApp.factories","angularApp.controllers","angularApp.directives"]);angularApp.config(["$compileProvider",function(a){"use strict";a.debugInfoEnabled(!1)}]),angularApp.filter("ticToTime",["helpers",function(a){"use strict";return a.timeFromTics}]),angularApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/scores/",{templateUrl:"resources/templates/scores.html",controller:"ScoresCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/achievements/",{templateUrl:"resources/templates/user/achievements.html",controller:"AchievementsCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/achievements/:userName",{templateUrl:"resources/templates/user/achievements.html",controller:"AchievementsCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/rules/",{templateUrl:"resources/templates/rules.html",controller:"RulesCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/game/:hash/",{templateUrl:"resources/templates/game.html",controller:"GameCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/",{templateUrl:"resources/templates/campaign.html",controller:"CampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/:campaignName/",{templateUrl:"resources/templates/campaign.html",controller:"CampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/:campaignName/:subCampaignId/",{templateUrl:"resources/templates/campaign.html",controller:"CampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/tetrisCampaign/",{templateUrl:"resources/templates/tetrisCampaign.html",controller:"tetrisCampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/stats/",{templateUrl:"resources/templates/user/stats.html",controller:"StatCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/stats/:userName/",{templateUrl:"resources/templates/user/stats.html",controller:"StatCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/account/",{templateUrl:"resources/templates/user/account.html",controller:"UserAccountCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/style/",{templateUrl:"resources/templates/user/style.html",controller:"UserConfigCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/machine/config/",{templateUrl:"resources/templates/user/config.html",controller:"ComputerConfigCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/about/",{templateUrl:"resources/templates/about.html",controller:"AboutCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/recovery/",{templateUrl:"resources/templates/user/passwordRecovery.html",controller:"PasswordRecoveryCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/newpassword/",{templateUrl:"resources/templates/user/newpassword.html",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/devices/",{templateUrl:"resources/templates/devices.html",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/",{templateUrl:"resources/templates/index.html",controller:"IndexCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}),b.html5Mode(!1),b.hashPrefix("!")}]),angularApp.run(["notify",function(a){"use strict";a.config({templateUrl:"resources/templates/notification.html",duration:5e3})}]); angular.module("angularApp.controllers").controller("IndexCtrl",["$scope","$modal","userAccount",function(a,b,c){"use strict";a.registered=null!==c.username,a.username=c.username,a.loginPopup=function(){b.open({animation:!0,templateUrl:"resources/templates/user/login.html",controller:"LoginFormCtrl",size:400})}}]); angular.module("angularApp.controllers").controller("AboutCtrl",["$scope","$anchorScroll","$location",function(a,b,c){"use strict";a.gotoAnchor=function(a){var d=a;c.hash()!==d?c.hash(a):b()}}]); angular.module("angularApp.factories").factory("achievements",["$rootScope","storage","TIC_PER_SEC","SEC_PER_MIN","userStats","notify",function(a,b,c,d,e,f){"use strict";function g(a){void 0===a&&(a=b);for(var c=a.get(b.Keys.Achievements)||[],d=c.length;d<h.List.enumSize;d+=1)c[d]=!1;return c}function h(){}return h.prototype.isWon=function(a,b){return g(b)[a]},h.prototype.check=function(c,d){for(var e=!1,i=g(),j=0;j<h.List.enumSize;j+=1)if(!i[j]&&(this.checkIndividual(j,c,d,i),i[j])){e=!0;var k=a.$new(!0);k.picture={src:"./resources/imgs/achievements/"+h.List.getName(j)+".png",alt:"Success !"},f({message:"New Success: "+h.List.getName(j),scope:k})}e&&b.set(b.Keys.Achievements,i)},h.prototype.keyToScore=function(a){switch(a){case h.List.Beginner:return 60;case h.List.Expert:return 160;case h.List.Master:return 300;case h.List.God:case h.List.XXS:case h.List.XXL:return 500;case h.List.Titan:case h.List.SuperTeam:case h.List.Cheater:return 1e3}throw"What are you doing here ?"},h.prototype.checkMultiLines=function(a,b){var c=0;switch(a){case h.List.Ambidextrous:c=0;break;case h.List.Psychic:c=1;break;case h.List.Sorcerer:c=2;break;default:throw"What are you doing here ?"}for(;c<b.multilines.length;c+=1)if(b.multilines[c])return!0;return!1},h.prototype.keyToMap=function(a){switch(a){case h.List.Nostalgic:return"campaign/tetrisAttack/1/ta_1_10";case h.List.RetroGamer:return"campaign/tetrisAttack/3/ta_3_10";case h.List.Dinosaur:return"campaign/tetrisAttack/6/ta_6_10";case h.List.Flash:return"campaign/timeLimit/timelimit_10";case h.List.Pacman:return"campaign/arcade/arcade_10";case h.List.Sherlock:return"campaign/puzzle/puzzle_10"}},h.prototype.checkIndividual=function(a,f,g,i){switch(a){case h.List.Beginner:case h.List.Expert:case h.List.Master:case h.List.God:case h.List.Titan:"classic"===g&&(i[a]=f.score>=this.keyToScore(a));break;case h.List.Cheater:"sandbox"===g&&(i[a]=f.score>=this.keyToScore(a));break;case h.List.XXL:"ultralarge"===g&&(i[a]=f.score>=this.keyToScore(a));break;case h.List.XXS:"small"===g&&(i[a]=f.score>=this.keyToScore(a));break;case h.List.SuperTeam:"ultralargecoop"===g&&(i[a]=f.score>=this.keyToScore(a));break;case h.List.Destroyer:i[a]=e.getTotalGameStats(g).blockDestroyed>=3e4;break;case h.List.Restless:i[a]=e.getTotalGameStats(g).swapCount>=2e4;break;case h.List.Veteran:i[a]=e.getTotalGameStats(g).gameCount>99;break;case h.List.Ambidextrous:case h.List.Psychic:case h.List.Sorcerer:i[a]=this.checkMultiLines(a,f);break;case h.List.Stubborn:i[a]=e.getTotalGameStats(g).time>c*d*30;break;case h.List.Tenacious:i[a]=e.getTotalGameStats(g).time>c*d*180;break;case h.List.BiggerIsBetter:for(var j=3;j<f.lineSizes.length;j+=1)if(f.lineSizes[j]){i[a]=!0;break}break;case h.List.Nostalgic:case h.List.RetroGamer:case h.List.Dinosaur:case h.List.Flash:case h.List.Pacman:case h.List.Sherlock:i[a]=b.get(b.MKeys.UserMap+this.keyToMap(a))}},h.List={Beginner:0,Expert:1,Master:2,God:3,Titan:4,Cheater:5,Ambidextrous:6,Psychic:7,Sorcerer:8,Stubborn:9,BiggerIsBetter:10,Nostalgic:11,RetroGamer:12,Dinosaur:13,Flash:14,Pacman:15,Sherlock:16,Tenacious:17,XXL:18,XXS:19,SuperTeam:20,Destroyer:21,Restless:22,Veteran:23,enumSize:24},h.List.Ordered=[h.List.Beginner,h.List.Expert,h.List.Master,h.List.God,h.List.Titan,h.List.XXL,h.List.XXS,h.List.Cheater,h.List.SuperTeam,h.List.Ambidextrous,h.List.Psychic,h.List.Sorcerer,h.List.BiggerIsBetter,h.List.Nostalgic,h.List.RetroGamer,h.List.Dinosaur,h.List.Flash,h.List.Pacman,h.List.Sherlock,h.List.Destroyer,h.List.Stubborn,h.List.Tenacious,h.List.Restless,h.List.Veteran],h.List.getName=function(a){for(var b in h.List)if(h.List[b]===a)return b;return""},h.List.getDescription=function(a){switch(a){case h.List.Beginner:return"Get 60 points in classic";case h.List.Expert:return"Get 160 points in classic";case h.List.Master:return"Get 300 points in classic";case h.List.God:return"Get 500 points in classic";case h.List.XXL:return"Get 500 points in wide";case h.List.XXS:return"Get 500 points in narrow";case h.List.SuperTeam:return"Get 1000 points in coop";case h.List.Titan:return"As good as the game master, the mighty Panda !";case h.List.Cheater:return"Get 1000 points in sandbox";case h.List.Ambidextrous:return"Get 2 series at once in any game mode";case h.List.Psychic:return"Get 3 series at once in any game mode";case h.List.Sorcerer:return"Get 4 series at once in any game mode";case h.List.Stubborn:return"Play for 30 minutes in any game mode";case h.List.Tenacious:return"Play for 3 hours in any game mode";case h.List.BiggerIsBetter:return"Create a line of 6 blocks in any game mode";case h.List.Nostalgic:return"Finish the first Tetris Attack campaign";case h.List.RetroGamer:return"Finish the third Tetris Attack campaign";case h.List.Dinosaur:return"Finish the last Tetris Attack campaign";case h.List.Flash:return"Finish the time attack campaign";case h.List.Pacman:return"Finish the tutorial campaign";case h.List.Sherlock:return"Finish the challenge campaign";case h.List.Destroyer:return"Destroy 30000 blocks in any game mode";case h.List.Restless:return"Swap 20000 pairs of blocks in any game mode";case h.List.Veteran:return"100 games in any game mode"}return""},h.prototype.List=h.List,new h}]); angular.module("angularApp.controllers").controller("AchievementsCtrl",["$window","$scope","$routeParams","api","achievements","storage","userAccount",function(a,b,c,d,e,f,g){"use strict";function h(){var a=0;b.achievementsGridData=[];for(var c=0;c<e.List.Ordered.length;c+=1)b.achievementsGridData.push({Picture:"./resources/imgs/achievements/"+e.List.getName(e.List.Ordered[c])+".png",Name:e.List.getName(e.List.Ordered[c]),Success:e.isWon(e.List.Ordered[c],i),Description:e.List.getDescription(e.List.Ordered[c])}),e.isWon(e.List.Ordered[c],i)&&(a+=1);b.percentComplete=a/e.List.enumSize*100,b.ieStyle={width:b.percentComplete+"%","min-width":"2em"}}b.redirect=function(){a.location.href="#!/stats/"+b.userName};var i=f;c.userName?d.loadExternalUser(c.userName).success(function(a){a.success?(i=i.createTemp(a.data),b.userName=a.name,h()):console.log(a.message)}).error(function(a){console.log("Failed to load data for user "+c.userid+" "+a)}):(h(),b.userName=g.username)}]); angular.module("angularApp.factories").factory("api",["$http",function(a){"use strict";function b(){}var c="http://whenwillyoulose.com:1337/wwylApi/";return b.prototype.addScore=function(b,d,e,f){for(var g=17*d+"_",h=0,i=0;i<g.length-1;i++)h+=+g.charAt(i);return g+=h,a.post(c+"scores",{score:g,user:b,map:e,duration:f})},b.prototype.getScores=function(b){return a.get(c+"scores/"+b)},b.prototype.resetPassword=function(b){return a.get(c+"user/reset/"+b)},b.prototype.getTheme=function(b){return a.get("resources/bootswatch/"+b+".min.css",{cache:!0})},b.prototype.updateUser=function(b,d,e,f,g,h){if(g||(g=null),0>b)throw"not registered";return a.put(c+"users/"+b+"/"+d,{data:e,name:f,password:g,email:h})},b.prototype.createUser=function(b,d){return a.post(c+"users",{userName:b,password:d})},b.prototype.loadUser=function(b,d){return a.post(c+"users/validate",{name:b,password:d})},b.prototype.loadUserId=function(b,d){return a.get(c+"users/"+b+"/"+d)},b.prototype.loadExternalUser=function(b){return a.get(c+"users/"+b)},new b}]); angular.module("angularApp.factories").factory("audio",["systemConfig",function(a){"use strict";function b(){d&&(this.audiochannels=[],this.ext=e,this.preload(),this.play=function(){})}var c=document.createElement("audio"),d="[object HTMLUnknownElement]"!==Object.prototype.toString.call(c),e="wav";d&&c.canPlayType("audio/mpeg;")&&(e="mp3"),b.prototype.preload=function(){if(a.get(a.Keys.sound)&&d){var c,e=[];for(var f in b.ESounds)b.ESounds.hasOwnProperty(f)&&(c=new Audio,c.src=b.ESounds[f].path+this.ext,c.oncanplaythrough=function(){console.log("audio loaded : "+this.src)},e.push(c));return e}},b.prototype.resetConfig=function(){this.play=f.playFactory(a.get(a.Keys.sound))},b.prototype.playFactory=function(a){return a&&d?function(a){for(var b=new Date,c=0;c<this.audiochannels.length;c+=1)if(this.audiochannels[c].endTime<b.getTime())return this.audiochannels[c].endTime=b.getTime()+a.duration,this.audiochannels[c].channel.src=a.path+this.ext,this.audiochannels[c].volume=.1,this.audiochannels[c].channel.load(),void this.audiochannels[c].channel.play();var d={endTime:-1,channel:new Audio};d.endTime=b.getTime()+a.duration,d.channel.src=a.path+this.ext,d.channel.volume=.1,d.channel.load(),d.channel.play(),this.audiochannels.push(d)}:function(){}},b.ESounds={swap:{path:"resources/audio/jump.",duration:1e3},score:{path:"resources/audio/pop.",duration:1e3},end:{path:"resources/audio/shotgun.",duration:2e3}},b.prototype.ESounds=b.ESounds;var f=new b;return f.resetConfig(),f}]); angular.module("angularApp.factories").factory("blockFactory",[function(){"use strict";function a(){this.reset=function(){this.type=a.EType.Random(),this.group=-1,this.state=a.EState.Blocked,this.verticalPosition=0,this.animationState=0,this.id=-1,this.threeObject=null,this.wasFalling=!1},this.reset()}a.prototype.clone=function(){var b=new a;return b.loadFrom(this),b},a.prototype.loadFrom=function(a){this.type=a.type,this.group=a.group,this.state=a.state,this.verticalPosition=a.verticalPosition,this.animationState=a.animationState,this.id=a.id,this.threeObject=a.threeObject,this.wasFalling=a.wasFalling},a.prototype.setState=function(a){this.state=a,this.animationState=0},a.EState={Blocked:1,Falling:2,Disappearing:3,SwappedLeft:4,SwappedRight:5},a.EType={Purple:0,Red:1,Green:2,Blue:3,Grey:4,Orange:5,PlaceHolder:6,Random:function(){return Math.floor(Math.random()*a.EType.PlaceHolder)}};var b=[];return{releaseBlock:function(a){a.reset(),b.push(a)},newBlock:function(){return 0==b.length?new a:b.pop()},cloneBlock:function(a){var b=this.newBlock();return b.loadFrom(a),b},EState:a.EState,EType:a.EType}}]); angular.module("angularApp.controllers").controller("CampaignCtrl",["$scope","$routeParams","$window","storage",function(a,b,c,d){"use strict";function e(){switch(a.maps=[],a.title="",a.campaign){case"challenges":for(a.title="Challenges",a.maps.push({name:CryptoJS.MD5("campaign/puzzle/puzzle_1"),active:!0}),f=2;11>f;f+=1)a.maps.push({name:CryptoJS.MD5("campaign/puzzle/puzzle_"+f),active:d.get("UserMapcampaign/puzzle/puzzle_"+(f-1))});break;case"timelimit":for(a.title="Time Limit",a.maps.push({name:CryptoJS.MD5("campaign/timeLimit/timelimit_1"),active:!0}),f=2;11>f;f+=1)a.maps.push({name:CryptoJS.MD5("campaign/timeLimit/timelimit_"+f),active:d.get("UserMapcampaign/timeLimit/timelimit_"+(f-1))});break;case"tetris":for(a.title="Tetris Attack - "+h,f=h,g=1,a.maps.push({name:CryptoJS.MD5("campaign/tetrisAttack/"+f+"/ta_"+f+"_"+g),active:1==f||d.get("UserMapcampaign/tetrisAttack/"+(f-1)+"/ta_"+(f-1)+"_10")}),g=2;11>g;g+=1)a.maps.push({name:CryptoJS.MD5("campaign/tetrisAttack/"+f+"/ta_"+f+"_"+g),active:d.get("UserMapcampaign/tetrisAttack/"+f+"/ta_"+f+"_"+(g-1))});break;default:for(a.title="Tutorial",a.maps.push({name:CryptoJS.MD5("campaign/arcade/arcade_1"),active:!0}),f=2;11>f;f+=1)a.maps.push({name:CryptoJS.MD5("campaign/arcade/arcade_"+f),active:d.get("UserMapcampaign/arcade/arcade_"+(f-1))})}}var f,g;a.startMap=function(a){c.location.href="#!/game/"+a},a.getClass=function(a,b){return b?"mapNode mapNodeActive_"+a:"mapNodeDisabled"},a.getTextClass=function(a,b){return b?"mapTextNode":"mapTextNodeDisabled"},a.campaign=b.campaignName||"tutorial";var h=b.subCampaignId||1;e()}]); angular.module("angularApp.controllers").controller("ComputerConfigCtrl",["$scope","systemConfig","audio",function(a,b,c){"use strict";a.keys=b.Keys,a.data={antialiasing:b.get(b.Keys.antialiasing),lowtexture:b.get(b.Keys.useLambertMaterial),lowRez:b.get(b.Keys.cssScaling),score:b.get(b.Keys.scores),sound:b.get(b.Keys.sound),explosion:b.get(b.Keys.explosions),fps:b.get(b.Keys.fps),zoom:b.get(b.Keys.zoom)},a.updateCheckBox=function(a,d){b.set(a,!d),a===b.Keys.sound&&c.resetConfig()}}]); angular.module("angularApp.base").constant("TIC_PER_SEC",60).constant("SEC_PER_MIN",60).constant("EGameActions",{swap:0,down:1,up:2,left:3,right:4,speed:5}),angular.module("angularApp.base").constant("map_hash",{f3d64714d1f6e7f71558d4252e84ab58:"classic","3ac54247ae527401610035b749cdbab6":"classicSplitScreen","93bc63e0b4f48fbbff568d9fc0dc3def":"sandbox",eb5c1399a871211c7e7ed732d15e3a8b:"small","38e0a50734a85ca916efedc8c4cd819d":"ultralarge","2add86b8e4cc3c18cecd3a6c5ad1208e":"ultralargecoop","78b492e07c9a2b6a3224f9de0cfe5b28":"campaign/timeLimit/timelimit_1","38b79c7ebcbd17a9e674ff880f88bbdb":"campaign/timeLimit/timelimit_10","6d3c0d9208fbafc6b33dbf3abba19284":"campaign/timeLimit/timelimit_2",c2b145c6633faab5814183199d0a6404:"campaign/timeLimit/timelimit_3","7cc06532e5ced726445c9c8b1d8d372f":"campaign/timeLimit/timelimit_4",c77ef72bc3c86d536ac159baf0236913:"campaign/timeLimit/timelimit_5","9650c3dd48f540961c33ad3e04654e79":"campaign/timeLimit/timelimit_6",a3b6f701dc6a487b2a92a9558c1617bb:"campaign/timeLimit/timelimit_7","8be886dc641752884f204f7ac0e159d9":"campaign/timeLimit/timelimit_8",d5d146f59734e7a929c5681109637af3:"campaign/timeLimit/timelimit_9","8e55c75c7d15ce306f716bdc894c5f58":"campaign/tetrisAttack/6/ta_6_1",bed3550cb8df5e0bf1b5d9423460148e:"campaign/tetrisAttack/6/ta_6_10","7bdc879c8891874cf602e2e2066aacdb":"campaign/tetrisAttack/6/ta_6_2","54d5dc20d87a4c6e98cabb2aa1747cb9":"campaign/tetrisAttack/6/ta_6_3","3a25ea10bf65ef43dc05bfffdc5ebb7d":"campaign/tetrisAttack/6/ta_6_4","2beee8ddc0cbe335545963e20ce02b78":"campaign/tetrisAttack/6/ta_6_5","129c89be922be02d993278d85ff79812":"campaign/tetrisAttack/6/ta_6_6","6d5af8bdce1b53faf99a8c5b0f3551c9":"campaign/tetrisAttack/6/ta_6_7",b43c447303d1200988e300209eb4bc93:"campaign/tetrisAttack/6/ta_6_8",c2f31eb57d42ee41e6e232639d87d00d:"campaign/tetrisAttack/6/ta_6_9","9dfdb85697930b7372a30611bb64dc57":"campaign/tetrisAttack/5/ta_5_1","0736d757eb48cf8957affe299d13648b":"campaign/tetrisAttack/5/ta_5_10","3a42c883fd263646b78cd142c691bdfc":"campaign/tetrisAttack/5/ta_5_2","394b85abe3ad1ab43755c920ddd79d11":"campaign/tetrisAttack/5/ta_5_3",af84d0dac1bcd10ab32d50525328eee5:"campaign/tetrisAttack/5/ta_5_4","97ee90ce501209a74525c36c2d85b1ec":"campaign/tetrisAttack/5/ta_5_5","5f79a4e33c0e1dc8b7cea53f50b1585f":"campaign/tetrisAttack/5/ta_5_6","6d98c092a62899a5f4d602438173f285":"campaign/tetrisAttack/5/ta_5_7",b5ad8d5c212b3da65b372e4f8dd95bd0:"campaign/tetrisAttack/5/ta_5_8",e31191acb39b955025c8dee1f11d3ba7:"campaign/tetrisAttack/5/ta_5_9",c94b9572ba4574c892cc39a673748e2b:"campaign/tetrisAttack/4/ta_4_1",fdd83e66c151241ca0486be1a706d005:"campaign/tetrisAttack/4/ta_4_10","0a2ca08b217c8df5df9f8f7398dd5a0f":"campaign/tetrisAttack/4/ta_4_2",dfa7147034cdfa6532275d5c5c025ea7:"campaign/tetrisAttack/4/ta_4_3","143eb12f3556f63f3fcf897448572885":"campaign/tetrisAttack/4/ta_4_4","2919abae61b027e9115e22117ef920f1":"campaign/tetrisAttack/4/ta_4_5",ea1db9b12ec7451ec59dfc7ba2b8655a:"campaign/tetrisAttack/4/ta_4_6","7d8ae77d235edf7d3fbc9c777d34edff":"campaign/tetrisAttack/4/ta_4_7",a830ce20f2c44f35c7efbc72422378c6:"campaign/tetrisAttack/4/ta_4_8",b87028628a45fbefffc1b94b69eadedd:"campaign/tetrisAttack/4/ta_4_9",af5426a81a7b0c5759d7bb4f345fef66:"campaign/tetrisAttack/3/ta_3_1","35ce0db306d24c6b5982435b6a579088":"campaign/tetrisAttack/3/ta_3_10","328ae6e4f93e64334638456a4cbd3a06":"campaign/tetrisAttack/3/ta_3_2",c39ad8c2fed1989378fd992832d5c1c5:"campaign/tetrisAttack/3/ta_3_3","2f664813c49bb8f3d3b837ffdcba90f1":"campaign/tetrisAttack/3/ta_3_4","429438aabe1686c76d3a2ffde5dfd9a4":"campaign/tetrisAttack/3/ta_3_5","589d6f396b4d1345755d3ffc0ca15f22":"campaign/tetrisAttack/3/ta_3_6","3a3c62f1d4bb4762c5f573acdaabc2b0":"campaign/tetrisAttack/3/ta_3_7",c847d520e5db0ccbe0d9be0922ab169f:"campaign/tetrisAttack/3/ta_3_8",ccb49e3158250c0da3b67f82e6b0a8da:"campaign/tetrisAttack/3/ta_3_9","1e12b4f7ffa17f3252901b70616e8905":"campaign/tetrisAttack/2/ta_2_1","420d72fd40ac1f4df1955d5189c3164b":"campaign/tetrisAttack/2/ta_2_10","31c0ef9e8354dac1274cca8bfa76b400":"campaign/tetrisAttack/2/ta_2_2","2025f73a997ea208a713649e6bac0a8d":"campaign/tetrisAttack/2/ta_2_3","145194ff03749bddc1656054e9848c82":"campaign/tetrisAttack/2/ta_2_4","4c82a7826e97543c22cfeab6a7deb593":"campaign/tetrisAttack/2/ta_2_5","82f87eaa3ff484f3d9ca35e4b9d13f3e":"campaign/tetrisAttack/2/ta_2_6",bcc8770ca51acbae4d1a10760f576aa7:"campaign/tetrisAttack/2/ta_2_7","4ac0c1077c320cb5bcd99d3180cc5f74":"campaign/tetrisAttack/2/ta_2_8","7b77b24b5f24a5462bf6c3e38bacbb59":"campaign/tetrisAttack/2/ta_2_9",bbc1b0f4e6044533af390fd4ed8686fb:"campaign/tetrisAttack/1/ta_1_1",e71c6d4f173ef6847f21c7de8971b9bb:"campaign/tetrisAttack/1/ta_1_10","349e57daad8e7a49adc9b180638bd44f":"campaign/tetrisAttack/1/ta_1_2","29275abde51d7a4d5d849411ba619e79":"campaign/tetrisAttack/1/ta_1_3","0bcc479eabe1fc77f0b175a137e02837":"campaign/tetrisAttack/1/ta_1_4","1a21dad13cafd1b724ccca2bb31b27a9":"campaign/tetrisAttack/1/ta_1_5",e1231bb1330ab48ee35dda100161a9e5:"campaign/tetrisAttack/1/ta_1_6",ad960e97f0f2370173b86b70575eca87:"campaign/tetrisAttack/1/ta_1_7",e93a1b76159aec2ed94c6ef75f465ce1:"campaign/tetrisAttack/1/ta_1_8","669e64124b28b6c748cf0173457135b5":"campaign/tetrisAttack/1/ta_1_9",ab6f418a2e0607cb488f7499981215d4:"campaign/puzzle/puzzle_1",cc5fbbd28a282761cc20f3f0b345ef51:"campaign/puzzle/puzzle_10","090c08f5bd14d49adc73ae947142bc79":"campaign/puzzle/puzzle_2",f98f59378760c53236be72914517a510:"campaign/puzzle/puzzle_3","9b15e6c59843c92810b1621831e117ee":"campaign/puzzle/puzzle_4",f5b6b9ff7859cdbed3a185b305ac43d9:"campaign/puzzle/puzzle_5",ee17a9619c7056eb88da4c506c177e76:"campaign/puzzle/puzzle_6",e6be5107ea1935870b8fbecc5d7a3a92:"campaign/puzzle/puzzle_7","7f923267fb3c0a87c6398f72d9642317":"campaign/puzzle/puzzle_8",a94b3157be95a56b46d34516e0e42777:"campaign/puzzle/puzzle_9",d2652ac1d0de107460e4d06e5e5e864d:"campaign/arcade/arcade_1",eacf1fc992485bbd48a934758c7a9ba6:"campaign/arcade/arcade_10","0be0c4c3d1ea6eccbbc537804802a6db":"campaign/arcade/arcade_2","0cfcfdaff103f2815bce39307d95ca6d":"campaign/arcade/arcade_3","5ae2d2faa749fe48a6e0e73ed704286e":"campaign/arcade/arcade_4","351f7c939eda4865c75ce31575e65888":"campaign/arcade/arcade_5","4267466af1df978832097565a13269b7":"campaign/arcade/arcade_6","7ab1925a5fbba6f350feef725ee01300":"campaign/arcade/arcade_7",d9d3e4aa93ee4a51ae92a83f52bf4603:"campaign/arcade/arcade_8",ef5854730828db3e8592dfe8785b0851:"campaign/arcade/arcade_9"}); angular.module("angularApp.factories").factory("cubeRenderElementFactory",["gameConstants","blockFactory","storage","systemConfig",function(a,b,c,d){"use strict";function e(){this.cube=null,this.textures={},this.colors=[],this.cache={0:[],1:[],2:[],3:[],4:[],5:[],6:[]},this.hexColors=c.get(c.Keys.HexKeyColors)||[128,20480,4210752,6295568,10239491,2628162]}function f(a){e.call(this)}function g(){e.call(this)}function h(a){e.call(this),this.divisions=a}function i(){e.call(this),this.cubes={}}function j(){e.call(this),this.cubes={}}return e.prototype.getHexColor=function(a){return this.hexColors[a]},e.prototype.getColor=function(a){return this.colors[a]||(this.colors[a]=new THREE.Color(this.getHexColor(a))),this.colors[a]},e.prototype.updateCubeDisplay=function(a){var c=a.threeObject;if(a.type!=c.customColor&&(c.material.color=this.getColor(a.type),c.customColor=a.type),a.state===b.EState.Disappearing){var d=1/(1+a.animationState*a.animationState*a.animationState/1e5);c.scale.set(d,d,d)}},e.prototype.createTexture=function(a){return this.textures[a]||(d.get(d.Keys.useLambertMaterial)?this.textures[a]=new THREE.MeshLambertMaterial({color:this.getHexColor(a),emissive:this.getHexColor(a)}):this.textures[a]=new THREE.MeshPhongMaterial({color:this.getHexColor(a),emissive:this.getHexColor(a)})),this.textures[a]},e.prototype.createGeometry=function(b){if(!this.cube){var c=.7*a.pixelPerBox;this.cube=new THREE.BoxGeometry(c,c,a.pixelPerBox/5),this.cube.center()}return this.cube},e.prototype.releaseCube=function(a){a.scale.set(1,1,1),this.cache[a.customColor].push(a)},e.prototype.createCube=function(a){if(this.cache[a].length>0)return this.cache[a].pop();var b=new THREE.Mesh(this.createGeometry(a),this.createTexture(a));return b.customObject=!0,b.customColor=a,b},f.prototype=new e,f.prototype.createGeometry=function(b){return this.cube||(this.cube=new THREE.CylinderGeometry(a.pixelPerBox/2,a.pixelPerBox/3,.8*a.pixelPerBox,16)),this.cube},g.prototype=new e,g.prototype.createGeometry=function(a){if(!this.cube){for(var b=[],c=0;50>c;c++)b.push(new THREE.Vector3(Math.sin(.2*c)*Math.sin(.1*c)*5.5+15,0,.7*(c-5)));this.cube=new THREE.LatheGeometry(b)}return this.cube.center(),this.cube},g.prototype.createCube=function(a){if(this.cache[a].length>0)return this.cache[a].pop();var b=e.prototype.createCube.call(this,a);return b.rotation.x=1.6,b},h.prototype=new e,h.prototype.createGeometry=function(b){if(!this.cube){var c=a.pixelPerBox*(0==this.divisions?.7:1);this.cube=new THREE.BoxGeometry(c,c,a.pixelPerBox/5);var d=new THREE.SubdivisionModifier(this.divisions);d.modify(this.cube)}return this.cube},i.prototype=new e,i.prototype.createGeometry=function(b){if(!this.cubes[b]){var c=a.pixelPerBox*(b%3?1:.7);this.cubes[b]=new THREE.BoxGeometry(c,c,a.pixelPerBox/5);var d=new THREE.SubdivisionModifier(b%3);d.modify(this.cubes[b])}return this.cubes[b]},j.prototype=new e,j.prototype.updateCubeDisplay=function(a){for(var b=a.threeObject.material.attributes,c=.005*Date.now(),d=0;d<b.size.value.length;d++)b.size.value[d]=17+17*Math.sin(.1*d+c);b.size.needsUpdate=!0},j.prototype.releaseCube=function(a){this.cache[a.customColor].push(a)},j.prototype.createCube=function(b){if(this.cache[b].length>0)return this.cache[b].pop();if(!this.cubes[b]){for(var c={size:{type:"f",value:[]},customColor:{type:"c",value:[]}},d=new THREE.ShaderMaterial({uniforms:{amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:THREE.ImageUtils.loadTexture("resources/imgs/spark.png")}},attributes:c,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0}),e=new THREE.Geometry,f=0;300>f;f++){var g=new THREE.Vector3;g.x=Math.random()-.5,g.y=Math.random()-.5,g.z=Math.random()-.5,g.multiplyScalar(.7*a.pixelPerBox),e.vertices.push(g)}this.cubes[b]=new THREE.PointCloud(e,d),this.cubes[b].attributes=c;for(var h=this.cubes[b].geometry.vertices,i=c.size.value,j=c.customColor.value,k=0;k<h.length;k+=1)i[k]=17,j[k]=this.getColor(b)}var l=this.cubes[b].clone();return l.customObject=!0,l.customColor=b,l},{createFactory:function(a){switch(a){case 0:return new e;case 1:case 2:case 3:case 4:return new h(a-1);case 5:return new i;case 6:return new j;case 7:return new f;case 8:return new g}return new e}}}]); angular.module("angularApp.controllers").controller("ModalInstanceCtrl",["$scope","$modalInstance","gameName","userStats","stateChecker","helpers","audio","TIC_PER_SEC",function(a,b,c,d,e,f,g,h){"use strict";a.isCampaign=c.indexOf("campaign")>-1,g.play(g.ESounds.end),a.won=e.victory(0),a.published=!1,a.nextGame=function(){b.close()},a.stop=function(){b.dismiss("cancel")},a.stats=function(){function a(a,b,c){return void 0===c&&(c=Math.floor),c(a/b)}var b=d.getBestGameStats(c),e=d.getTotalGameStats(c),g=d.getCurrentGame(),h=[];return h.push({name:"Score",value:g.score,best:b.score,sum:e.score,mean:a(e.score,e.gameCount)}),h.push({name:"Time",value:f.timeFromTics(g.time),best:f.timeFromTics(b.time),sum:f.timeFromTics(e.time),mean:a(e.time,e.gameCount,f.timeFromTics)}),h.push({name:"Blocks",value:g.blockDestroyed,best:b.blockDestroyed,sum:e.blockDestroyed,mean:a(e.blockDestroyed,e.gameCount)}),h.push({name:"Swaps",value:g.swapCount,best:b.swapCount,sum:e.swapCount,mean:a(e.swapCount,e.gameCount)}),h.push({name:"Apm",value:Math.floor(g.apm),best:Math.floor(b.apm),sum:"/",mean:Math.floor(e.apm)}),h.push({name:"Efficiency",value:g.efficiency.toFixed(2),best:b.efficiency.toFixed(2),sum:"/",mean:e.efficiency.toFixed(2)}),h}()}]); angular.module("angularApp.factories").factory("game",["userInput","userStats","stateChecker","threeRendererFactory","tetrisFactory","TIC_PER_SEC","storage","systemConfig",function(a,b,c,d,e,f,g,h){"use strict";function i(){this.scoreList=[[],[],[],[]],this.addTics=function(){for(var a=0;a<this.scoreList.length;a+=1)for(var b=0;b<this.scoreList[a].length;b+=1)this.scoreList[a][b].opacity-=.25},this.addScore=function(a,b){1>a||this.scoreList[b].push({opacity:100,value:a,object:null})}}function j(){if(h.get(h.Keys.fps)){var a=new Stats;return a.setMode(0),a.domElement.style.position="absolute",a.domElement.style.left="0px",a.domElement.style.top="0px",document.body.appendChild(a.domElement),a}return{begin:function(){},end:function(){}}}function k(){this.last={swaps:0,score:0,actions:0,combo:1,tics:0},this.availableGrids=[],this.gridCount=0,this.reset(),this.statCounter=j()}k.prototype.setConfiguration=function(a,b,d,e){this.config=a,this.grid=b,this.scope=e,this.gridCount=this.config.tetris.length,this.checkerId=[];for(var f=0;f<this.gridCount;++f)this.checkerId.push(c.create(a.victory));void 0===d?this.callback=null:this.callback=d,this.tryToStart()},k.prototype.reset=function(){window.cancelAnimationFrame(this.id),this.id=-1,this.started=!1,this.tetris=[],this.visual=[],this.tobefixed=[1,1],this.startTime=null,this.pause=!1,this.scoreHandler=new i,this.last={swaps:0,score:0,actions:0,combo:1,tics:0},this.progress=0,this.timeCounter=0},k.prototype.startNewGame=function(){function c(a,b){for(var c=0;c<a.length;c+=1)if(a[c].id==b)return a[c].node}this.reset(),this.started=!0,b.getCurrentGame().reset(),b.getCurrentGame().gameCount+=1;for(var f=0;f<this.gridCount;f+=1)this.tetris.push(e.newTetris(this.grid,this.config.tetris[f].cursors)),this.visual.push(d.newRenderer(this.config.tetris[f].cursors,g.get(g.Keys.CubeTheme),this.availableGrids[0].scaleX,this.availableGrids[0].scaleY)),this.visual[f].linkDom(c(this.availableGrids,f)),this.visual[f].renderTetris(this.tetris[f],[]);switch(this.tetris.length){case 2:this.tetris[0].playersId=[0,2],this.tetris[1].playersId=[1,3];break;case 4:this.tetris[0].playersId=[0],this.tetris[1].playersId=[1],this.tetris[2].playersId=[2],this.tetris[3].playersId=[3];break;case 1:default:this.tetris[0].playersId=[0,1,2,3]}a.clear(),this.renderingFct=this.render.bind(this),this.id=requestAnimationFrame(this.renderingFct)},k.prototype.stopGame=function(){this.started=!1,window.cancelAnimationFrame(this.id),this.gridCount=0;for(var a=0;a<this.checkerId.length;++a)c.free(this.checkerId[a]);this.checkerId=[]},k.prototype.tryToStart=function(){this.started||this.gridCount>this.availableGrids.length||0==this.gridCount||this.startNewGame()},k.prototype.linkToDom=function(a,b,c,d){this.availableGrids.push({id:b,node:a,scaleX:c,scaleY:d}),this.tryToStart()},k.prototype.unlinkToDom=function(a,b){this.started=!1;for(var c=0;c<this.availableGrids.length;c+=1)if(this.availableGrids[c].id===b){this.visual[b]&&(this.visual[b].clear(),this.visual[b]=null),this.availableGrids.splice(c,1);break}},k.prototype.splitScreenQuickFix=function(){if(2===this.tetris.length){for(;this.tobefixed[0]<this.tetris[1].getDestroyed()/3+this.tetris[1].getScore()/10;)this.tobefixed[0]+=2,this.tetris[0].randomFall();for(;this.tobefixed[1]<this.tetris[0].getDestroyed()/3+this.tetris[0].getScore()/10;)this.tobefixed[1]+=2,this.tetris[1].randomFall()}},k.prototype.togglePause=function(){return this.started?(this.pause=!this.pause,this.pause?window.cancelAnimationFrame(this.id):(this.id=requestAnimationFrame(this.renderingFct),this.startTime=null),a.clear(),this.pause):!1},k.prototype.computeTic=function(){for(var d,e=-1,f=0;f<this.tetris.length;f+=1)d=this.tetris[f].oneTick(),0==f&&b.getCurrentGame().addLines(d.series,d.score),c.check(this.checkerId[f],this.tetris[f]),(c.defeat(this.checkerId[f])||c.victory(this.checkerId[f]))&&(e=f),this.scoreHandler.addScore(d.score,f);return a.clear(),(0!=d.score||this.last.combo!=d.combo)&&(this.last.score+=d.score,this.last.combo=d.combo),-1!=e?(this.visual[e].freezeGame(),!1):!0};var l=1e3/f;return k.prototype.render=function(a){this.statCounter.begin(),null===this.startTime&&(this.startTime=a-this.last.tics*l),this.progress=a-this.startTime;for(var b=!0;this.timeCounter<=this.progress;)b=this.computeTic(),this.last.tics+=1,this.timeCounter+=l,this.scoreHandler.addTics();if(this.last.swaps=this.tetris[0].getSwaps(),this.last.actions=this.tetris[0].getActions(),this.scope.$broadcast("newTick",this.last),b){for(var d=0;d<this.tetris.length;d+=1)this.visual[d].renderTetris(this.tetris[d],this.scoreHandler.scoreList[d],c.getDangerLevel(this.checkerId[d]));this.splitScreenQuickFix(),this.statCounter.end(),this.id=requestAnimationFrame(this.renderingFct)}else null!==this.callback&&this.callback(this)},k.prototype.slide=function(a,b,c,d){1==this.tetris.length&&this.tetris[0].slide(a,b,c,d)},new k}]); angular.module("angularApp.factories").factory("gameConstants",["TIC_PER_SEC",function(a){"use strict";var b={};return b.reset=function(){this.columnCount=6,this.displayedRowCount=10,this.hiddenRowCount=3,this.pixelPerBox=50,this.swapPerTic=720/a,this.fallSpeedPerTic=480/a,this.disapearSpeedPerTic=180/a,this.groundSpeedPerTic=1.2/a,this.groundUpSpeedPerTic=180/a,this.groundAccelerationPerTic=.02/a/60,this.fallPeriod=3e4/a,this.gracePeriod=60*a,this.lostThreshold=(this.displayedRowCount+this.hiddenRowCount)*this.pixelPerBox,this.startRows=this.displayedRowCount-4},b.load=function(b){this.reset(),"sandbox"===b&&(this.groundSpeedPerTic=0,this.fallPeriod=0,this.startRows=this.displayedRowCount+this.hiddenRowCount,this.groundAccelerationPerTic=0),"sandboxSmall"===b?(this.groundSpeedPerTic=0,this.fallPeriod=0,this.columnCount=4,this.startRows=this.displayedRowCount+this.hiddenRowCount,this.groundAccelerationPerTic=0):"fixed"===b?(this.groundSpeedPerTic=0,this.fallPeriod=0,this.groundAccelerationPerTic=0,this.groundUpSpeedPerTic=0):"fixedLarge"===b?(this.groundSpeedPerTic=0,this.fallPeriod=0,this.groundAccelerationPerTic=0,this.groundUpSpeedPerTic=0,this.columnCount=10):"fixedNarrow"===b?(this.groundSpeedPerTic=0,this.fallPeriod=0,this.groundAccelerationPerTic=0,this.groundUpSpeedPerTic=0,this.columnCount=4):"large"===b?this.columnCount=10:"dual"===b?(this.gracePeriod=0,this.groundSpeedPerTic=4.2/a):"largeDual"===b?(this.gracePeriod=0,this.groundSpeedPerTic=4.2/a,this.columnCount=10):"small"===b&&(this.columnCount=4),"puzzle_8"===b?(this.fallPeriod=0,this.startRows=this.displayedRowCount+this.hiddenRowCount-1,this.groundAccelerationPerTic=0):"arcade_1"===b?(this.groundSpeedPerTic=0,this.fallPeriod=0,this.groundAccelerationPerTic=0):"arcade_2"===b?(this.groundSpeedPerTic=0,this.fallPeriod=18e3/a,this.gracePeriod=0,this.groundAccelerationPerTic=0):"arcade_3"===b?(this.groundSpeedPerTic=0,this.fallPeriod=18e3/a,this.groundAccelerationPerTic=0,this.gracePeriod=0,this.columnCount=10):"arcade_4"===b?(this.groundSpeedPerTic=4.2/a,this.groundSpeedPerTic*=1.5,this.gracePeriod=0,this.fallPeriod=12e3/a):"arcade_6"===b?(this.groundSpeedPerTic=4.2/a,this.groundSpeedPerTic*=1.5,this.gracePeriod=0,this.columnCount=10):"arcade_7"===b?(this.groundSpeedPerTic=4.2/a,this.fallPeriod=0,this.groundAccelerationPerTic=.01/a,this.gracePeriod=0):"arcade_8"===b?(this.groundSpeedPerTic=4.2/a,this.groundAccelerationPerTic=.01/a,this.gracePeriod=0):"arcade_9"===b?(this.groundSpeedPerTic=4.2/a,this.groundAccelerationPerTic=.01/a,this.gracePeriod=0,this.columnCount=10):"arcade_5"===b?(this.groundSpeedPerTic=4.2/a,this.columnCount=4,this.gracePeriod=0):"arcade_10"===b&&(this.groundSpeedPerTic=4.2/a,this.fallPeriod=9e3/a,this.groundAccelerationPerTic=0,this.gracePeriod=0,this.columnCount=10)},b}]); angular.module("angularApp.controllers").controller("GameCtrl",["$scope","$http","$route","$routeParams","$modal","$window","game","gameConstants","achievements","userStats","storage","stateChecker","userAccount","api","map_hash",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p=!1;a.gameName=o[d.hash]||d.hash||"classic";var q=a.gameName.indexOf("campaign")>-1;a.config={},a.config.splitScreen="classicSplitScreen"===a.gameName||"2v2"===a.gameName,a.gameConditions=null,a.pause={toggle:function(){p||(a.pause.active=g.togglePause())},active:!1},a.load=function(){b.get("resources/games/"+a.gameName+".json",{cache:!0}).success(function(b){a.config.gameConfig=b,a.useGameConfig(b)}).error(function(a){console.log(a)})},a.load(),angular.element(f).bind("blur",function(){return function(){a.pause.active=!0,g.pause||(a.pause.active=g.togglePause()),a.$apply()}}()),a.useGameConfig=function(c){h.load(c.rules),a.gameConditions=c.victory,a.$broadcast("newRulesSet",c.victory),""==c.grid?(g.setConfiguration(c,"",a.endCallBack,a),q&&a.openCampaignModal(c)):b.get("resources/grids/"+c.grid+".json",{cache:!0}).success(function(b){g.setConfiguration(c,b,a.endCallBack,a),q&&a.openCampaignModal(c)}).error(function(a){console.log(a)})},a.endCallBack=function(b){p=!0,1===b.tetris.length&&(l.victory(0)&&k.set(k.MKeys.UserMap+a.gameName,!0,!1),j.getCurrentGame().setTime(b.last.tics),j.getCurrentGame().setSwaps(b.tetris[0].getSwaps()),j.getCurrentGame().setActions(b.tetris[0].getActions()),j.addGame(j.getCurrentGame(),a.gameName),m.isRegistered()&&i.check(j.getCurrentGame(),a.gameName),m.isRegistered()&&!q&&n.addScore(m.id,j.getCurrentGame().score,a.gameName,j.getCurrentGame().time).success(function(a){console.log(a+a.message)}).error(function(a){console.log(a+a.message)}),a.openModal())},a.reset=function(){a.$broadcast("newGame",!0),p=!1,a.pause.active=!1,g.pause&&(a.pause.active=g.togglePause()),g.startNewGame()},a.openModal=function(){var b=e.open({animation:!0,templateUrl:"resources/templates/endGameModal.html",controller:"ModalInstanceCtrl",resolve:{gameName:function(){return a.gameName}}});b.result.then(function(){l.victory(0)&&a.config.gameConfig.next?("#"===a.config.gameConfig.next[0]&&(f.location.href=a.config.gameConfig.next),a.gameName=a.config.gameConfig.next,q=a.gameName.indexOf("campaign")>-1,c.updateParams({hash:CryptoJS.MD5(a.gameName)})):a.reset()},function(){})},a.openCampaignModal=function(b){a.pause.active=g.togglePause();var c=e.open({animation:!0,templateUrl:"resources/templates/objectivesModal.html",controller:"ObjectivesModalCtrl",size:300,resolve:{gameName:function(){return a.gameName},gameConfig:function(){return b}}});c.result.then(function(){a.pause.active=g.togglePause()},function(){a.pause.active=g.togglePause()})},a.$on("$destroy",function(){g.stopGame(),angular.element(f).unbind("blur")})}]); angular.module("angularApp.factories").factory("gamePadInput",["EGameActions",function(a){"use strict";function b(){return{0:!1,1:!1,4:!1,5:!1,6:!1,7:!1,12:!1,13:!1,14:!1,15:!1,axe:[[0,0],[0,0],[0,0],[0,0]]}}var c="GamepadEvent"in window;if(!c)return{clear:function(){},getActions:function(){}};var d=function(){this.actions=[{},{},{},{}];var c=this;this.gamePads={},this.checkGP=function(){function d(a){return"object"==typeof a?a.pressed:1==a}function e(a,b,e){var f=d(a.buttons[b]),g=c.gamePads[a.index];f!=g[b]&&(g[b]=f,g[b]&&c.press(a.index,e))}function f(a,b,d,e,f){-.5>=a&&b[0]>=7?(c.actions[f][d]=!0,b[0]=0):a>=.5&&b[1]>=7?(c.actions[f][e]=!0,b[1]=0):(b[0]+=1,b[1]+=1)}for(var g=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],h=0;h<g.length;++h){var i=g[h];if(i){c.gamePads[i.index]||(c.gamePads[i.index]=b()),e(i,0,a.swap),e(i,4,a.swap),e(i,5,a.swap),e(i,6,a.swap),e(i,7,a.swap),e(i,1,a.speed),e(i,12,a.up),e(i,14,a.left),e(i,15,a.right),e(i,13,a.down);for(var j=0;j<i.axes.length&&4>j;++j)f(i.axes[j],c.gamePads[i.index].axe[j],j%2?a.up:a.left,j%2?a.down:a.right,i.index)}}window.requestAnimationFrame(c.checkGP)},window.requestAnimationFrame(this.checkGP)};return d.prototype.clear=function(){this.actions=[{},{},{},{}]},d.prototype.press=function(a,b){this.actions[a][b]=!0},d.prototype.pressed=function(a,b){return this.actions[a][b]===!0},d.prototype.getActions=function(b,c){this.pressed(b,a.swap)&&c.push(a.swap),this.pressed(b,a.down)&&c.push(a.down),this.pressed(b,a.up)&&c.push(a.up),this.pressed(b,a.left)&&c.push(a.left),this.pressed(b,a.right)&&c.push(a.right),this.pressed(b,a.speed)&&c.push(a.speed)},new d}]); angular.module("angularApp.controllers").controller("GameStateCtrl",["$scope","TIC_PER_SEC","stateChecker",function(a,b,c){"use strict";var d=!0,e=0;a.state={rules:c.createRuleSet(a.$parent.$parent.gameConditions),score:0,time:0,apm:0,swaps:0,actions:0,combo:1},a.$on("newGame",function(){a.state.swaps=e,a.state.score=0,a.state.time=0,a.state.actions=0,a.state.apm=0,a.state.combo=1}),a.$on("newTick",function(c,f){if(f.tics>=a.state.time/6){a.state.score=f.score,d?a.state.swaps=f.swaps:a.state.swaps=e-f.swaps,a.state.actions=f.actions,a.state.combo=f.combo,a.state.time=f.tics;var g=Math.max(10*b,a.state.time);a.state.apm=Math.floor(a.state.actions*b*60/g),a.$digest()}}),a.$on("newRulesSet",function(b,f){d=!f||!f.swaps,d||(e=f.swaps,a.state.swaps=f.swaps),a.state.rules=c.createRuleSet(f)})}]); angular.module("angularApp.factories").factory("gameStatsFactory",["TIC_PER_SEC",function(a){"use strict";function b(){this.reset()}return b.prototype.reset=function(){this.score=0,this.time=0,this.blockDestroyed=0,this.multilines=[0,0,0,0,0,0,0,0,0],this.lineSizes=[0,0,0,0,0,0,0,0,0],this.gameCount=0,this.swapCount=0,this.actions=0,this.apm=0,this.efficiency=0},b.prototype.addLines=function(a,b){this.score+=b;var c=a.length-2;c>=this.multilines.length&&(c=this.multilines.length-1),this.multilines[c]+=1;for(var d=0;d<a.length;d+=1){var e=[];$.each(a[d],function(a,b){-1===$.inArray(b,e)&&e.push(b)});var f=e.length-3;f>=this.lineSizes.length&&(f=this.lineSizes.length-1),this.lineSizes[f]+=1,this.blockDestroyed+=e.length}},b.prototype.setTime=function(b){this.time=b,this.apm=this.actions/this.time*a*60},b.prototype.setSwaps=function(a){this.swapCount=a,this.efficiency=this.score/this.swapCount},b.prototype.setActions=function(b){this.actions=b,this.apm=this.actions/this.time*a*60},b.prototype.append=function(b){this.gameCount+=b.gameCount,this.score+=b.score,this.time+=b.time,this.blockDestroyed+=b.blockDestroyed,this.swapCount+=b.swapCount,this.actions+=b.actions;for(var c=0;c<this.multilines.length;c+=1)this.multilines[c]+=b.multilines[c];for(c=0;c<this.lineSizes.length;c+=1)this.lineSizes[c]+=b.lineSizes[c];this.apm=this.actions/this.time*a*60,this.efficiency=this.score/this.swapCount},b.prototype.keepBest=function(a){this.efficiency=this.efficiency>a.efficiency?this.efficiency:a.efficiency,this.apm=this.apm>a.apm?this.apm:a.apm,this.gameCount+=a.gameCount,this.score=this.score>a.score?this.score:a.score,this.time=this.time>a.time?this.time:a.time,this.blockDestroyed=this.blockDestroyed>a.blockDestroyed?this.blockDestroyed:a.blockDestroyed,this.swapCount=this.swapCount>a.swapCount?this.swapCount:a.swapCount;for(var b=0;b<this.multilines.length&&b<a.multilines.length;b+=1)this.multilines[b]=this.multilines[b]>a.multilines[b]?this.multilines[b]:a.multilines[b];for(b=0;b<this.lineSizes.length&&b<a.lineSizes.length;b+=1)this.lineSizes[b]=this.lineSizes[b]>a.lineSizes[b]?this.lineSizes[b]:a.lineSizes[b]},{newGameStats:function(){return new b},newGameStatsFrom:function(a){var c=new b;return c.keepBest(a),c}}}]); angular.module("angularApp.factories").factory("gridEvaluator",["gameConstants","blockFactory",function(a,b){"use strict";var c=function(){this.data=[],this.free=function(a){a.length=0,this.data.push(a)},this.get=function(){return 0==this.data.length?[]:this.data.pop()}},d=new c,e=function(){this.series=[],this.falling=0,this.lastTriger=0,this.combo=1};e.prototype.evaluateColumn=function(c,e){for(var f=0,g=null,h=-1,i=a.hiddenRowCount;i<c[e].length;i+=1)c[e][i].state!==b.EState.Blocked?(f=0,g=null):c[e][i].type!==g?(g=c[e][i].type,f=1):(f+=1,3===f?(c[e][i].setState(b.EState.Disappearing),c[e][i-1].setState(b.EState.Disappearing),c[e][i-2].setState(b.EState.Disappearing),this.series.push(d.get()),h=this.series.length-1,this.series[h].push(c[e][i].id),this.series[h].push(c[e][i-1].id),this.series[h].push(c[e][i-2].id),(c[e][i].wasFalling||c[e][i-1].wasFalling||c[e][i-2].wasFalling)&&(this.series[h].falling=!0)):f>3&&(c[e][i].setState(b.EState.Disappearing),this.series[h].push(c[e][i].id),c[e][i].wasFalling&&(this.series[h].falling=!0)))},e.prototype.evaluateVertical=function(b){for(var c=0;c<a.columnCount;c+=1)this.evaluateColumn(b,c)},e.prototype.findBlockIndex=function(b,c,d){for(var e=a.pixelPerBox*d,f=a.hiddenRowCount;f<b[c].length;f+=1)if(b[c][f].verticalPosition===e)return f;return-1},e.prototype.evaluateLine=function(c,e){var f,g,h,i=-1,j=-1,k=-1;h=0,g=null;var l=-1;for(f=0;f<a.columnCount;f+=1)if(k=j,j=i,i=this.findBlockIndex(c,f,e),-1!==i){var m=c[f][i];m.state===b.EState.Blocked||m.state===b.EState.Disappearing&&0===m.animationState?(m.type!==g&&(g=c[f][i].type,h=0),h+=1,3===h?(c[f][i].setState(b.EState.Disappearing),c[f-1][j].setState(b.EState.Disappearing),c[f-2][k].setState(b.EState.Disappearing),this.series.push(d.get()),l=this.series.length-1,this.series[l].push(c[f][i].id),this.series[l].push(c[f-1][j].id),this.series[l].push(c[f-2][k].id),(c[f][i].wasFalling||c[f-1][j].wasFalling||c[f-2][k].wasFalling)&&(this.series[l].falling=!0)):h>3&&(c[f][i].setState(b.EState.Disappearing),this.series[l].push(c[f][i].id),c[f][i].wasFalling&&(this.series[l].falling=!0))):h=0}else h=0},e.prototype.evaluateHorizontal=function(b){for(var c=a.hiddenRowCount;c<a.displayedRowCount+a.hiddenRowCount;c+=1)this.evaluateLine(b,c)},e.prototype.getScore=function(){for(var a=this.series.length,b=0,c=0;c<this.series.length;c+=1)b+=Math.pow(this.series[c].length-2,1.5)*(this.series[c].falling?1.5:1);return Math.ceil(b*(.5+Math.pow(a,1.5)/2))},e.prototype.getSerie=function(a,b){for(var c=0;b>c;c+=1)for(var d=0;d<this.series[c].length;d+=1)if(this.series[c][d]===a)return c;return-1};var f=function(a,b){d.free(a[b]);for(var c=a.length;c>b;)a[b]=a[b+1],b++;a.length--};return e.prototype.mergeSeries=function(){for(var a=this.series.length-1;a>=0;a-=1)for(var b=0;b<this.series[a].length;b+=1){var c=this.getSerie(this.series[a][b],a);if(-1!==c){var d=this.series[c].falling||this.series[a].falling;this.series[c]=this.series[c].concat(this.series[a]),this.series[c].falling=d,f(this.series,a);break}}},e.prototype.evaluate=function(a){for(this.lastTriger-=1,this.lastTriger<=0&&(this.combo=1);this.series.length;)d.free(this.series.pop());this.evaluateVertical(a),this.evaluateHorizontal(a),this.mergeSeries();var b=this.getScore(),c=b;return b*=this.combo,c>=this.combo&&(this.lastTriger=120,this.combo+=1),{score:b,combo:this.combo,series:this.series}},new e}]); angular.module("angularApp.factories").factory("gridFactory",["gameConstants","blockFactory","gridEvaluator",function(a,b,c){"use strict";function d(c){var d,e,f=0!==a.groundUpSpeedPerTic||0!==a.groundSpeedPerTic;for(this.container=new Array(a.columnCount),d=0;d<a.columnCount;d+=1)for(this.container[d]=new Array(a.hiddenRowCount),e=0;e<this.container[d].length;e+=1)this.container[d][e]=b.newBlock(),this.container[d][e].verticalPosition=e*a.pixelPerBox,f||(this.container[d][e].type=b.EType.PlaceHolder,this.container[d][e].state=b.EState.Blocked);if(c)this.load(c);else{var g=-1;for(d=0;d<a.columnCount;d+=1)for(e=this.container[d].length;e<a.startRows;e+=1){for(this.container[d].push(b.newBlock());e%2==0&&g===this.container[d][e].type||d%2==1&&this.container[d-1][e].type==this.container[d][e].type;)this.container[d][e].type=b.EType.Random();g=this.container[d][e].type,this.container[d][e].verticalPosition=e*a.pixelPerBox}}}var e=function(a,b){for(var c=a.length;c>b;)a[b]=a[b+1],b++;a.length-=1};d.prototype.addNewLine=function(){var c,d;for(c=0;c<a.columnCount;c+=1){for(d=0;d<this.container[c].length;d+=1)this.container[c][d].verticalPosition+=a.pixelPerBox;this.container[c].unshift(b.newBlock())}},d.prototype.removeBlockFixed=function(a,c){b.releaseBlock(this.container[a][c]),e(this.container[a],c),this.makeTopBlockFall(a,c)},d.prototype.insertBlock=function(a,b){for(var c=0;c<this.container[b].length;c+=1)if(this.container[b][c].verticalPosition>a.verticalPosition)return void this.container[b].splice(c,0,a);this.container[b].push(a)},d.prototype.findBlock=function(a,b){var c=this.findBlockIndex(a,b);return-1===c?null:this.container[a][c]},d.prototype.findBlockIndex=function(b,c){var d;for(d in this.container[b])if(this.container[b].hasOwnProperty(d)&&this.container[b][d].verticalPosition===a.pixelPerBox*c)return parseInt(d);return-1},d.prototype.isBlockIndexFree=function(b,c){var d;for(d in this.container[b])if(this.container[b].hasOwnProperty(d)&&this.container[b][d].verticalPosition>=a.pixelPerBox*c&&this.container[b][d].verticalPosition<a.pixelPerBox*(c+1))return!1;return!0},d.prototype.makeTopBlockFall=function(a,c){if(0>c)throw"Not my day";for(var d=c;d<this.container[a].length&&this.container[a][d].state===b.EState.Blocked;d+=1)this.container[a][d].setState(b.EState.Falling)},d.prototype.animateBlockFall=function(c,d,e,f){return e.verticalPosition-=a.fallSpeedPerTic,e.verticalPosition<f&&(e.verticalPosition=f,this.container[c][d-1].state!==b.EState.Falling&&(e.setState(b.EState.Blocked),e.wasFalling=!0)),{min:e.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateBlockDisappear=function(b,c,d,e){return d.animationState+=a.disapearSpeedPerTic,d.animationState>100&&-1===d.id?(this.removeBlockFixed(b,c),{min:e,deltaY:-1}):{min:d.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateSwapped=function(c,d,e,f){if(e.animationState+=a.swapPerTic,e.animationState>100){if(e.type===b.EType.PlaceHolder)return this.removeBlockFixed(c,d),{min:f,deltaY:-1};this.container[c][d-1].state===b.EState.Falling||this.container[c][d-1].verticalPosition<e.verticalPosition-a.pixelPerBox?(e.setState(b.EState.Falling),this.makeTopBlockFall(c,d+1)):e.setState(b.EState.Blocked)}return{min:e.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateBlock=function(c,d,e){var f=this.container[c][d];switch(f.wasFalling=!1,f.state){case b.EState.Blocked:return{min:f.verticalPosition+a.pixelPerBox,deltaY:0};case b.EState.Disappearing:return this.animateBlockDisappear(c,d,f,e);case b.EState.Falling:return this.animateBlockFall(c,d,f,e);case b.EState.SwappedRight:case b.EState.SwappedLeft:return this.animateSwapped(c,d,f,e)}throw"Unsupported animation "+f.state},d.prototype.animateColumn=function(b){var c,d,e;for(d=a.hiddenRowCount*a.pixelPerBox,c=a.hiddenRowCount-1;c<this.container[b].length;c+=1)e=this.animateBlock(b,c,d),d=e.min,c+=e.deltaY},d.prototype.animate=function(){for(var b=0;b<a.columnCount;b+=1)this.animateColumn(b)},d.prototype.getMaxFixed=function(){var c,d,e=0;for(c=0;c<a.columnCount;c+=1)for(d=a.hiddenRowCount;d<this.container[c].length&&this.container[c][d].state===b.EState.Blocked;d+=1)this.container[c][d].verticalPosition>e&&(e=this.container[c][d].verticalPosition);return e},d.prototype.newBlockFall=function(c){var d=b.newBlock();d.setState(b.EState.Falling),d.verticalPosition=(a.hiddenRowCount+a.displayedRowCount+1)*a.pixelPerBox,this.container[c].push(d)},d.prototype.swap=function(a,c){var d=this.findBlock(a,c),e=this.findBlock(a+1,c);if(null!==d&&null!==e){if(d.state===b.EState.Blocked&&e.state===b.EState.Blocked&&(d.type!==b.EType.PlaceHolder||e.type!=b.EType.PlaceHolder))return this.swapBlocks(d,e),!0}else{if(null!==d&&this.isBlockIndexFree(a+1,c)&&d.state===b.EState.Blocked){var f=b.newBlock();return f.type=b.EType.PlaceHolder,f.state=b.EState.SwappedLeft,f.verticalPosition=d.verticalPosition,this.insertBlock(f,a+1),this.swapBlocks(d,f),!0}if(null!==e&&this.isBlockIndexFree(a,c)&&e.state===b.EState.Blocked){var g=b.newBlock();return g.type=b.EType.PlaceHolder,g.state=b.EState.SwappedRight,g.verticalPosition=e.verticalPosition,this.insertBlock(g,a),this.swapBlocks(g,e),!0}}return!1};var f=b.newBlock();return d.prototype.swapBlocks=function(a,c){f.loadFrom(a),a.loadFrom(c),c.loadFrom(f),a.setState(b.EState.SwappedLeft),c.setState(b.EState.SwappedRight)},d.prototype.load=function(c){var d,e;for(d=0;d<c.grid.length;d+=1)for(e=0;e<c.grid[d].length;e+=1){var f=b.newBlock();f.state=c.grid[d][e].state,f.type=c.grid[d][e].type,f.verticalPosition=this.container[d].length*a.pixelPerBox,this.container[d].push(f)}},d.prototype.evaluate=function(){return c.evaluate(this.container)},d.prototype.blockCount=function(){for(var b=0,c=0;c<this.container.length;c+=1)b+=this.container[c].length-a.hiddenRowCount;return b},d.prototype.contains=function(b){for(var c=0,d=0;d<this.container.length;d+=1)for(var e=a.hiddenRowCount;e<this.container[d].length;e+=1)this.container[d][e].type===b&&(c+=1);return c},{newGrid:function(a){return new d(a)}}}]); angular.module("angularApp.controllers").controller("HeaderCtrl",["$scope","$location",function(a,b){"use strict";a.isActive=function(a){return a===b.path()}}]); angular.module("angularApp.factories").factory("helpers",["TIC_PER_SEC","SEC_PER_MIN",function(a,b){"use strict";function c(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d+=1){var e=c[d].split("=");if(e[0]===a)return e[1]}return""}function d(c){if(isNaN(c))return"";var d=Math.floor(c/a),e=Math.floor(d/b),f=d%b,g=Math.floor(c%a/(a/10));return(10>e?"0"+e:e)+":"+(10>f?"0"+f:f)+"."+g}return{timeFromTics:d,getQueryVariable:c}}]); angular.module("angularApp.factories").factory("KeyboardInput",["EGameActions",function(a){"use strict";var b=function(){this.keyCodes={};var a=this;this.onKeyDown=function(b){a.onKeyChange(b)},document.addEventListener("keydown",this.onKeyDown,!1)};return b.prototype.destroy=function(){document.removeEventListener("keydown",this.onKeyDown,!1)},b.ALIAS={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9,enter:13},b.prototype.clear=function(){this.keyCodes={}},b.prototype.onKeyChange=function(a){var c=a.keyCode;this.keyCodes[c]=!0,(c===b.ALIAS.space||c>=b.ALIAS.left&&c<=b.ALIAS.down)&&a.preventDefault()},b.prototype.press=function(a){this.keyCodes[a]=!0},b.prototype.pressed=function(a){return this.keyCodes[a]===!0},b.prototype.getActions=function(b,c){this.pressed(b.swap)&&c.push(a.swap),this.pressed(b.down)&&c.push(a.down),this.pressed(b.up)&&c.push(a.up),this.pressed(b.left)&&c.push(a.left),this.pressed(b.right)&&c.push(a.right),this.pressed(b.speed)&&c.push(a.speed)},b.prototype.leftMapping={swap:32,down:83,up:90,left:81,right:68,speed:65},b.prototype.rightMapping={swap:96,down:b.ALIAS.down,up:b.ALIAS.up,left:b.ALIAS.left,right:b.ALIAS.right,speed:b.ALIAS.enter},new b}]); angular.module("angularApp.controllers").controller("LoginFormCtrl",["$scope","$modalInstance","userAccount",function(a,b,c){"use strict";a.submitEnabled=!0,a.messageLogin="",a.messageRegister="",a.user={login:"",password:""},a.register={login:"",password:""},a.login=function(){a.signForm.$valid&&(a.submitEnabled=!1,c.logIn(a.user.login,a.user.password,function(c,d){c?b.close():(a.submitEnabled=!0,a.messageLogin=d?d:"Login failed : check your password !")}))},a.register=function(){a.registerForm.$valid&&(a.submitEnabled=!1,c.createUser(a.register.login,a.register.password,function(c,d){c?b.close():(a.submitEnabled=!0,a.messageRegister=d?d:"Can't create user.")}))},a.close=function(){b.close()}}]); angular.module("angularApp.directives").directive("mngCompareTo",function(){"use strict";return{require:"ngModel",scope:{otherModelValue:"=mngCompareTo"},link:function(a,b,c,d){d.$validators.mngCompareTo=function(b){return b===a.otherModelValue},a.$watch("otherModelValue",function(){d.$validate()})}}}); angular.module("angularApp.directives").directive("mngTetrisGame",["$swipe","game","KeyboardInput",function(a,b,c){"use strict";return{restrict:"A",link:function(d,e,f){if(!Detector.webgl)return void Detector.addGetWebGLMessage(document.getElementById("game"));var g,h,i,j,k=1,l=-1,m=function(){var a=(new Date).getTime();300>a-l&&c.press(13),l=a};e.bind("click",m),document.documentElement.clientWidth<448&&(k=document.documentElement.clientWidth/448),document.documentElement.clientHeight<600&&document.documentElement.clientHeight/600<k&&(k=document.documentElement.clientHeight/600),a.bind(e,{start:function(a){var b=e[0].getBoundingClientRect();g=a.x-b.left,h=a.y-b.top},end:function(a){var c=e[0].getBoundingClientRect();i=a.x-c.left,j=a.y-c.top,Math.abs(g-i)/k>30&&b.slide(g/k,600-h/k,i/k,600-j/k)}}),b.linkToDom(e[0],f.mngTetrisGame,k,k),d.$on("$destroy",function(){b.unlinkToDom(e[0],f.mngTetrisGame)}),d.test=function(a){console.log(a)}}}}]); angular.module("angularApp.directives").directive("ngEnter",["$document",function(a){"use strict";return{scope:{ngEnter:"&"},link:function(b,c,d){var e=function(c){13===c.which&&(b.ngEnter(),a.unbind("keydown keypress",e))};a.bind("keydown keypress",e)}}}]); angular.module("angularApp.directives").directive("ngCx",function(){return function(a,b,c){c.$observe("ngCx",function(a){b.attr("cx",a)})}}).directive("ngDx",function(){return function(a,b,c){c.$observe("ngDx",function(a){b.attr("dx",a)})}}).directive("ngCy",function(){return function(a,b,c){c.$observe("ngCy",function(a){b.attr("cy",a)})}}).directive("ngTransform",function(){return function(a,b,c){c.$observe("ngTransform",function(a){b.attr("transform",a)})}}); angular.module("angularApp.controllers").controller("ObjectivesModalCtrl",["$scope","$modalInstance","stateChecker","gameName","gameConfig",function(a,b,c,d,e){"use strict";function f(){var a=d.split("/");return a=a[a.length-1],a=a.replace("_"," "),a=a.replace("_"," "),a=a.replace("ta","Tetris Attack - "),a=a[0].toUpperCase()+a.slice(1)+"/10"}a["continue"]=function(){b.close()},a.rules=c.createRuleSet(e.victory),a.tips=e.tooltip,a.title=f()}]); angular.module("angularApp.controllers").controller("PasswordRecoveryCtrl",["$scope","userAccount",function(a,b){"use strict";a.name="",a.resetPassword=function(){a.updateForm.$valid&&(a.submitEnabled=!1,b.resetPassword(a.name,function(b){a.submitEnabled=!0,a.message=b}))}}]); angular.module("angularApp.controllers").controller("RulesCtrl",["$scope","$anchorScroll","$location",function(a,b,c){"use strict";a.gotoAnchor=function(a){var d=a;c.hash()!==d?c.hash(a):b()}}]); angular.module("angularApp.factories").factory("scoreRenderElementFactory",["systemConfig",function(a){"use strict";function b(a){this.matGen=a,this.caches={},this.create=function(a){if(!this.caches[a]||!this.caches[a].length){var b=new THREE.TextGeometry(a,{size:30,height:2,curveSegments:2,font:"helvetiker"});return new THREE.Mesh(b,this.matGen.get())}return this.caches[a].material=this.matGen.get(),this.caches[a].pop()},this.release=function(a,b){this.caches[b]||(this.caches[b]=[]),a.scale.set(1),this.caches[b].push(a)}}function c(){this.cache=[];for(var a=0;20>a;++a)this.cache.push(new THREE.MeshBasicMaterial({color:16777215*Math.random()}));this.get=function(){return this.cache[Math.floor(20*Math.random())]}}function d(a){this.value=0,this.mesh=null,this.particles=null,this.factory=a}function e(){this.sparkTexture=THREE.ImageUtils.loadTexture("resources/imgs/spark.png"),this.matGen=new c,this.txtCache=new b(this.matGen),this.create=function(){return new d(this)},this.free=function(a){a.mesh&&(this.txtCache.release(a.mesh,a.value),a.mesh=null)},this.clearCache=function(){this.matGen=new c,this.txtCache=new b(this.matGen),this.sparkTexture=THREE.ImageUtils.loadTexture("resources/imgs/spark.png")}}return d.prototype.updateAttributes=function(a,b){},d.prototype.updateVert=function(a){for(var b=0;b<a.length;b+=1)a[b].multiplyScalar(1.02)},d.prototype.animate=function(a){var b=a/100;if(this.mesh){var c=1/(1+Math.pow(100-a,2)/1e4);this.mesh.scale.set(c,c,c)}if(this.particles){b*=.7*12;var d=this.particles.material.attributes.size;this.updateAttributes(d,b);var e=this.particles.geometry.vertices;this.updateVert(e),this.particles.geometry.verticesNeedUpdate=!0,d.needsUpdate=!0}},d.prototype.createScore=function(a){this.value=a,this.createText(a),this.createParticles(a)},d.prototype.createText=function(b){if(a.get(a.Keys.scores)){var c=Math.floor(12*Math.random()),d=260+85*(Math.floor(c/2)%6)-80*Math.random(),e=(c%2?-225:175)-50*Math.random(),f=this.factory.txtCache.create(b);f.position.setX(e),f.position.setY(d),f.position.setZ(-5),this.mesh=f}},d.prototype.createParticles=function(b){if(a.get(a.Keys.explosions)){for(var c=16777215*Math.random(),d=220+80*Math.random(),e=-250+500*Math.random(),f={size:{type:"f",value:[]},customColor:{type:"c",value:[]}},g=new THREE.ShaderMaterial({uniforms:{amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:this.factory.sparkTexture}},attributes:f,vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:!0,transparent:!0}),h=new THREE.Geometry,i=0;100+30*b>i;i++){var j=new THREE.Vector3;j.x=2*Math.random()-1,j.y=2*Math.random()-1,j.x*j.x+j.y*j.y>1||(j.multiplyScalar(70),j.z=-50,h.vertices.push(j))}this.particles=new THREE.PointCloud(h,g),this.particles.position.setX(e),this.particles.position.setY(d),this.particles.attributes=f;for(var k=f.size.value,l=f.customColor.value,m=new THREE.Color(c),n=this.particles.geometry.vertices,o=0;o<n.length;o+=1)k[o]=8,l[o]=m}},{createFactory:function(){return new e}}}]); angular.module("angularApp.controllers").controller("ScoresCtrl",["$scope","$http","$timeout","userAccount","api",function(a,b,c,d,e){"use strict";function f(){a.scoreGridData=i.slice((a.pagination.current-1)*h,a.pagination.current*h)}function g(){if(a.pagination.current=1,i.length<=h)a.pagination.pages=[1],a.pagination.last=1;else{var b=Math.ceil(i.length/h);a.pagination.pages=[];for(var c=0;b>c;c++)a.pagination.pages.push(c+1);a.pagination.last=b}f()}var h=15;a.pagination={current:1,pages:[1],last:1,paginate:function(a){this.current=a,f()}},a.activate=function(b){a.type=b,a.getScores(b)},a.isActive=function(b){return b===a.type},a.currentName=d.username,a.isUser=function(b){return b===a.currentName};var i;a.userScores=[],a.getScores=function(b){e.getScores(b).success(function(b){a.userScores=[];for(var c=0;c<b.length;c++)b[c].position=c+1,b[c].name===a.currentName&&a.userScores.push(b[c]);i=b,g()}).error(function(a){console.log(a)})},a.scoreTypes=[{type:"classic",name:"Classic"},{type:"small",name:"Narrow"},{type:"ultralarge",name:"Wide"},{type:"sandbox",name:"Sandbox"}],a.activate("classic")}]); angular.module("angularApp.factories").factory("stateChecker",["gameConstants","TIC_PER_SEC",function(a,b){"use strict";function c(){}function d(){this.level=0}function e(a){this.val=a}function f(a){this.val=a}function g(a){this.val=a}function h(a){this.val=a}function i(a){this.val=a}function j(a){this.val=a,this.danger=0}return c.prototype.reset=function(a){this.defeatComponents=[],this.succesComponents=[],this.makeComponents(a),this.defeatComponents.push(new d),this.lastSuccessCheck=!1,this.lastDefeatCheck=!1,this.lastDangerLevel=0},c.prototype.defeat=function(){return this.lastDefeatCheck},c.prototype.victory=function(){return this.lastSuccessCheck},c.prototype.getDangerLevel=function(){return this.lastDangerLevel},c.prototype.check=function(a){this.lastSuccessCheck=0!==this.succesComponents.length,this.lastDefeatCheck=!1,this.lastDangerLevel=0;for(var b=0;b<this.succesComponents.length;b+=1)this.lastSuccessCheck=this.succesComponents[b].check(a)&&this.lastSuccessCheck;for(b=0;b<this.defeatComponents.length;b+=1)this.lastDefeatCheck=this.defeatComponents[b].check(a)||this.lastDefeatCheck,this.lastDangerLevel=Math.max(this.lastDangerLevel,this.defeatComponents[b].getDangerLevel())},c.prototype.makeComponents=function(a){a&&(void 0!==a.blocksLeft&&this.succesComponents.push(new f(a.blocksLeft)),void 0!==a.score&&this.succesComponents.push(new e(a.score)),void 0!==a.destroy&&this.succesComponents.push(new g(a.destroy)),void 0!==a.swaps&&this.defeatComponents.push(new i(a.swaps)),void 0!==a.time&&this.defeatComponents.push(new j(a.time)),void 0!==a.keep&&this.defeatComponents.push(new h(a.keep)))},d.prototype.check=function(c){return c.getMaxFixed()>=a.lostThreshold?this.level+=1:this.level-=(a.lostThreshold-c.getMaxFixed())/b,this.level<0&&(this.level=0),this.level>=3*b},d.prototype.getDangerLevel=function(){return this.level/(3*b)*10},e.prototype.check=function(a){return a.getScore()>=this.val},e.prototype.getDangerLevel=function(){return 0},f.prototype.check=function(a){return a.grid.blockCount()<=this.val},f.prototype.getDangerLevel=function(){return 0},g.prototype.check=function(a){return a.grid.contains(1)<=this.val},g.prototype.getDangerLevel=function(){return 0},h.prototype.check=function(a){return a.grid.contains(3)<this.val},h.prototype.getDangerLevel=function(){return 0},i.prototype.check=function(a){return a.getSwaps()>this.val},i.prototype.getDangerLevel=function(){return 0},j.prototype.check=function(a){return this.danger=this.val-a.tics/b,a.tics/b>this.val},j.prototype.getDangerLevel=function(){return this.danger<10?10-this.danger:0},{checkers:[],create:function(a){for(var b=0;b<this.checkers.length;++b)if(!this.checkers[b].used)return this.checkers[b].used=!0,this.checkers[b].check.reset(a),b;return this.checkers.push({check:new c,used:!0}),this.checkers[this.checkers.length-1].check.reset(a),this.checkers.length-1},free:function(a){this.checkers[a].used=!1},defeat:function(a){return this.checkers[a].check.defeat()},victory:function(a){return this.checkers[a].check.victory()},getDangerLevel:function(a){return this.checkers[a].check.getDangerLevel()},check:function(a,b){return this.checkers[a].check.check(b)},createRuleSet:function(a){var b=[];return a?(void 0!==a.destroy&&b.push({success:!0,message:"Destroy all the green blocks"}),void 0!==a.keep&&b.push({success:!1,message:"Don't destroy any red block before your last swap"}),void 0!==a.blocksLeft&&(0===a.blocksLeft?b.push({success:!0,message:"Destroy each block"}):b.push({success:!0,message:"Reduce the blocks to "+a.blocksLeft})),void 0!==a.score&&b.push({success:!0,message:"Get "+a.score+" points"}),void 0!==a.swaps&&b.push({success:!1,message:"Max "+a.swaps+(a.swaps>1?" swaps":" swap")}),void 0!==a.time&&b.push({success:!1,message:"Max "+a.time+" seconds"}),b):(b.push({success:!0,message:"Try to stay alive !"}),b)}}}]); angular.module("angularApp.controllers").controller("StatCtrl",["$window","$scope","$routeParams","userStats","gameStatsFactory","storage","api","userAccount",function(a,b,c,d,e,f,g,h){"use strict";function i(){b.isPositive=function(a){return a>0},b.isActive=function(a){return a===b.data.active},b.activate=function(a){b.data.active=a};var a=function(a){return a.best=d.getBestGameStats(a.link,j),a.sum=d.getTotalGameStats(a.link,j),a},c=function(){var a,c={name:"Overall",link:""};for(c.best=e.newGameStats(),c.sum=e.newGameStats(),a=0;a<b.data.maps.length;a+=1)c.best.keepBest(b.data.maps[a].best),c.sum.append(b.data.maps[a].sum);return c};b.data={active:"Classic"},b.data.maps=[],b.data.maps.push(a({name:"Classic",link:"classic"})),b.data.maps.push(a({name:"Narrow",link:"small"})),b.data.maps.push(a({name:"Wide",link:"ultralarge"})),b.data.maps.push(a({name:"SandBox",link:"sandbox"})),b.data.maps.push(a({name:"Coop",link:"ultralargecoop"})),b.data.maps.push(c())}b.redirect=function(){a.location.href="#!/achievements/"+b.userName};var j=f;c.userName?g.loadExternalUser(c.userName).success(function(a){a.success?(j=j.createTemp(a.data),b.userName=a.name,i()):console.log(a.message)}).error(function(a){console.log("Failed to load data for user "+c.userid+" "+a)}):(i(),b.userName=h.username)}]); angular.module("angularApp.factories").factory("storage",["api",function(a){"use strict";function b(){this.storage={},this.inSave=!1,this.waitingToSave=!1,this.eventHandler=[],this.id=-1,this.hash=null,this.realStorage}return b.prototype.createTemp=function(a){var c=new b;return c.storage=JSON.parse(a),c},b.prototype.impersonate=function(a){this.realStorage=this.storage,this.storage=JSON.parse(a)},b.prototype.restore=function(){this.storage=this.realStorage},b.prototype.load=function(a,b,c){a=JSON.parse(a),a?this.storage=a:this.storage={},this.id=b,this.hash=c},b.prototype.unload=function(){this.storage={},this.id=-1,this.hash=null},b.prototype.get=function(a){var b=this.storage[a];return b},b.prototype.set=function(a,b,c){void 0===c&&(c=!0),this.storage[a]=b,c&&this.flush()},b.prototype.flush=function(){-1!==this.id&&this.save()},b.prototype.save=function(){if(this.inSave)this.waitingToSave=!0;else{this.waitingToSave=!1,this.inSave=!0;var b=this;a.updateUser(this.id,this.hash,JSON.stringify(this.storage)).success(function(a){b.inSave=!1,b.waitingToSave&&b.save()}).error(function(a){console.log(a),b.inSave=!1,b.waitingToSave&&b.save()})}},b.prototype.Keys={CubeTheme:"CubeTheme",WebTheme:"WebTheme",Achievements:"Achievements",HexKeyColors:"HexKeyColors"},b.prototype.MKeys={UserMap:"UserMap",BestGameStats:"BestGameStats",TotalGameStats:"TotalGameStats"},new b}]); angular.module("angularApp.factories").factory("systemConfig",["storage",function(a){"use strict";function b(){var a=null!=c.any();this.isMobile=a}var c={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return c.Android()||c.BlackBerry()||c.iOS()||c.Opera()||c.Windows()}};return b.prototype.set=function(a,b){void 0==b&&(b=null),localStorage.setItem("systemConfig_"+a,JSON.stringify(b))},b.prototype.get=function(a){var b=localStorage.getItem("systemConfig_"+a);if(null!=b)try{b=JSON.parse(b)}catch(c){console.log(c),b=null}return null!=b?b:this.isMobile?this.defaultMobile(a):this.defaultDesktop(a)},b.prototype.defaultDesktop=function(a){switch(a){case this.Keys.antialiasing:return!0;case this.Keys.useLambertMaterial:return!1;case this.Keys.sound:return!0;case this.Keys.scores:return!0;case this.Keys.explosions:return!0;case this.Keys.zoom:return!1;case this.Keys.cssScaling:return!1;case this.Keys.fps:return!1}throw"what key is that"},b.prototype.defaultMobile=function(a){switch(a){case this.Keys.antialiasing:return!1;case this.Keys.useLambertMaterial:return!0;case this.Keys.sound:return!1;case this.Keys.scores:return!1;case this.Keys.explosions:return!1;case this.Keys.zoom:return!0;case this.Keys.cssScaling:return!0;case this.Keys.fps:return!1}throw"what key is that"},b.prototype.Keys={antialiasing:0,useLambertMaterial:1,sound:2,scores:3,explosions:4,zoom:5,cssScaling:6,fps:7},new b}]); angular.module("angularApp.controllers").controller("tetrisCampaignCtrl",["$scope","$routeParams","$window","storage",function(a,b,c,d){"use strict";function e(){a.campaigns=[{link:"1",active:!0}];for(var b=2;7>b;b+=1)a.campaigns.push({link:b,active:d.get("UserMapcampaign/tetrisAttack/"+(b-1)+"/ta_"+(b-1)+"_10")})}a.startCampaign=function(a){c.location.href="#!/campaign/tetris/"+a},e()}]); angular.module("angularApp.factories").factory("tetrisFactory",["gameConstants","userInput","gridFactory","systemConfig","audio","EGameActions",function(a,b,c,d,e,f){"use strict";function g(b,e){this.zoom=d.get(d.Keys.zoom)&&a.columnCount<8,this.grid=c.newGrid(b),this.score=0,this.blockDestroyed=0,this.cursor=[],void 0===e&&(e=1);for(var f=0;e>f;f+=1)this.cursor.push({x:2+2*f,y:a.hiddenRowCount+a.displayedRowCount/2});this.counters={swap:0,move:0,speed:0},this.groundSpeed=a.groundSpeedPerTic,this.baseGroundSpeed=a.groundSpeedPerTic,this.groundPos=0,this.playersId=[],this.tics=0}function h(a,b){return Math.floor(Math.random()*(b-a+1))+a}return g.prototype.slide=function(b,c,d,e){function f(b){return h.zoom?(b-=45,b/=60,b-=(6-a.columnCount)/2):(b-=10,b/=43,b-=(10-a.columnCount)/2),Math.floor(b)}function g(b){return h.zoom?(b-=6,b-=h.groundPos/a.pixelPerBox*55,b/=55):(b-=95,b-=h.groundPos/a.pixelPerBox*43,b/=43),b+=a.hiddenRowCount,Math.floor(b)}var h=this,i=f(b),j=g(c);b>d&&(i-=1),0>i||j<a.hiddenRowCount-1||i>=a.columnCount-1||this.swap(i,j)},g.prototype.oneTick=function(){for(var b=this.grid.evaluate(),c=0;c<b.series.length;c+=1)this.blockDestroyed+=b.series.length;if(this.score+=b.score,b.score>0&&e.play(e.ESounds.score),this.handleUserInput(),this.tics+=1,0!==a.fallPeriod&&this.tics%a.fallPeriod===0&&a.gracePeriod<this.tics&&this.randomFall(),this.grid.animate(),this.groundPos+=this.groundSpeed,this.groundSpeed+=a.groundAccelerationPerTic,this.baseGroundSpeed+=a.groundAccelerationPerTic,this.groundPos>=a.pixelPerBox){this.groundPos-=a.pixelPerBox,this.grid.addNewLine();for(var c=0;c<this.cursor.length;c+=1)this.cursor[c].y+=1;this.groundSpeed=this.baseGroundSpeed}return b},g.prototype.getMaxFixed=function(){return this.grid.getMaxFixed()},g.prototype.isMoving=function(){return this.grid.isMoving()},g.prototype.getScore=function(){return this.score},g.prototype.getDestroyed=function(){return this.blockDestroyed},g.prototype.getSwaps=function(){return this.counters.swap},g.prototype.getActions=function(){return this.counters.swap+this.counters.move+this.counters.speed},g.prototype.randomFall=function(){for(var b=3,c=h(0,a.columnCount-b),d=c;c+b>d;d+=1)this.grid.newBlockFall(d)},g.prototype.swap=function(a,b){var c=this.grid.swap(a,b);return c&&(this.counters.swap+=1,e.play(e.ESounds.swap)),c},g.prototype.handleUserInput=function(){for(var c,d=0;d<this.playersId.length;d+=1){var e=this.cursor[d%this.cursor.length],g=e.x,h=e.y;c=b.getActions(this.playersId[d]);for(var i=0;i<c.length;i+=1)switch(c[i]){case f.swap:this.swap(e.x,e.y);break;case f.down:e.y=Math.max(a.hiddenRowCount-1,e.y-1);break;case f.up:e.y=Math.min(a.hiddenRowCount+a.displayedRowCount,e.y+1);break;case f.left:e.x=Math.max(0,e.x-1);break;case f.right:e.x=Math.min(a.columnCount-2,e.x+1);break;case f.speed:this.groundSpeed!=a.groundUpSpeedPerTic&&(this.counters.speed+=1,this.groundSpeed=a.groundUpSpeedPerTic)}(h!=e.y||e.x!=g)&&(this.counters.move+=1)}},{newTetris:function(a,b){return new g(a,b)}}}]); angular.module("angularApp.factories").factory("threeRendererFactory",["gameConstants","blockFactory","cubeRenderElementFactory","scoreRenderElementFactory","systemConfig",function(a,b,c,d,e){"use strict";function f(b,f,g,h){this.scale={x:+g,y:+h},this.mode=+f,this.zoom=e.get(e.Keys.zoom)&&a.columnCount<8,void 0===b&&(b=1),this.camera=this.createCamera(),this.cursor=[this.createCursor(32896)];for(var i=1;b>i;i+=1)this.cursor.push(this.createCursor(8388736));this.offset=0,this.id=String.fromCharCode(65+Math.floor(26*Math.random()))+Date.now(),this.type=f,this.cubeFactory=c.createFactory(this.type),this.scoreFactory=d.createFactory(),this.displayCursor=!e.isMobile,this.scene=this.createScene()}function g(c,d){return c.state===b.EState.SwappedLeft?d+a.pixelPerBox/100*(100-c.animationState):c.state===b.EState.SwappedRight?d-a.pixelPerBox/100*(100-c.animationState):d}function h(a){var c=0;return a.state===b.EState.SwappedLeft||a.state===b.EState.SwappedRight?(c=a.animationState<51?2500-(50-a.animationState)*(50-a.animationState):2500-(a.animationState-50)*(a.animationState-50),c/=80,a.state===b.EState.SwappedRight&&(c=-c)):a.state===b.EState.Disappearing&&(c=-a.animationState),c}return f.prototype.clear=function(){this.renderer.clear();for(var a=this.scene.children.length-1;a>=0;a-=1)if(this.scene.children[a].customObject){var b=this.scene.children[a];this.scene.remove(b),this.cubeFactory.releaseCube(b)}this.cubeFactory=c.createFactory(this.type),this.scoreFactory=d.createFactory(),this.scene=null,this.camera=null,this.renderer=null},f.prototype.createScene=function(){var b=new THREE.Scene,c=new THREE.PointLight(16777215,.5);c.position.set(0,100,800),b.add(c);var d=new THREE.PointLight(16777215,.5);if(d.position.set(600,-100,800),b.add(d),this.displayCursor)for(var e=0;e<this.cursor.length;e+=1)b.add(this.cursor[e]);var f=new THREE.BoxGeometry(1e3,3,3),g=new THREE.MeshPhongMaterial({color:3342336,emissive:10027008}),h=new THREE.Mesh(f,g);return h.position.set(0,(a.hiddenRowCount+a.displayedRowCount)*a.pixelPerBox-27,10),b.add(h),f=new THREE.BoxGeometry(1e3,3,3),g=new THREE.MeshPhongMaterial({color:13056,emissive:39168}),h=new THREE.Mesh(f,g),h.position.set(0,a.hiddenRowCount*a.pixelPerBox-a.pixelPerBox/2+5,10),b.add(h),b},f.prototype.createCamera=function(){var a=new THREE.PerspectiveCamera(this.zoom?62:75,this.zoom?448/650:448/600,.3,1e3);return a.position.z=450,a.position.x=-27,a.position.y=this.zoom?390:360,a},f.prototype.createRenderer=function(a){var b=new THREE.WebGLRenderer({canvas:a,antialias:e.get(e.Keys.antialiasing)});return b.setClearColor(0),e.get(e.Keys.cssScaling)?(b.setSize(448*this.scale.x/2,600*this.scale.y/2),$(a).addClass("scaledCanvas"),$(a).closest(".gameResizer").css("width",448*this.scale.x),$(a).closest(".gameResizer").css("height",600*this.scale.y)):b.setSize(448*this.scale.x,600*this.scale.y),b},f.prototype.updateCube=function(a,b){-1===b.id&&(b.threeObject=this.cubeFactory.createCube(b.type),this.scene.add(b.threeObject),b.id=b.threeObject.id);var c=b.threeObject;c.position.setY(b.verticalPosition+this.offset),c.position.setX(g(b,a)),c.position.setZ(h(b)),this.cubeFactory.updateCubeDisplay(b),b.animationState>100&&(this.scene.remove(c),this.cubeFactory.releaseCube(c),b.id=-1,b.threeObject=null)},f.prototype.render=function(){this.renderer.render(this.scene,this.camera)},f.prototype.linkDom=function(a){a.scrollIntoView(!0),this.renderer=this.createRenderer(a)},f.prototype.unlinkDom=function(){this.renderer=null},f.prototype.createCursor=function(a){var b=new THREE.Shape;return b.absarc(72,-13,10,-Math.PI/2,0,!0),b.lineTo(82,0),b.absarc(72,13,10,0,Math.PI/2,!0),b.lineTo(35,20),b.lineTo(35,0),b.absarc(-2,-13,10,3*Math.PI/2,Math.PI,!0),b.lineTo(-12,0),b.absarc(-2,13,10,Math.PI,Math.PI/2,!0),b.lineTo(35,-20),new THREE.PointCloud(b.createPointsGeometry(),new THREE.PointCloudMaterial({color:a,size:4}))},f.prototype.drawCursorOn=function(b,c,d){void 0===d&&(d=0),this.cursor[d].position.set((b-a.columnCount/2)*a.pixelPerBox-10,c*(a.pixelPerBox-.5)+this.offset+5,7)},f.prototype.freezeGame=function(){this.renderer.setClearColor(new THREE.Color(0,0,0),1);for(var a=0;a<this.cursor.length;a+=1)this.scene.remove(this.cursor[a]);this.camera.position.z+=100,this.zoom?this.camera.position.y+=60:this.camera.position.y+=100,this.render()},f.prototype.renderTetris=function(c,d,e){this.renderer.setClearColor(new THREE.Color(e/50,0,0),1),this.offset=c.groundPos;for(var f,g=0;g<a.columnCount;g+=1)for(var h=0;h<c.grid.container[g].length;h+=1)f=c.grid.container[g][h],f.type!==b.EType.PlaceHolder&&this.updateCube((g-a.columnCount/2)*a.pixelPerBox,f);if(a.columnCount<=6&&!this.zoom)for(g=0;g<d.length;g+=1)d[g].threeObject||(d[g].threeObject=this.scoreFactory.create(),d[g].threeObject.createScore(d[g].value),d[g].threeObject.mesh&&this.scene.add(d[g].threeObject.mesh),d[g].threeObject.particles&&this.scene.add(d[g].threeObject.particles)),d[g].opacity<=0?(d[g].threeObject.mesh&&this.scene.remove(d[g].threeObject.mesh),d[g].threeObject.particles&&this.scene.remove(d[g].threeObject.particles),this.scoreFactory.free(d[g].threeObject),d.splice(g,1),g-=1):d[g].threeObject.animate(d[g].opacity);for(g=0;g<c.cursor.length;g+=1)this.drawCursorOn(c.cursor[g].x,c.cursor[g].y,g);this.render()},{newRenderer:function(a,b,c,d){return new f(a,b||0,c||1,d||1)}}}]); angular.module("angularApp.factories").factory("userAccount",["$q","$rootScope","$route","$window","$timeout","storage","api",function(a,b,c,d,e,f,g){"use strict";function h(){this.eventHandler=[],this.username=null,this.id=-1,this.hash=null,this.started=!1,this.email=null}return h.prototype.start=function(){var b=this;return a(function(a,c){return b.started?void a(b.username):localStorage.getItem("Usr_LastUserId")&&localStorage.getItem("Usr_hash")?void g.loadUserId(localStorage.getItem("Usr_LastUserId"),localStorage.getItem("Usr_hash")).success(function(c){c.success?(b.started=!0,b.username=c.name,b.email=c.email,b.id=c.id,b.hash=c.hash,f.load(c.data,b.id,b.hash),b.loadTheme(),b.broadcast(),a(b.username)):(localStorage.removeItem("Usr_hash"),localStorage.removeItem("Usr_LastUserId"),a(null))}).error(function(b){localStorage.removeItem("Usr_hash"),localStorage.removeItem("Usr_LastUserId"),a(null)}):void a(null)})},h.prototype.registerToEvent=function(a,b){this.eventHandler.push({objet:a,callback:b})},h.prototype.createUser=function(a,b,c){var d=this;g.createUser(a,b).success(function(e){e.success?(d.username=a,d.logIn(a,b,c)):(console.log(e.message),c(!1))}).error(function(a){a&&console.log(a+a.message),c(!1,"An error occurred while contacting our server, please retry later.")})},h.prototype.resetPassword=function(a,b){g.resetPassword(a).success(function(a){a.success?b("An email as been sent to your account, it may go in your spam."):(b(a.message),console.log(a))}).error(function(a){a&&console.log(a+a.message),b("An error occurred while contacting our server, please retry later.")})},h.prototype.updateUser=function(a,b,c,d){var e=this;g.updateUser(this.id,this.hash,null,a,b,c).success(function(c){c.success?(e.username=a,e.id=c.id,e.hash=c.hash,e.logIn(a,b,d),e.email=c.email):(d(!1),console.log(c.error))})},h.prototype.broadcast=function(){for(var a=0;a<this.eventHandler.length;a+=1)this.eventHandler[a].callback.apply(this.eventHandler[a].objet,[this.username])},h.prototype.logout=function(){localStorage.removeItem("Usr_hash"),localStorage.removeItem("Usr_LastUserId"),this.login=null,f.unload(),this.broadcast(),d.location.href="#!/",d.location.reload()},h.prototype.isRegistered=function(){return null!==this.username},h.prototype.loadTheme=function(){var a=f.get(f.Keys.WebTheme)||"cyborg";a=a.toLowerCase();var b=localStorage.getItem("dynamic_css_name");b!=a&&g.getTheme(a).success(function(b){localStorage.setItem("dynamic_css_name",a),localStorage.setItem("dynamic_css_content",b),document.getElementById("switchableTheme").innerHTML=b;var c=document.getElementById("switchableThemeCss");c&&c.parentNode.removeChild(c)}).error(function(a){console.log("can't load theme "+a)})},h.prototype.setTheme=function(a){f.set(f.Keys.WebTheme,a.toLowerCase()),this.loadTheme()},h.prototype.logIn=function(a,b,d){var e=this;g.loadUser(a,b).success(function(b){b.success?(localStorage.setItem("Usr_LastUserId",b.id),localStorage.setItem("Usr_hash",b.hash),e.username=a,e.id=b.id,e.hash=b.hash,f.load(b.data,e.id,e.hash),e.broadcast(),e.loadTheme(),c.reload(),d(!0,b.message)):(console.log(b.message),d(!1))}).error(function(a){a&&console.log(a+a.message),d(!1,"An error occurred while contacting our server, please retry later.")})},new h}]); angular.module("angularApp.controllers").controller("UserAccountCtrl",["$scope","userAccount",function(a,b){"use strict";a.user={name:b.username,email:b.email},a.updateRegistration=function(){a.updateForm.$valid&&(a.submitEnabled=!1,b.updateUser(a.user.name,a.user.password,a.user.email,function(c){c?(a.user.name=b.username,a.user.email=b.email,a.submitEnabled=!0):(a.submitEnabled=!0,a.message="Can't update user.")}))}}]); angular.module("angularApp.controllers").controller("UserConfigCtrl",["$scope","$http","$timeout","userAccount","storage","achievements",function(a,b,c,d,e,f){"use strict";a.cubeType=e.get(e.Keys.CubeTheme)||0,a.selectedCss=e.get(e.Keys.WebTheme)||"Slate",a.themes=[{Picture:"./resources/imgs/themes/plain.png",Name:"Plain cubes",Require:-1},{Picture:"./resources/imgs/themes/fancy.png",Name:"Fancy cubes",Require:f.List.Beginner},{Picture:"resources/imgs/themes/mines.png",Name:"Mines",Require:f.List.Nostalgic},{Picture:"resources/imgs/themes/candy.png",Name:"Candy",Require:f.List.RetroGamer},{Picture:"resources/imgs/themes/candyhd.png",Name:"Candy HD",Require:f.List.Sherlock},{Picture:"resources/imgs/themes/smash.png",Name:"Smash bros",Require:f.List.Flash},{Picture:"resources/imgs/themes/light.png",Name:"Lights",Require:f.List.Pacman},{Picture:"resources/imgs/themes/thirsty.png",Name:"Thirsty",Require:f.List.BiggerIsBetter},{Picture:"resources/imgs/themes/cup.png",Name:"Cup",Require:f.List.God}],a.requireStatus=function(a){return-1===a?!0:f.isWon(a)},a.updateStyle=function(b){a.requireStatus(a.themes[b].Require)&&(a.cubeType=b,e.set(e.Keys.CubeTheme,a.cubeType))};var g=["Cerulean","Cosmo","Cyborg","Darkly","Flatly","Journal","Lumen","Paper","Readable","Sandstone","Simplex","Slate","Spacelab","Superhero","United","Yeti"];a.cssThemes=[a.selectedCss];for(var h=0;h<g.length;h+=1)g[h]!=a.cssThemes[0]&&a.cssThemes.push(g[h]);a.requireText=function(b){return a.requireStatus(b)?"":"Unlocked by success : "+f.List.getName(b)},a.loadStyle=function(a){d.setTheme(a)},c(function(){$('[data-toggle="tooltip"]').tooltip()},0);var i=[128,20480,4210752,6295568,10239491,2628162];a.resetColors=function(a){for(var b=a||e.get(e.Keys.HexKeyColors)||i,c=0;6>c;++c)$("#picker_"+c).spectrum({color:"#"+("000000"+b[c].toString(16)).slice(-6),flat:!1,showInput:!1,showAlpha:!1,showButtons:!1})},a.saveColors=function(){for(var b=[],c=0;6>c;++c)b.push(parseInt($("#picker_"+c).spectrum("get").toHex(),16));e.set(e.Keys.HexKeyColors,b),a.resetColors()},a.defaultColors=function(){a.resetColors(i),a.saveColors()},a.resetColors(null)}]); angular.module("angularApp.factories").factory("userInput",["KeyboardInput","gamePadInput",function(a,b){"use strict";function c(){}return c.prototype.clear=function(){a.clear(),b.clear()},c.prototype.getActions=function(c){var d=[];switch(c){case 0:a.getActions(a.leftMapping,d),b.getActions(2,d);break;case 1:a.getActions(a.rightMapping,d),b.getActions(3,d);break;case 2:b.getActions(0,d);break;case 3:b.getActions(1,d)}return d},new c}]); angular.module("angularApp.controllers").controller("UserMenuCtrl",["$scope","$modal","$timeout","userAccount",function(a,b,c,d){"use strict";a.registered=null!==d.username,a.userName=d.username,a.resetState=function(b){c(function(){a.registered=null!==b,a.userName=b},0)},a.loginPopup=function(){b.open({animation:!0,templateUrl:"resources/templates/user/login.html",controller:"LoginFormCtrl",size:400})},a.logout=function(){d.logout()},d.registerToEvent(a,a.resetState)}]); angular.module("angularApp.factories").factory("userStats",["storage","gameStatsFactory",function(a,b){"use strict";function c(){this.currentGame=b.newGameStats()}return c.prototype.getCurrentGame=function(){return this.currentGame},c.prototype.addGame=function(b,c){var d=c.indexOf("campaign")>-1,e=this.getBestGameStats(c);if(e.keepBest(b),a.set(a.MKeys.BestGameStats+c,e,!1),!d){var f=this.getTotalGameStats(c);f.append(b),a.set(a.MKeys.TotalGameStats+c,f,!1)}a.flush()},c.prototype.getBestGameStats=function(c,d){void 0===d&&(d=a);var e=d.get(a.MKeys.BestGameStats+c);return e?b.newGameStatsFrom(e):b.newGameStats()},c.prototype.getTotalGameStats=function(c,d){void 0===d&&(d=a);var e=d.get(a.MKeys.TotalGameStats+c);return e?b.newGameStatsFrom(e):b.newGameStats()},new c}]);