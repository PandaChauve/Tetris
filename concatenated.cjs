angular.module("angularApp.controllers",["ui.bootstrap"]);var angularApp=angular.module("angularApp",["ngRoute","angularApp.controllers"]);angularApp.config(["$compileProvider",function(a){a.debugInfoEnabled(!1)}]);angularApp.controller("HeaderCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]);angularApp.filter("ticToTime",function(){return TimeFromTics});
angularApp.directive("ngEnter",function(a){return{scope:{ngEnter:"&"},link:function(b,e,f){var c=function(d){13===d.which&&(b.ngEnter(),a.unbind("keydown keypress",c))};a.bind("keydown keypress",c)}}});
angularApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/scores",{templateUrl:"templates/scores.html",controller:"ScoresCtrl"}).when("/achievements",{templateUrl:"templates/achievements.html",controller:"AchievementsCtrl"}).when("/rules",{templateUrl:"templates/rules.html"}).when("/game",{templateUrl:"templates/game.html",controller:"GameCtrl"}).when("/campaign",{templateUrl:"templates/campaign.html",controller:"CampaignCtrl"}).when("/stats",{templateUrl:"templates/stats.html",
controller:"StatCtrl"}).when("/",{templateUrl:"templates/scores.html",controller:"ScoresCtrl"});b.html5Mode(!1);b.hashPrefix("!")}]);
var campaignControllers=angular.module("angularApp.controllers");
campaignControllers.controller("CampaignCtrl",["$scope","$routeParams",function(b,d){var a,c;b.campaign=d.name||"arcade";b.maps=[];switch(b.campaign){case "puzzle":for(a=1;3>a;a+=1)b.maps.push("campaign/puzzle/puzzle_"+a);break;case "timelimit":for(a=1;3>a;a+=1)b.maps.push("campaign/timeLimit/timelimit_"+a);break;case "tetris":for(a=1;7>a;a+=1)for(c=1;11>c;c+=1)b.maps.push("campaign/tetrisAttack/"+a+"/ta_"+a+"_"+c);break;default:for(a=1;4>a;a+=1)b.maps.push("campaign/arcade/arcade_"+a)}}]);
var gameControllers=angular.module("angularApp.controllers");
gameControllers.controller("GameCtrl",["$scope","$http","$route","$routeParams","$modal","$window",function(a,f,h,g,k,c){a.gameName=g.name||"classic";a.confi={};a.game=null;a.confi.splitScreen="classicSplitScreen"===a.gameName;a.load=function(){f.get("games/"+a.gameName+".json",{cache:!1}).success(function(b){a.useGameConfig(b)}).error(function(a){console.log(a)})};a.load();a.pause={toggle:function(){a.pause.active=a.game.TogglePause()},active:!1};a.$on("$routeChangeStart",function(){a.game&&(a.game.Stop(),
a.game=null)});a.reset=function(){a.game.Stop();a.game=new Game(a.game.config,a.game.grid,a.endCallBack);a.game.Start()};angular.element(c).bind("blur",function(){return function(){a.game&&(a.pause.active=!0,a.game.TogglePause(!0),a.$apply())}}());a.useGameConfig=function(b){CONFIG=GetConfig(b.config);""==b.grid?(a.game=new Game(b,"",a.endCallBack),a.game.Start()):f.get("grids/"+b.grid+".json",{cache:!1}).success(function(d){a.game=new Game(b,d,a.endCallBack);a.game.Start()}).error(function(a){console.log(a)})};
a.endCallBack=function(b){b.stats.SetTime(b.tics);b.stats.SetSwaps(b.tetris[0].swapCount);var c=UserStats.GetUserStats();c.AddGame(b.stats,a.gameName);(new AchievementsState).check(b.stats,c,a.gameName);a.open(b.stateChecker.lastSuccessCheck,b.stats)};a.open=function(b,c){k.open({animation:!0,templateUrl:"templates/modal.html",controller:"ModalInstanceCtrl",size:300,resolve:{won:function(){return b},gameName:function(){return a.gameName},statistics:function(){return c}}}).result.then(function(){b&&
a.game.config.next?(a.gameName=a.game.config.next,h.updateParams({name:a.gameName}),a.load()):a.reset()},function(){})}}]);
gameControllers.controller("ModalInstanceCtrl",["$scope","$modalInstance","won","gameName","statistics",function(a,f,h,g,k){a.won=h;a.published=!1;a.publish=function(){if(!a.published){a.published=!0;var c=UserStorage.GetStorage(),b=c.Get("UserName")||"";(b=prompt("Who are you ?",b))?(c.Set("UserName",b),c=stringToHex(des("wireshar","yop"+stats.score,1,0)),$.get("http://sylvain.luthana.be/api.php?add&name="+b+"&value="+c+"&map="+g)):a.published=!1}};a.nextGame=function(){f.close()};a.stop=function(){f.dismiss("cancel")};
a.stats=function(){function a(b,c,d){void 0===d&&(d=Math.floor);return d(b/c)}var b=UserStats.GetUserStats(),d=b.GetBestGameStats(g),b=b.GetTotalGameStats(g),e=[];e.push({name:"Score",value:stats.score,best:d.score,sum:b.score,mean:a(b.score,b.gameCount)});e.push({name:"Time",value:TimeFromTics(stats.time),best:TimeFromTics(d.time),sum:TimeFromTics(b.time),mean:a(b.time,b.gameCount,TimeFromTics)});e.push({name:"Blocks",value:stats.blockDestroyed,best:d.blockDestroyed,sum:b.blockDestroyed,mean:a(b.blockDestroyed,
b.gameCount)});e.push({name:"Swaps",value:stats.swapCount,best:d.swapCount,sum:b.swapCount,mean:a(b.swapCount,b.gameCount)});e.push({name:"Efficiency",value:(stats.score/stats.swapCount).toFixed(2),best:"/",sum:"/",mean:(b.score/b.swapCount).toFixed(2)});return e}()}]);
var statsControllers=angular.module("angularApp.controllers");
statsControllers.controller("ScoresCtrl",["$scope","$http",function(a,d){a.isActive=function(c){return c===a.type};a.activate=function(c){a.type=name;a.getScores(c)};a.getScores=function(c){d.get("http://sylvain.luthana.be/api.php?get&map="+c).success(function(b){a.scoreGridData=b})};a.activate("classic");a.scoreTypes=[{type:"classic",name:"Classic"},{type:"ultralarge",name:"Wide"},{type:"sandbox",name:"Sandbox"},{type:"ultralargecoop",name:"Coop"}]}]);
statsControllers.controller("AchievementsCtrl",["$scope",function(a){var d=new AchievementsState,c=0;a.achievementsGridData=[];for(var b=0;b<AchievementsState.List.enumSize;b+=1)a.achievementsGridData.push({Picture:"./Resources/imgs/placeholder.png",Name:AchievementsState.List.GetName(b),Success:d.IsWon(b),Description:AchievementsState.List.GetDescription(b)}),d.IsWon(b)&&(c+=1);a.percentComplete=c/AchievementsState.List.enumSize*100}]);
statsControllers.controller("StatCtrl",["$scope",function(a){var d=UserStats.GetUserStats();a.isPositive=function(a){return 0<a};a.isActive=function(b){return b===a.data.active};a.activate=function(b){$("#"+a.data.active).hide();$("#"+b).show();a.data.active=b};var c=function(a){a.best=d.GetBestGameStats(a.link);a.sum=d.GetTotalGameStats(a.link);return a};a.data={active:"Classic"};a.data.maps=[];a.data.maps.push(c({name:"Classic",link:"classic"}));a.data.maps.push(c({name:"Wide",link:"ultralarge"}));
a.data.maps.push(c({name:"SandBox",link:"sandbox"}));a.data.maps.push(c({name:"Coop",link:"ultralargecoop"}));a.data.maps.push(function(){var b,c={name:"Overall",link:""};c.best=new GameStats;c.sum=new GameStats;for(b=0;b<a.data.maps.length;b+=1)GameStats.KeepBest(c.best,a.data.maps[b].best),GameStats.Append(c.sum,a.data.maps[b].sum);return c}())}]);
function Block(){this.type=Block.EType.Random();this.group=-1;this.state=Block.EState.Blocked;this.animationState=this.verticalPosition=0;this.id=-1}Block.prototype.GetCopy=function(){var a=new Block;a.type=this.type;a.group=this.group;a.state=this.state;a.verticalPosition=this.verticalPosition;a.animationState=this.animationState;a.id=this.id;return a};
Block.prototype.LoadFrom=function(a){this.type=a.type;this.group=a.group;this.state=a.state;this.verticalPosition=a.verticalPosition;this.animationState=a.animationState;this.id=a.id};Block.prototype.SetState=function(a){this.state=a;this.animationState=0};Block.EState={Blocked:1,Falling:2,Disappearing:3,SwappedLeft:4,SwappedRight:5};Block.EType={Purple:0,Red:1,Green:2,Blue:3,Grey:4,Orange:5,PlaceHolder:6,Random:function(){return Math.floor(Math.random()*Block.EType.PlaceHolder)}};
Block.prototype.GetHexColor=function(){switch(this.type){case Block.EType.Blue:return 144;case Block.EType.Green:return 36864;case Block.EType.Grey:return 5263440;case Block.EType.Red:return 9437184;case Block.EType.Orange:return 14446099;case Block.EType.Purple:return 5778034}return 0};
var TIC_PER_SEC=60,SEC_PER_MIN=60;function DefaultConfig(){this.columnCount=6;this.displayedRowCount=10;this.hiddenRowCount=4;this.pixelPerBox=50;this.fallSpeedPerTic=7;this.disapearSpeedPerTic=2;this.groundSpeedPerTic=.07;this.groundUpSpeedPerTic=3;this.groundAccelerationPerTic=.02/60/60;this.fallPeriod=500;this.lostThreshold=(this.displayedRowCount+this.hiddenRowCount)*this.pixelPerBox;this.startRows=this.displayedRowCount-4}
function GetConfig(b){var a=new DefaultConfig;"sandbox"===b?(a.groundSpeedPerTic=0,a.fallPeriod=0,a.startRows=a.displayedRowCount+a.hiddenRowCount,a.groundAccelerationPerTic=0):"fixed"===b?(a.groundUpSpeedPerTic=0,a.groundSpeedPerTic=0,a.fallPeriod=0,a.groundAccelerationPerTic=0):"raining"===b?(a.groundSpeedPerTic=0,a.fallPeriod=300,a.groundAccelerationPerTic=0):"large"===b&&(a.columnCount=10);return a}var CONFIG={};
function Game(a,b,c){this.config=a;this.grid=b;this.tetris=[];this.visual=[];this.kb=new UserInput;this.stateChecker=new StateChecker(a.victory);this.tobefixed=[2,2];this.stop=!1;this.id=-1;this.start=null;this.pause=!1;this.tics=0;this.stats=new GameStats;this.stats.gameCount+=1;this.callback=void 0===c?null:c;this.Init()}Game.prototype.Stop=function(){window.cancelAnimationFrame(this.id);this.stop=!0;for(var a=0;a<this.visual.length;a+=1)this.visual[a].clear(),this.visual[a]=null};
Game.CreateRenderingFct=function(a){return function(b){a.render(b)}};Game.prototype.Start=function(){this.id=requestAnimationFrame(Game.CreateRenderingFct(this))};
Game.prototype.Init=function(){for(var a=0;a<this.config.tetris.length;a+=1){this.tetris.push(new Tetris(this.grid,this.config.tetris[a].cursors,this.stats));for(var b=0;b<this.config.tetris[a].mappings.length;b+=1)this.tetris[a].keyBoardMappings.push(UserInput[this.config.tetris[a].mappings[b]]);this.visual.push(new ThreeRenderer(this.config.tetris[a].cursors));this.visual[a].LinkDom(this.config.tetris[a].gameBox);this.visual[a].RenderTetris(this.tetris[a])}};
Game.prototype.SplitScreenQuickFix=function(){if(2===this.tetris.length){for(;this.tobefixed[0]<this.tetris[1].GetScore()/3;)this.tobefixed[0]+=1,this.tetris[0].RandomFall();for(;this.tobefixed[1]<this.tetris[0].GetScore()/3;)this.tobefixed[1]+=1,this.tetris[1].RandomFall()}};
Game.prototype.TogglePause=function(a){if(this.stop)return!1;(this.pause=void 0===a?!this.pause:a)?window.cancelAnimationFrame(this.id):(this.id=requestAnimationFrame(Game.CreateRenderingFct(this)),this.start=null);this.kb.clear();return this.pause};
Game.prototype.render=function(a){null===this.start&&(this.start=a-this.tics/TIC_PER_SEC*1E3);var b=a-this.start;$(".timeBox").html(TimeFromTics(this.tics));for(var c=!0,d=0;this.tics<b*TIC_PER_SEC/1E3&&c&&10>d;){d+=1;this.tics+=1;for(a=0;a<this.tetris.length;a+=1)this.tetris[a].OneTick(this.kb),$("#"+this.config.tetris[a].scoreBox).html(this.tetris[a].GetScore()),this.stateChecker.Check(this.tetris[a]),this.stateChecker.Defeat()||this.stateChecker.Victory()?(c=!1,this.visual[a].Freeze()):void 0!==
this.config.victory&&void 0!==this.config.victory.swaps?$("#"+this.config.tetris[a].swapBox).html(this.config.victory.swaps-this.tetris[a].GetSwaps()):$("#"+this.config.tetris[a].swapBox).html(this.tetris[a].GetSwaps());this.kb.clear()}if(c&&!this.stop){for(a=0;a<this.tetris.length;a+=1)this.visual[a].RenderTetris(this.tetris[a]);this.SplitScreenQuickFix();this.id=requestAnimationFrame(Game.CreateRenderingFct(this))}else c||null!==this.callback&&this.callback(this)};
function Grid(c){var a,b,d=0!==CONFIG.groundUpSpeedPerTic||0!==CONFIG.groundSpeedPerTic;this.container=Array(CONFIG.columnCount);for(a=0;a<CONFIG.columnCount;a+=1)for(this.container[a]=Array(CONFIG.hiddenRowCount),b=0;b<this.container[a].length;b+=1)this.container[a][b]=new Block,this.container[a][b].verticalPosition=b*CONFIG.pixelPerBox,d||(this.container[a][b].type=Block.EType.PlaceHolder,this.container[a][b].state=Block.EState.Blocked);if(void 0===c||""===c)for(a=0;a<CONFIG.columnCount;a+=1)for(b=
this.container[a].length;b<CONFIG.startRows;b+=1)this.container[a].push(new Block),this.container[a][b].verticalPosition=b*CONFIG.pixelPerBox;else this.Load(c)}Grid.prototype.AddNewLine=function(){var c,a;for(c=0;c<CONFIG.columnCount;c+=1){for(a=0;a<this.container[c].length;a+=1)this.container[c][a].verticalPosition+=CONFIG.pixelPerBox;this.container[c].unshift(new Block)}};
Grid.prototype.RemoveBlockFixed=function(c,a){var b=this.container[c][a];this.container[c].splice(a,1);this.MakeTopBlockFall(c,a);return b};Grid.prototype.RemoveBlock=function(c,a){var b=this.FindBlockIndex(c,a);if(-1===b)throw"Not my day";return this.RemoveBlockFixed(c,b)};Grid.prototype.InsertBlock=function(c,a){for(var b=0;b<this.container[a].length;b+=1)if(this.container[a][b].verticalPosition>c.verticalPosition){this.container[a].splice(b,0,c);return}this.container[a].push(c)};
Grid.prototype.FindBlock=function(c,a){var b=this.FindBlockIndex(c,a);return-1===b?null:this.container[c][b]};Grid.prototype.FindBlockIndex=function(c,a){for(var b in this.container[c])if(this.container[c].hasOwnProperty(b)&&this.container[c][b].verticalPosition===CONFIG.pixelPerBox*a)return parseInt(b);return-1};
Grid.prototype.IsBlockIndexFree=function(c,a){for(var b in this.container[c])if(this.container[c].hasOwnProperty(b)&&this.container[c][b].verticalPosition>=CONFIG.pixelPerBox*a&&this.container[c][b].verticalPosition<CONFIG.pixelPerBox*(a+1))return!1;return!0};Grid.prototype.MakeTopBlockFall=function(c,a){if(0>a)throw"Not my day";for(var b=a;b<this.container[c].length&&this.container[c][b].state===Block.EState.Blocked;b+=1)this.container[c][b].SetState(Block.EState.Falling)};
Grid.prototype.AnimateBlockFall=function(c,a,b,d){b.verticalPosition-=CONFIG.fallSpeedPerTic;b.verticalPosition<d&&(b.verticalPosition=d,this.container[c][a-1].state!==Block.EState.Falling&&b.SetState(Block.EState.Blocked));return{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateBlockDisappear=function(c,a,b,d){b.animationState+=CONFIG.disapearSpeedPerTic;return 100<b.animationState&&-1===b.id?(this.container[c].splice(a,1),this.MakeTopBlockFall(c,a),{min:d,deltaY:-1}):{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateSwapped=function(c,a,b,d){b.animationState+=15;if(100<b.animationState){if(b.type===Block.EType.PlaceHolder)return this.RemoveBlockFixed(c,a),{min:d,deltaY:-1};this.container[c][a-1].state===Block.EState.Falling||this.container[c][a-1].verticalPosition<b.verticalPosition-CONFIG.pixelPerBox?(b.SetState(Block.EState.Falling),this.MakeTopBlockFall(c,a+1)):b.SetState(Block.EState.Blocked)}return{min:b.verticalPosition+CONFIG.pixelPerBox,deltaY:0}};
Grid.prototype.AnimateBlock=function(c,a,b){var d=this.container[c][a];switch(d.state){case Block.EState.Blocked:return{min:d.verticalPosition+CONFIG.pixelPerBox,deltaY:0};case Block.EState.Disappearing:return this.AnimateBlockDisappear(c,a,d,b);case Block.EState.Falling:return this.AnimateBlockFall(c,a,d,b);case Block.EState.SwappedRight:case Block.EState.SwappedLeft:return this.AnimateSwapped(c,a,d,b)}throw"Unsupported animation";};
Grid.prototype.AnimateColumn=function(c){var a,b,d;b=CONFIG.hiddenRowCount*CONFIG.pixelPerBox;for(a=CONFIG.hiddenRowCount;a<this.container[c].length;a+=1)d=this.AnimateBlock(c,a,b),b=d.min,a+=d.deltaY};Grid.prototype.Animate=function(){for(var c=0;c<CONFIG.columnCount;c+=1)this.AnimateColumn(c)};
Grid.prototype.GetMaxFixed=function(){var c,a,b=0;for(c=0;c<CONFIG.columnCount;c+=1)for(a=CONFIG.hiddenRowCount;a<this.container[c].length&&this.container[c][a].state===Block.EState.Blocked;a+=1)this.container[c][a].verticalPosition>b&&(b=this.container[c][a].verticalPosition);return b};Grid.prototype.NewBlockFall=function(c){var a=new Block;a.SetState(Block.EState.Falling);a.verticalPosition=(CONFIG.hiddenRowCount+CONFIG.displayedRowCount+1)*CONFIG.pixelPerBox;this.container[c].push(a)};
Grid.prototype.Swap=function(c,a){var b=this.FindBlock(c,a),d=this.FindBlock(c+1,a);if(null!==b&&null!==d){if(b.state===Block.EState.Blocked&&d.state===Block.EState.Blocked)return this.SwapBlocks(b,d),!0}else{if(null!==b&&this.IsBlockIndexFree(c+1,a)&&b.state===Block.EState.Blocked)return d=new Block,d.type=Block.EType.PlaceHolder,d.state=Block.EState.SwappedLeft,d.verticalPosition=b.verticalPosition,this.InsertBlock(d,c+1),this.SwapBlocks(b,d),!0;if(null!==d&&this.IsBlockIndexFree(c,a)&&d.state===
Block.EState.Blocked)return b=new Block,b.type=Block.EType.PlaceHolder,b.state=Block.EState.SwappedRight,b.verticalPosition=d.verticalPosition,this.InsertBlock(b,c),this.SwapBlocks(b,d),!0}return!1};Grid.prototype.SwapBlocks=function(c,a){var b=c.GetCopy();c.LoadFrom(a);a.LoadFrom(b);c.SetState(Block.EState.SwappedLeft);a.SetState(Block.EState.SwappedRight)};
Grid.prototype.Load=function(c){var a,b;for(a=0;a<c.grid.length;a+=1)for(b=0;b<c.grid[a].length;b+=1){var d=new Block;d.state=c.grid[a][b].state;d.type=c.grid[a][b].type;d.verticalPosition=this.container[a].length*CONFIG.pixelPerBox;this.container[a].push(d)}};Grid.prototype.Evaluate=function(c){return(new GridEvaluator(c)).Evaluate(this.container)};Grid.prototype.BlockCount=function(){for(var c=0,a=0;a<this.container.length;a+=1)c+=this.container[a].length-CONFIG.hiddenRowCount;return c};
GridEvaluator=function(a){this.series=[];this.stats=a};
GridEvaluator.prototype.EvaluateColumn=function(a,b){for(var c=0,e=null,f=-1,d=CONFIG.hiddenRowCount;d<a[b].length;d+=1)a[b][d].state!==Block.EState.Blocked?(c=0,e=null):a[b][d].type!==e?(e=a[b][d].type,c=1):(c+=1,3===c?(a[b][d].SetState(Block.EState.Disappearing),a[b][d-1].SetState(Block.EState.Disappearing),a[b][d-2].SetState(Block.EState.Disappearing),this.series.push([]),f=this.series.length-1,this.series[f].push(a[b][d].id),this.series[f].push(a[b][d-1].id),this.series[f].push(a[b][d-2].id)):
3<c&&(a[b][d].SetState(Block.EState.Disappearing),this.series[f].push(a[b][d].id)))};GridEvaluator.prototype.EvaluateVertical=function(a){for(var b=0;b<CONFIG.columnCount;b+=1)this.EvaluateColumn(a,b)};GridEvaluator.prototype.FindBlockIndex=function(a,b,c){for(var e in a[b])if(a[b].hasOwnProperty(e)&&a[b][e].verticalPosition===CONFIG.pixelPerBox*c)return parseInt(e);return-1};
GridEvaluator.prototype.EvaluateLine=function(a,b){var c,e,f,d=-1,h=-1,l=-1;f=0;e=null;var g=-1;for(c=0;c<CONFIG.columnCount;c+=1)if(l=h,h=d,d=this.FindBlockIndex(a,c,b),-1===d)f=0;else{var k=a[c][d];k.state===Block.EState.Blocked||k.state===Block.EState.Disappearing&&0===k.animationState?(k.type!==e&&(e=a[c][d].type,f=0),f+=1,3===f?(a[c][d].SetState(Block.EState.Disappearing),a[c-1][h].SetState(Block.EState.Disappearing),a[c-2][l].SetState(Block.EState.Disappearing),this.series.push([]),g=this.series.length-
1,this.series[g].push(a[c][d].id),this.series[g].push(a[c-1][h].id),this.series[g].push(a[c-2][l].id)):3<f&&(a[c][d].SetState(Block.EState.Disappearing),this.series[g].push(a[c][d].id))):f=0}};GridEvaluator.prototype.EvaluateHorizontal=function(a){for(var b=CONFIG.hiddenRowCount;b<CONFIG.displayedRowCount+CONFIG.hiddenRowCount;b+=1)this.EvaluateLine(a,b)};
GridEvaluator.prototype.GetScore=function(){for(var a=this.series.length,b=0,c=0;c<a;c+=1)b+=(this.series[c].length-2)*a;this.stats.AddLines(this.series,b);return b};GridEvaluator.prototype.GetSerie=function(a,b){for(var c=b-1;0<=c;--c)for(var e=0;e<this.series[c].length;e+=1)if(this.series[c][e]===a)return c;return-1};
GridEvaluator.prototype.MergeSeries=function(){for(var a=this.series.length-1;0<=a;--a)for(var b=0;b<this.series[a].length;b+=1){var c=this.GetSerie(this.series[a][b],a);if(-1!==c){this.series[c]=this.series[c].concat(this.series[a]);this.series.splice(a,1);break}}};GridEvaluator.prototype.Evaluate=function(a){this.EvaluateVertical(a);this.EvaluateHorizontal(a);this.MergeSeries();return this.GetScore()};
function StateChecker(a){this.defeatComponents=[];this.succesComponents=[];this.MakeComponents(a);this.defeatComponents.push(new PillarSizeChecker);this.lastDefeatCheck=this.lastSuccessCheck=!1}StateChecker.prototype.Defeat=function(){return this.lastDefeatCheck};StateChecker.prototype.Victory=function(){return this.lastSuccessCheck};
StateChecker.prototype.Check=function(a){this.lastSuccessCheck=0!==this.succesComponents.length;this.lastDefeatCheck=!1;for(var b=0;b<this.succesComponents.length;b+=1)this.lastSuccessCheck=this.succesComponents[b].Check(a)&&this.lastSuccessCheck;for(b=0;b<this.defeatComponents.length;b+=1)this.lastDefeatCheck=this.defeatComponents[b].Check(a)||this.lastDefeatCheck};
StateChecker.prototype.MakeComponents=function(a){$("#rules").html("<ul />");null===a||void 0===a?$("#rules ul").append($("<li class='succesCond'>Try to stay alive !</li>")):(void 0!==a.blocksLeft&&this.succesComponents.push(new BlockChecker(a.blocksLeft)),void 0!==a.score&&this.succesComponents.push(new ScoreChecker(a.score)),void 0!==a.swaps&&this.defeatComponents.push(new SwapChecker(a.swaps)),void 0!==a.time&&this.defeatComponents.push(new TimeChecker(a.time)))};
function PillarSizeChecker(){$("#rules ul").append($("<li class='defeatCond'></li>"))}PillarSizeChecker.prototype.Check=function(a){return a.GetMaxFixed()>=CONFIG.lostThreshold};function ScoreChecker(a){$("#rules ul").append($("<li class='successCond'>Get "+a+" points</li>"));this.val=a}ScoreChecker.prototype.Check=function(a){return a.GetScore()>=this.val};
function BlockChecker(a){0===a?$("#rules ul").append($("<li class='successCond'>Destroy each block</li>")):$("#rules ul").append($("<li class='successCond'>Reduce the block count to "+a+"</li>"));this.val=a}BlockChecker.prototype.Check=function(a){return a.grid.BlockCount()<=this.val};function SwapChecker(a){$("#rules ul").append($("<li class='defeatCond'>Max "+a+" swaps</li>"));this.val=a}SwapChecker.prototype.Check=function(a){return a.swapCount>this.val};
function TimeChecker(a){$("#rules ul").append($("<li class='defeatCond'>Max "+a+" seconds</li>"));this.val=a}TimeChecker.prototype.Check=function(a){return a.tics/TIC_PER_SEC>this.val};
function Tetris(a,b,c){this.grid=new Grid(a);this.stats=c;this.score=0;this.cursor=[];void 0===b&&(b=1);for(a=0;a<b;a+=1)this.cursor.push({x:2+2*a,y:CONFIG.hiddenRowCount});this.swapCount=0;this.baseGroundSpeed=this.groundSpeed=CONFIG.groundSpeedPerTic;this.groundPos=0;this.keyBoardMappings=[];this.tics=0}
Tetris.prototype.OneTick=function(a){this.score+=this.grid.Evaluate(this.stats);this.HandleUserInput(a);this.tics+=1;0!==CONFIG.fallPeriod&&0===this.tics%CONFIG.fallPeriod&&this.RandomFall();this.grid.Animate();this.groundPos+=this.groundSpeed;this.groundSpeed+=CONFIG.groundAccelerationPerTic;this.baseGroundSpeed+=CONFIG.groundAccelerationPerTic;if(this.groundPos>=CONFIG.pixelPerBox){this.groundPos-=CONFIG.pixelPerBox;this.grid.AddNewLine();for(a=0;a<this.cursor.length;a+=1)this.cursor[a].y+=1;this.groundSpeed=
this.baseGroundSpeed}};Tetris.prototype.GetMaxFixed=function(){return this.grid.GetMaxFixed()};Tetris.prototype.IsMoving=function(){return this.grid.IsMoving()};Tetris.prototype.GetScore=function(){return this.score};Tetris.prototype.GetSwaps=function(){return this.swapCount};function GetIntBetween(a,b){return Math.floor(Math.random()*(b-a+1))+a}Tetris.prototype.RandomFall=function(){for(var a=GetIntBetween(0,CONFIG.columnCount-3),b=a;b<a+3;b+=1)this.grid.NewBlockFall(b)};
Tetris.prototype.HandleUserInput=function(a){for(var b=0;b<this.keyBoardMappings.length;b+=1){var c=this.cursor[b%this.cursor.length];a.pressed(this.keyBoardMappings[b].swap)&&this.grid.Swap(c.x,c.y)&&(this.swapCount+=1);a.pressed(this.keyBoardMappings[b].down)&&(c.y=Math.max(CONFIG.hiddenRowCount,c.y-1));a.pressed(this.keyBoardMappings[b].up)&&(c.y=Math.min(CONFIG.hiddenRowCount+CONFIG.displayedRowCount,c.y+1));a.pressed(this.keyBoardMappings[b].left)&&(c.x=Math.max(0,c.x-1));a.pressed(this.keyBoardMappings[b].right)&&
(c.x=Math.min(CONFIG.columnCount-2,c.x+1));a.pressed(this.keyBoardMappings[b].speed)&&(this.groundSpeed=CONFIG.groundUpSpeedPerTic)}};
function ThreeRenderer(b){void 0===b&&(b=1);this.camera=this.CreateCamera();this.renderer=this.CreateRenderer();this.light=this.CreateLight();this.cursor=[this.CreateCursor(32896)];for(var a=1;a<b;a+=1)this.cursor.push(this.CreateCursor(8388736));this.scene=this.CreateScene();this.offset=0;this.id=String.fromCharCode(65+Math.floor(26*Math.random()))+Date.now()}ThreeRenderer.prototype.clear=function(){this.renderer=this.cursor=this.camera=this.light=this.scene=null};
ThreeRenderer.prototype.CreateLight=function(){var b=new THREE.DirectionalLight(13421772);b.position.set(500,1E3,2E3);b.castShadow=!0;b.shadowCameraVisible=!1;b.shadowDarkness=.2;b.shadowMapWidth=b.shadowMapHeight=1E3;return b};
ThreeRenderer.prototype.CreateScene=function(){var b=new THREE.Scene;b.add(this.light);for(var a=0;a<this.cursor.length;a+=1)b.add(this.cursor[a]);var a=new THREE.PlaneGeometry(1E3,400),c=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.5}),a=new THREE.Mesh(a,c);a.rotation.x+=1.62;a.position.setY(CONFIG.hiddenRowCount*CONFIG.pixelPerBox-CONFIG.pixelPerBox/2);a.renderDepth=1;b.add(a);a=new THREE.BoxGeometry(1E3,3,3);c=new THREE.MeshPhongMaterial({color:3342336,emissive:10027008});
a=new THREE.Mesh(a,c);a.position.set(0,(CONFIG.hiddenRowCount+CONFIG.displayedRowCount)*CONFIG.pixelPerBox,10);b.add(a);a=new THREE.BoxGeometry(1E3,3,3);c=new THREE.MeshPhongMaterial({color:13056,emissive:39168});a=new THREE.Mesh(a,c);a.position.set(0,CONFIG.hiddenRowCount*CONFIG.pixelPerBox-CONFIG.pixelPerBox/2+5,10);b.add(a);return b};ThreeRenderer.prototype.CreateCamera=function(){var b=new THREE.PerspectiveCamera(75,.7,.3,1E3);b.position.z=450;b.position.x=-27;b.position.y=410;return b};
ThreeRenderer.prototype.CreateRenderer=function(){var b=new THREE.WebGLRenderer({antialias:!0});b.setClearColor(0);b.setSize(420,600);b.shadowMapEnabled=!0;b.shadowMapSoft=!0;return b};ThreeRenderer.prototype.AddCube=function(b){var a=new THREE.BoxGeometry(.7*CONFIG.pixelPerBox,.7*CONFIG.pixelPerBox,CONFIG.pixelPerBox/4);b=new THREE.MeshPhongMaterial({color:b,emissive:1118481});a=new THREE.Mesh(a,b);this.scene.add(a);return a.id};
function CalculateX(b,a){return b.state===Block.EState.SwappedLeft?a+CONFIG.pixelPerBox/100*(100-b.animationState):b.state===Block.EState.SwappedRight?a-CONFIG.pixelPerBox/100*(100-b.animationState):a}
ThreeRenderer.prototype.UpdateCube=function(b,a){var c=this.scene.getObjectById(a.id);c.position.setY(a.verticalPosition+this.offset);c.position.setX(CalculateX(a,b));c.material.color=new THREE.Color(a.GetHexColor());a.state===Block.EState.Disappearing&&(c.material.opacity=Math.max(1-a.animationState/100,0),c.material.transparent=!0);0===c.material.opacity&&(this.scene.remove(c),a.id=-1)};
ThreeRenderer.prototype.Render=function(){this.light.position.setY(1E3+this.offset);this.renderer.render(this.scene,this.camera)};ThreeRenderer.prototype.LinkDom=function(b){this.renderer.domElement.setAttribute("id",this.id);var a=$("#"+b+" .gamePlaceHolder");if(0===a.length)throw b+"missing gameplaceHolder";a.empty();a.append($(this.renderer.domElement))};ThreeRenderer.prototype.UnlinkDom=function(){var b=document.getElementById(this.id);null!==b&&b.parentNode.removeChild(b)};
ThreeRenderer.prototype.CreateCursor=function(b){var a=new THREE.Shape;a.absarc(72,-13,10,-Math.PI/2,0,!0);a.lineTo(82,0);a.absarc(72,13,10,0,Math.PI/2,!0);a.lineTo(35,20);a.lineTo(35,0);a.absarc(-2,-13,10,3*Math.PI/2,Math.PI,!0);a.lineTo(-12,0);a.absarc(-2,13,10,Math.PI,Math.PI/2,!0);a.lineTo(35,-20);return new THREE.PointCloud(a.createPointsGeometry(),new THREE.PointCloudMaterial({color:b,size:4}))};
ThreeRenderer.prototype.DrawCursorOn=function(b,a,c){void 0===c&&(c=0);this.cursor[c].position.set((b-CONFIG.columnCount/2)*CONFIG.pixelPerBox-10,a*(CONFIG.pixelPerBox-.5)+this.offset+5,7)};ThreeRenderer.prototype.Freeze=function(){for(var b=0;b<this.cursor.length;b+=1)this.scene.remove(this.cursor[b]);this.Render()};
ThreeRenderer.prototype.RenderTetris=function(b){this.offset=b.groundPos;for(var a,c=0;c<CONFIG.columnCount;c+=1)for(var d=0;d<b.grid.container[c].length;d+=1)a=b.grid.container[c][d],a.type!==Block.EType.PlaceHolder&&(-1===a.id&&(a.id=this.AddCube(a.GetHexColor())),this.UpdateCube((c-CONFIG.columnCount/2)*CONFIG.pixelPerBox,a));for(c=0;c<b.cursor.length;c+=1)this.DrawCursorOn(b.cursor[c].x,b.cursor[c].y,c);this.Render()};
function uiOnClick(a){a.data.obj.keyCodes[a.data.key]=!0}
var UserInput=function(){this.keyCodes={};var a=this;this._onKeyDown=function(b){a._onKeyChange(b)};document.addEventListener("keydown",this._onKeyDown,!1);$("#moveUp").click({obj:this,key:UserInput.ALIAS.up},uiOnClick);$("#moveDown").click({obj:this,key:UserInput.ALIAS.down},uiOnClick);$("#moveLeft").click({obj:this,key:UserInput.ALIAS.left},uiOnClick);$("#moveRight").click({obj:this,key:UserInput.ALIAS.right},uiOnClick);$("#swapBtn").click({obj:this,key:UserInput.ALIAS.space},uiOnClick)};
UserInput.prototype.destroy=function(){document.removeEventListener("keydown",this._onKeyDown,!1)};UserInput.ALIAS={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9,enter:13};UserInput.prototype.clear=function(){this.keyCodes={}};UserInput.prototype._onKeyChange=function(a){var b=a.keyCode;this.keyCodes[b]=!0;(b===UserInput.ALIAS.space||b>=UserInput.ALIAS.left&&b<=UserInput.ALIAS.down)&&a.preventDefault()};UserInput.prototype.pressed=function(a){return!0===this.keyCodes[a]};
UserInput.leftMapping={swap:UserInput.ALIAS.space,down:83,up:90,left:81,right:68,speed:65};UserInput.rightMapping={swap:96,down:UserInput.ALIAS.down,up:UserInput.ALIAS.up,left:UserInput.ALIAS.left,right:UserInput.ALIAS.right,speed:UserInput.ALIAS.enter};
function Notifications(){this.notificationZone=$("#notificationZone");this.count=0}Notifications.prototype.notify=function(b){this.count+=1;var a=String.fromCharCode(65+Math.floor(26*Math.random()))+Date.now()+"_"+this.count;this.notificationZone.append($("<div class='notification' id='"+a+"'>"+b+"</div>"));$("#"+a).slideDown("slow");setTimeout(function(){$("#"+a).slideUp("slow",function(){$(this).remove()})},1E4)};
function des(f,e,k,l,g,b){var m=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],v=[-2146402272,-2147450880,
32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,
32800,-2147483648,-2146435040,-2146402272,1081344],d=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,
131592,8,134348808,131584],w=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],p=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,
1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],F=[536870928,541065216,
16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],G=[2097152,
69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],H=[268439616,4096,262144,268701760,268435456,
268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696];f=des_createKeys(f);var h=0,n,q,r,c,a,x,t,A,u,B,C,
D,y=e.length,z=0,E=32==f.length?3:9;x=3==E?k?[0,32,2]:[30,-2,-2]:k?[0,32,2,62,30,-2,64,96,2]:[94,62,-2,32,64,2,30,-2,-2];2==b?e+="        ":1==b?(b=8-y%8,e+=String.fromCharCode(b,b,b,b,b,b,b,b),8==b&&(y+=8)):b||(e+="\x00\x00\x00\x00\x00\x00\x00\x00");tempresult=result="";1==l&&(t=g.charCodeAt(h++)<<24|g.charCodeAt(h++)<<16|g.charCodeAt(h++)<<8|g.charCodeAt(h++),u=g.charCodeAt(h++)<<24|g.charCodeAt(h++)<<16|g.charCodeAt(h++)<<8|g.charCodeAt(h++),h=0);for(;h<y;){c=e.charCodeAt(h++)<<24|e.charCodeAt(h++)<<
16|e.charCodeAt(h++)<<8|e.charCodeAt(h++);a=e.charCodeAt(h++)<<24|e.charCodeAt(h++)<<16|e.charCodeAt(h++)<<8|e.charCodeAt(h++);1==l&&(k?(c^=t,a^=u):(A=t,B=u,t=c,u=a));b=(c>>>4^a)&252645135;a^=b;c^=b<<4;b=(c>>>16^a)&65535;a^=b;c^=b<<16;b=(a>>>2^c)&858993459;c^=b;a^=b<<2;b=(a>>>8^c)&16711935;c^=b;a^=b<<8;b=(c>>>1^a)&1431655765;a^=b;c^=b<<1;c=c<<1|c>>>31;a=a<<1|a>>>31;for(n=0;n<E;n+=3){C=x[n+1];D=x[n+2];for(g=x[n];g!=C;g+=D)q=a^f[g],r=(a>>>4|a<<28)^f[g+1],b=c,c=a,a=b^(v[q>>>24&63]|w[q>>>16&63]|F[q>>>
8&63]|H[q&63]|m[r>>>24&63]|d[r>>>16&63]|p[r>>>8&63]|G[r&63]);b=c;c=a;a=b}c=c>>>1|c<<31;a=a>>>1|a<<31;b=(c>>>1^a)&1431655765;a^=b;c^=b<<1;b=(a>>>8^c)&16711935;c^=b;a^=b<<8;b=(a>>>2^c)&858993459;c^=b;a^=b<<2;b=(c>>>16^a)&65535;a^=b;c^=b<<16;b=(c>>>4^a)&252645135;a^=b;c^=b<<4;1==l&&(k?(t=c,u=a):(c^=A,a^=B));tempresult+=String.fromCharCode(c>>>24,c>>>16&255,c>>>8&255,c&255,a>>>24,a>>>16&255,a>>>8&255,a&255);z+=8;512==z&&(result+=tempresult,tempresult="",z=0)}return result+tempresult}
function des_createKeys(f){pc2bytes0=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964];pc2bytes1=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697];pc2bytes2=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272];pc2bytes3=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,
139264,2236416,134356992,136454144];pc2bytes4=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256];pc2bytes5=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488];pc2bytes6=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746];pc2bytes7=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,
537069568];pc2bytes8=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578];pc2bytes9=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488];pc2bytes10=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800];pc2bytes11=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744];
pc2bytes12=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128];pc2bytes13=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261];for(var e=8<f.length?3:1,k=Array(32*e),l=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],g,b,m=0,v=0,d,w=0;w<e;w++){left=f.charCodeAt(m++)<<24|f.charCodeAt(m++)<<16|f.charCodeAt(m++)<<8|f.charCodeAt(m++);right=f.charCodeAt(m++)<<24|f.charCodeAt(m++)<<16|f.charCodeAt(m++)<<8|f.charCodeAt(m++);d=(left>>>4^right)&252645135;
right^=d;left^=d<<4;d=(right>>>-16^left)&65535;left^=d;right^=d<<-16;d=(left>>>2^right)&858993459;right^=d;left^=d<<2;d=(right>>>-16^left)&65535;left^=d;right^=d<<-16;d=(left>>>1^right)&1431655765;right^=d;left^=d<<1;d=(right>>>8^left)&16711935;left^=d;right^=d<<8;d=(left>>>1^right)&1431655765;right^=d;left^=d<<1;d=left<<8|right>>>20&240;left=right<<24|right<<8&16711680|right>>>8&65280|right>>>24&240;right=d;for(var p=0;p<l.length;p++)l[p]?(left=left<<2|left>>>26,right=right<<2|right>>>26):(left=
left<<1|left>>>27,right=right<<1|right>>>27),left&=-15,right&=-15,g=pc2bytes0[left>>>28]|pc2bytes1[left>>>24&15]|pc2bytes2[left>>>20&15]|pc2bytes3[left>>>16&15]|pc2bytes4[left>>>12&15]|pc2bytes5[left>>>8&15]|pc2bytes6[left>>>4&15],b=pc2bytes7[right>>>28]|pc2bytes8[right>>>24&15]|pc2bytes9[right>>>20&15]|pc2bytes10[right>>>16&15]|pc2bytes11[right>>>12&15]|pc2bytes12[right>>>8&15]|pc2bytes13[right>>>4&15],d=(b>>>16^g)&65535,k[v++]=g^d,k[v++]=b^d<<16}return k}
function stringToHex(f){for(var e="0x",k="0123456789abcdef".split(""),l=0;l<f.length;l++)e+=k[f.charCodeAt(l)>>4]+k[f.charCodeAt(l)&15];return e}function hexToString(f){for(var e="",k="0x"==f.substr(0,2)?2:0;k<f.length;k+=2)e+=String.fromCharCode(parseInt(f.substr(k,2),16));return e};
function getQueryVariable(c){for(var a=window.location.search.substring(1).split("&"),b=0;b<a.length;b+=1){var d=a[b].split("=");if(d[0]==c)return d[1]}return""}function TimeFromTics(c){var a=Math.floor(c/TIC_PER_SEC),b=Math.floor(a/SEC_PER_MIN),a=a%SEC_PER_MIN;return(10>b?"0"+b:b)+":"+(10>a?"0"+a:a)+"."+Math.floor(c%TIC_PER_SEC/6)};
function AchievementsState(){var a=UserStorage.GetStorage();this.notif=new Notifications;this.container=a.Get("UserAchievements")||[];for(a=this.container.length;a<AchievementsState.List.enumSize;a+=1)this.container[a]=!1}AchievementsState.prototype.IsWon=function(a){return this.container[a]};AchievementsState.prototype.check=function(a,c,b){for(var d=0;d<AchievementsState.List.enumSize;d+=1)this.checkIndividual(d,a,c,b);UserStorage.GetStorage().Set("UserAchievements",this.container)};
AchievementsState.prototype.keyToScore=function(a){switch(a){case AchievementsState.List.Beginner:return 10;case AchievementsState.List.Expert:return 80;case AchievementsState.List.Master:return 160;case AchievementsState.List.God:return 350;case AchievementsState.List.Cheater:return 1E3}throw"What are you doing here ?";};
AchievementsState.prototype.checkMultiLines=function(a,c){var b=0;switch(a){case AchievementsState.List.Ambidextrous:b=1;break;case AchievementsState.List.Psychics:b=2;break;case AchievementsState.List.Sorcerer:b=3;break;default:throw"What are you doing here ?";}for(;b<c.multilines.length;b+=1)if(c.multilines[b])return!0;return!1};
AchievementsState.prototype.checkIndividual=function(a,c,b,d){if(!this.container[a]){switch(a){case AchievementsState.List.Beginner:case AchievementsState.List.Expert:case AchievementsState.List.Master:case AchievementsState.List.God:"classic"===d&&(this.container[a]=c.score>=this.keyToScore(a));break;case AchievementsState.List.Cheater:"sandbox"===d&&(this.container[a]=c.score>=this.keyToScore(a));break;case AchievementsState.List.Ambidextrous:case AchievementsState.List.Psychics:case AchievementsState.List.Sorcerer:this.container[a]=
this.checkMultiLines(a,c);break;case AchievementsState.List.Stubborn:this.container[a]=b.GetTotalGameStats(d).time>TIC_PER_SEC*SEC_PER_MIN*30;break;case AchievementsState.List.BiggerIsBetter:for(b=3;b<c.lineSizes.length;b+=1)if(c.lineSizes[b]){this.container[a]=!0;break}}this.container[a]&&this.notif.notify("Gratz you unlocked : "+AchievementsState.List.GetName(a))}};
AchievementsState.List={Beginner:0,Expert:1,Master:2,God:3,Cheater:4,Ambidextrous:5,Psychics:6,Sorcerer:7,Stubborn:8,BiggerIsBetter:9,Nostalgic:10,enumSize:11};AchievementsState.List.GetName=function(a){for(var c in AchievementsState.List)if(AchievementsState.List[c]===a)return c;return""};
AchievementsState.List.GetDescription=function(a){switch(a){case AchievementsState.List.Beginner:return"Get 10 points in classic";case AchievementsState.List.Expert:return"Get 80 points in classic";case AchievementsState.List.Master:return"Get 160 points in classic";case AchievementsState.List.God:return"Get 350 points in classic";case AchievementsState.List.Cheater:return"Get 1000 points in sandbox";case AchievementsState.List.Ambidextrous:return"Get 2 series at once in any game mode";case AchievementsState.List.Psychics:return"Get 3 series at once in any game mode";
case AchievementsState.List.Sorcerer:return"Get 4 series at once in any game mode";case AchievementsState.List.Stubborn:return"Play for 30 minutes in any game mode";case AchievementsState.List.BiggerIsBetter:return"Create a line of 6 blocks in any game mode";case AchievementsState.List.Nostalgic:return"Not working yet :)"}return""};
function GameStats(){this.blockDestroyed=this.time=this.score=0;this.multilines=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.lineSizes=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.swapCount=this.gameCount=0}GameStats.prototype.AddLines=function(a,c){this.score+=c;this.multilines[a.length-2]+=1;for(var b=0;b<a.length;b+=1){var d=[];$.each(a[b],function(a,b){-1===$.inArray(b,d)&&d.push(b)});this.lineSizes[d.length-3]+=1;this.blockDestroyed+=d.length}};GameStats.prototype.SetTime=function(a){this.time=a};
GameStats.prototype.SetSwaps=function(a){this.swapCount=a};GameStats.Append=function(a,c){a.gameCount+=c.gameCount;a.score+=c.score;a.time+=c.time;a.blockDestroyed+=c.blockDestroyed;a.swapCount+=c.swapCount;for(var b=0;b<a.multilines.length;b+=1)a.multilines[b]+=c.multilines[b];for(b=0;b<a.lineSizes.length;b+=1)a.lineSizes[b]+=c.lineSizes[b]};
GameStats.KeepBest=function(a,c){a.gameCount+=c.gameCount;a.score=a.score>c.score?a.score:c.score;a.time=a.time>c.time?a.time:c.time;a.blockDestroyed=a.blockDestroyed>c.blockDestroyed?a.blockDestroyed:c.blockDestroyed;a.swapCount=a.swapCount>c.swapCount?a.swapCount:c.swapCount;for(var b=0;b<a.multilines.length;b+=1)a.multilines[b]=a.multilines[b]>c.multilines[b]?a.multilines[b]:c.multilines[b];for(b=0;b<a.lineSizes.length;b+=1)a.lineSizes[b]=a.lineSizes[b]>c.lineSizes[b]?a.lineSizes[b]:c.lineSizes[b]};
function UserStorage(){}UserStorage.GetStorage=function(){return new UserStorage};UserStorage.prototype.Get=function(a){a=localStorage.getItem(a);if(null===a||void 0===a)return null;try{return JSON.parse(a)}catch(b){console.log(b)}return null};UserStorage.prototype.Set=function(a,b){localStorage.setItem(a,JSON.stringify(b))};
function UserStats(){this.points={};this.timesLow={};this.timesHigh={};this.bestGameStats={};this.totalGameStats={}}UserStats.prototype.SetMaxStat=function(a,b,c){if(this[c].hasOwnProperty(b))for(var d=0;d<this[c][b].length;d+=1){if(a>=this[c][b][d]){this[c][b].splice(d,0,a);this[c][b].splice(this[c][b].length-1,1);break}}else this[c][b]=[a,0,0,0,0];UserStorage.GetStorage().Set("UserStats_"+c,this[c])};
UserStats.prototype.SetMinStat=function(a,b,c){if(this[c].hasOwnProperty(b))for(var d=0;d<this[c][b].length;d+=1){if(a<=this[c][b][d]||-1===this[c][b][d]){this[c][b].splice(d,0,a);this[c][b].splice(this[c][b].length-1,1);break}}else this[c][b]=[a,-1,-1,-1,-1];UserStorage.GetStorage().Set("UserStats_"+c,this[c])};
UserStats.prototype.AddGame=function(a,b){var c=UserStorage.GetStorage();this.bestGameStats.hasOwnProperty(b)?GameStats.KeepBest(this.bestGameStats[b],a):this.bestGameStats[b]=a;c.Set("UserStats_bestGameStats",this.bestGameStats);this.totalGameStats.hasOwnProperty(b)?GameStats.Append(this.totalGameStats[b],a):this.totalGameStats[b]=a;c.Set("UserStats_totalGameStats",this.totalGameStats);this.SetMaxStat(a.score,b,"points");this.SetMinStat(a.time,b,"timesLow");this.SetMaxStat(a.time,b,"timesHigh")};
UserStats.prototype.GetBestGameStats=function(a){return this.bestGameStats.hasOwnProperty(a)?this.bestGameStats[a]:new GameStats(a)};UserStats.prototype.GetTotalGameStats=function(a){return this.totalGameStats.hasOwnProperty(a)?this.totalGameStats[a]:new GameStats(a)};UserStats.prototype.GetHighScore=function(a){return this.points.hasOwnProperty(a)?this.points[a]:[0,0,0,0,0]};UserStats.prototype.GetMinTime=function(a){return this.timesLow.hasOwnProperty(a)?this.timesLow[a]:[-1,-1,-1,-1,-1]};
UserStats.prototype.GetMaxTime=function(a){return this.timesHigh.hasOwnProperty(a)?this.timesHigh[a]:[0,0,0,0,0]};UserStats.GetUserStats=function(){var a=UserStorage.GetStorage(),b=a.Get("UserStats_points"),c=a.Get("UserStats_timesLow"),d=a.Get("UserStats_timesHigh"),f=a.Get("UserStats_bestGameStats"),a=a.Get("UserStats_totalGameStats"),e=new UserStats;null!==b&&(e.points=b);null!==c&&(e.timesLow=c);null!==d&&(e.timesHigh=d);null!==f&&(e.bestGameStats=f);null!==a&&(e.totalGameStats=a);return e};
