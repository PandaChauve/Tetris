var css=localStorage.getItem("dynamic_css_content");if(css){document.getElementById("switchableTheme").innerHTML=css;var element=document.getElementById("switchableThemeCss");element.parentNode.removeChild(element)}angular.module("angularApp.base",["cgNotify"]);angular.module("angularApp.factories",["angularApp.base"]);angular.module("angularApp.controllers",["ui.bootstrap","angularApp.factories"]);angular.module("angularApp.directives",["ngTouch","angularApp.base","angularApp.factories"]);var fack="FACK";var angularApp=angular.module("angularApp",["ngRoute","angularApp.base","angularApp.factories","angularApp.controllers","angularApp.directives"]);angularApp.config(["$compileProvider",function(a){"use strict";a.debugInfoEnabled(false)}]);angularApp.filter("ticToTime",["helpers",function(a){"use strict";return a.timeFromTics}]);angularApp.config(["$routeProvider","$locationProvider",function(a,b){a.when("/scores/",{templateUrl:"resources/templates/scores.html",controller:"ScoresCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/achievements/",{templateUrl:"resources/templates/user/achievements.html",controller:"AchievementsCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/achievements/:userName",{templateUrl:"resources/templates/user/achievements.html",controller:"AchievementsCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/rules/",{templateUrl:"resources/templates/rules.html",controller:"RulesCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/game/:hash/",{templateUrl:"resources/templates/game.html",controller:"GameCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/",{templateUrl:"resources/templates/campaign.html",controller:"GenericCampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/:campaignName/",{templateUrl:"resources/templates/campaign.html",controller:"GenericCampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/campaign/:campaignName/:subCampaignId/",{templateUrl:"resources/templates/campaign.html",controller:"GenericCampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/tetrisCampaign/",{templateUrl:"resources/templates/tetrisCampaign.html",controller:"tetrisCampaignCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/stats/",{templateUrl:"resources/templates/user/stats.html",controller:"StatCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/stats/:userName/",{templateUrl:"resources/templates/user/stats.html",controller:"StatCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/account/",{templateUrl:"resources/templates/user/account.html",controller:"UserAccountCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/style/",{templateUrl:"resources/templates/user/style.html",controller:"UserConfigCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/machine/config/",{templateUrl:"resources/templates/user/config.html",controller:"ComputerConfigCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/about/",{templateUrl:"resources/templates/about.html",controller:"AboutCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/user/recovery/",{templateUrl:"resources/templates/user/passwordRecovery.html",controller:"PasswordRecoveryCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/newpassword/",{templateUrl:"resources/templates/user/newpassword.html",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/devices/",{templateUrl:"resources/templates/devices.html",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}}).when("/",{templateUrl:"resources/templates/index.html",controller:"IndexCtrl",resolve:{user:["userAccount",function(a){"use strict";return a.start()}]}});b.html5Mode(false);b.hashPrefix("!")}]);angularApp.run(["notify",function(a){"use strict";a.config({templateUrl:"resources/templates/notification.html",duration:5e3})}]); angular.module("angularApp.controllers").controller("IndexCtrl",["$scope","$modal","userAccount",function(a,b,c){"use strict";a.registered=c.username!==null;a.username=c.username;a.loginPopup=function(){b.open({animation:true,templateUrl:"resources/templates/user/login.html",controller:"LoginFormCtrl",size:400})}}]); angular.module("angularApp.controllers").controller("AboutCtrl",["$scope","$anchorScroll","$location",function(a,b,c){"use strict";a.gotoAnchor=function(a){var d=a;if(c.hash()!==d){c.hash(a)}else{b()}}}]); angular.module("angularApp.controllers").controller("AchievementsCtrl",["$window","$scope","$routeParams","api","achievements","storage","userAccount",function(a,b,c,d,e,f,g){"use strict";b.redirect=function(){a.location.href="#!/stats/"+b.userName};var h=f;if(c.userName){d.loadExternalUser(c.userName).success(function(a){if(a.success){h=h.createTemp(a.data);b.userName=a.name;i()}else{console.log(a.message)}}).error(function(a){console.log("Failed to load data for user "+c.userid+" "+a)})}else{i();b.userName=g.username}function i(){var a=0;b.achievementsGridData=[];for(var c=0;c<e.List.Ordered.length;c+=1){b.achievementsGridData.push({Picture:"./resources/imgs/achievements/"+e.List.getName(e.List.Ordered[c])+".png",Name:e.List.getName(e.List.Ordered[c]),Success:e.isWon(e.List.Ordered[c],h),Description:e.List.getDescription(e.List.Ordered[c])});if(e.isWon(e.List.Ordered[c],h)){a+=1}}b.percentComplete=a/e.List.enumSize*100;b.ieStyle={width:b.percentComplete+"%","min-width":"2em"}}}]); angular.module("angularApp.controllers").controller("GenericCampaignCtrl",["$scope","$routeParams","$window","storage",function(a,b,c,d){"use strict";var e,f;a.startMap=function(a){c.location.href="#!/game/"+a};a.getClass=function(a,b){if(!b){return"mapNodeDisabled"}return"mapNode mapNodeActive_"+a};a.getTextClass=function(a,b){if(!b){return"mapTextNodeDisabled"}return"mapTextNode"};a.campaign=b.campaignName||"tutorial";var g=b.subCampaignId||1;h();function h(){a.maps=[];a.title="";switch(a.campaign){case"challenges":a.title="Challenges";a.maps.push({name:CryptoJS.MD5("campaign/puzzle/puzzle_1"),active:true});for(e=2;e<11;e+=1){a.maps.push({name:CryptoJS.MD5("campaign/puzzle/puzzle_"+e),active:d.get("UserMapcampaign/puzzle/puzzle_"+(e-1))})}break;case"timelimit":a.title="Time Limit";a.maps.push({name:CryptoJS.MD5("campaign/timeLimit/timelimit_1"),active:true});for(e=2;e<11;e+=1){a.maps.push({name:CryptoJS.MD5("campaign/timeLimit/timelimit_"+e),active:d.get("UserMapcampaign/timeLimit/timelimit_"+(e-1))})}break;case"tetris":a.title="Tetris Attack - "+g;e=g;f=1;a.maps.push({name:CryptoJS.MD5("campaign/tetrisAttack/"+e+"/ta_"+e+"_"+f),active:e==1||d.get("UserMapcampaign/tetrisAttack/"+(e-1)+"/ta_"+(e-1)+"_10")});for(f=2;f<11;f+=1){a.maps.push({name:CryptoJS.MD5("campaign/tetrisAttack/"+e+"/ta_"+e+"_"+f),active:d.get("UserMapcampaign/tetrisAttack/"+e+"/ta_"+e+"_"+(f-1))})}break;default:a.title="Tutorial";a.maps.push({name:CryptoJS.MD5("campaign/arcade/arcade_1"),active:true});for(e=2;e<11;e+=1){a.maps.push({name:CryptoJS.MD5("campaign/arcade/arcade_"+e),active:d.get("UserMapcampaign/arcade/arcade_"+(e-1))})}break}}}]); angular.module("angularApp.controllers").controller("HeaderCtrl",["$scope","$location",function(a,b){"use strict";a.isActive=function(a){return a===b.path()}}]); angular.module("angularApp.controllers").controller("ObjectivesModalCtrl",["$scope","$modalInstance","stateChecker","gameName","gameConfig",function(a,b,c,d,e){"use strict";a.continue=function(){b.close()};a.rules=c.createRuleSet(e.victory);a.tips=e.tooltip;a.title=f();function f(){var a=d.split("/");a=a[a.length-1];a=a.replace("_"," ");a=a.replace("_"," ");a=a.replace("ta","Tetris Attack - ");a=a[0].toUpperCase()+a.slice(1)+"/10";return a}}]); angular.module("angularApp.controllers").controller("RulesCtrl",["$scope","$anchorScroll","$location",function(a,b,c){"use strict";a.gotoAnchor=function(a){var d=a;if(c.hash()!==d){c.hash(a)}else{b()}}}]); angular.module("angularApp.controllers").controller("ScoresCtrl",["$scope","$http","$timeout","userAccount","api",function(a,b,c,d,e){"use strict";var f=15;a.pagination={current:1,pages:[1],last:1,paginate:function(a){this.current=a;g()}};function g(){a.scoreGridData=i.slice((a.pagination.current-1)*f,a.pagination.current*f)}function h(){a.pagination.current=1;if(i.length<=f){a.pagination.pages=[1];a.pagination.last=1}else{var b=Math.ceil(i.length/f);a.pagination.pages=[];for(var c=0;c<b;c++){a.pagination.pages.push(c+1)}a.pagination.last=b}g()}a.activate=function(b){a.type=b;a.getScores(b)};a.isActive=function(b){return b===a.type};a.currentName=d.username;a.isUser=function(b){return b===a.currentName};var i;a.userScores=[];a.getScores=function(b){e.getScores(b).success(function(b){a.userScores=[];for(var c=0;c<b.length;c++){b[c].position=c+1;if(b[c].name===a.currentName){a.userScores.push(b[c])}}i=b;h()}).error(function(a){console.log(a)})};a.scoreTypes=[{type:"classic",name:"Classic"},{type:"small",name:"Narrow"},{type:"ultralarge",name:"Wide"},{type:"sandbox",name:"Sandbox"}];a.activate("classic")}]); angular.module("angularApp.controllers").controller("StatCtrl",["$window","$scope","$routeParams","userStats","gameStatsFactory","storage","api","userAccount",function(a,b,c,d,e,f,g,h){"use strict";b.redirect=function(){a.location.href="#!/achievements/"+b.userName};var i=f;if(c.userName){g.loadExternalUser(c.userName).success(function(a){if(a.success){i=i.createTemp(a.data);b.userName=a.name;j()}else{console.log(a.message)}}).error(function(a){console.log("Failed to load data for user "+c.userid+" "+a)})}else{j();b.userName=h.username}function j(){b.isPositive=function(a){return a>0};b.isActive=function(a){return a===b.data.active};b.activate=function(a){b.data.active=a};var a=function f(a){a.best=d.getBestGameStats(a.link,i);a.sum=d.getTotalGameStats(a.link,i);return a};var c=function g(){var a;var c={name:"Overall",link:""};c.best=e.newGameStats();c.sum=e.newGameStats();for(a=0;a<b.data.maps.length;a+=1){c.best.keepBest(b.data.maps[a].best);c.sum.append(b.data.maps[a].sum)}return c};b.data={active:"Classic"};b.data.maps=[];b.data.maps.push(a({name:"Classic",link:"classic"}));b.data.maps.push(a({name:"Narrow",link:"small"}));b.data.maps.push(a({name:"Wide",link:"ultralarge"}));b.data.maps.push(a({name:"SandBox",link:"sandbox"}));b.data.maps.push(a({name:"Coop",link:"ultralargecoop"}));b.data.maps.push(c())}}]); angular.module("angularApp.controllers").controller("tetrisCampaignCtrl",["$scope","$routeParams","$window","storage",function(a,b,c,d){"use strict";a.startCampaign=function(a){c.location.href="#!/campaign/tetris/"+a};e();function e(){a.campaigns=[{link:"1",active:true}];for(var b=2;b<7;b+=1){a.campaigns.push({link:b,active:d.get("UserMapcampaign/tetrisAttack/"+(b-1)+"/ta_"+(b-1)+"_10")})}}}]); angular.module("angularApp.factories").factory("achievements",["$rootScope","storage","TIC_PER_SEC","SEC_PER_MIN","userStats","notify",function a(b,c,d,e,f,g){"use strict";function h(a){if(a===undefined){a=c}var b=a.get(c.Keys.Achievements)||[];for(var d=b.length;d<i.List.enumSize;d+=1){b[d]=false}return b}function i(){}i.prototype.isWon=function(a,b){return h(b)[a]};i.prototype.check=function(a,d){var e=false;var f=h();for(var j=0;j<i.List.enumSize;j+=1){if(!f[j]){this.checkIndividual(j,a,d,f);if(f[j]){e=true;var k=b.$new(true);k.picture={src:"./resources/imgs/achievements/"+i.List.getName(j)+".png",alt:"Success !"};g({message:"New Success: "+i.List.getName(j),scope:k})}}}if(e){c.set(c.Keys.Achievements,f)}};i.prototype.keyToScore=function(a){switch(a){case i.List.Beginner:return 60;case i.List.Expert:return 160;case i.List.Master:return 300;case i.List.God:case i.List.XXS:case i.List.XXL:return 500;case i.List.Titan:case i.List.SuperTeam:case i.List.Cheater:return 1e3}throw"What are you doing here ?"};i.prototype.checkMultiLines=function(a,b){var c=0;switch(a){case i.List.Ambidextrous:c=0;break;case i.List.Psychic:c=1;break;case i.List.Sorcerer:c=2;break;default:throw"What are you doing here ?"}for(;c<b.multilines.length;c+=1){if(b.multilines[c]){return true}}return false};i.prototype.keyToMap=function(a){switch(a){case i.List.Nostalgic:return"campaign/tetrisAttack/1/ta_1_10";case i.List.RetroGamer:return"campaign/tetrisAttack/3/ta_3_10";case i.List.Dinosaur:return"campaign/tetrisAttack/6/ta_6_10";case i.List.Flash:return"campaign/timeLimit/timelimit_10";case i.List.Pacman:return"campaign/arcade/arcade_10";case i.List.Sherlock:return"campaign/puzzle/puzzle_10"}};i.prototype.checkIndividual=function(a,b,g,h){switch(a){case i.List.Beginner:case i.List.Expert:case i.List.Master:case i.List.God:case i.List.Titan:if(g==="classic"){h[a]=b.score>=this.keyToScore(a)}break;case i.List.Cheater:if(g==="sandbox"){h[a]=b.score>=this.keyToScore(a)}break;case i.List.XXL:if(g==="ultralarge"){h[a]=b.score>=this.keyToScore(a)}break;case i.List.XXS:if(g==="small"){h[a]=b.score>=this.keyToScore(a)}break;case i.List.SuperTeam:if(g==="ultralargecoop"){h[a]=b.score>=this.keyToScore(a)}break;case i.List.Destroyer:h[a]=f.getTotalGameStats(g).blockDestroyed>=3e4;break;case i.List.Restless:h[a]=f.getTotalGameStats(g).swapCount>=2e4;break;case i.List.Veteran:h[a]=f.getTotalGameStats(g).gameCount>99;break;case i.List.Ambidextrous:case i.List.Psychic:case i.List.Sorcerer:h[a]=this.checkMultiLines(a,b);break;case i.List.Stubborn:h[a]=f.getTotalGameStats(g).time>d*e*30;break;case i.List.Tenacious:h[a]=f.getTotalGameStats(g).time>d*e*180;break;case i.List.BiggerIsBetter:for(var j=3;j<b.lineSizes.length;j+=1){if(b.lineSizes[j]){h[a]=true;break}}break;case i.List.Nostalgic:case i.List.RetroGamer:case i.List.Dinosaur:case i.List.Flash:case i.List.Pacman:case i.List.Sherlock:h[a]=c.get(c.MKeys.UserMap+this.keyToMap(a));break}};i.List={Beginner:0,Expert:1,Master:2,God:3,Titan:4,Cheater:5,Ambidextrous:6,Psychic:7,Sorcerer:8,Stubborn:9,BiggerIsBetter:10,Nostalgic:11,RetroGamer:12,Dinosaur:13,Flash:14,Pacman:15,Sherlock:16,Tenacious:17,XXL:18,XXS:19,SuperTeam:20,Destroyer:21,Restless:22,Veteran:23,enumSize:24};i.List.Ordered=[i.List.Beginner,i.List.Expert,i.List.Master,i.List.God,i.List.Titan,i.List.XXL,i.List.XXS,i.List.Cheater,i.List.SuperTeam,i.List.Ambidextrous,i.List.Psychic,i.List.Sorcerer,i.List.BiggerIsBetter,i.List.Nostalgic,i.List.RetroGamer,i.List.Dinosaur,i.List.Flash,i.List.Pacman,i.List.Sherlock,i.List.Destroyer,i.List.Stubborn,i.List.Tenacious,i.List.Restless,i.List.Veteran];i.List.getName=function(a){for(var b in i.List){if(i.List[b]===a){return b}}return""};i.List.getDescription=function(a){switch(a){case i.List.Beginner:return"Get 60 points in classic";case i.List.Expert:return"Get 160 points in classic";case i.List.Master:return"Get 300 points in classic";case i.List.God:return"Get 500 points in classic";case i.List.XXL:return"Get 500 points in wide";case i.List.XXS:return"Get 500 points in narrow";case i.List.SuperTeam:return"Get 1000 points in coop";case i.List.Titan:return"As good as the game master, the mighty Panda !";case i.List.Cheater:return"Get 1000 points in sandbox";case i.List.Ambidextrous:return"Get 2 series at once in any game mode";case i.List.Psychic:return"Get 3 series at once in any game mode";case i.List.Sorcerer:return"Get 4 series at once in any game mode";case i.List.Stubborn:return"Play for 30 minutes in any game mode";case i.List.Tenacious:return"Play for 3 hours in any game mode";case i.List.BiggerIsBetter:return"Create a line of 6 blocks in any game mode";case i.List.Nostalgic:return"Finish the first Tetris Attack campaign";case i.List.RetroGamer:return"Finish the third Tetris Attack campaign";case i.List.Dinosaur:return"Finish the last Tetris Attack campaign";case i.List.Flash:return"Finish the time attack campaign";case i.List.Pacman:return"Finish the tutorial campaign";case i.List.Sherlock:return"Finish the challenge campaign";case i.List.Destroyer:return"Destroy 30000 blocks in any game mode";case i.List.Restless:return"Swap 20000 pairs of blocks in any game mode";case i.List.Veteran:return"100 games in any game mode"}return""};i.prototype.List=i.List;return new i}]); angular.module("angularApp.factories").factory("api",["$http",function a(b){"use strict";var c="http://whenwillyoulose.com:1337/wwylApi/";function d(){}d.prototype.addScore=function(a,d,e,f){var g=d*17+"_";var h=0;for(var i=0;i<g.length-1;i++){h+=+g.charAt(i)}g+=h;return b.post(c+"scores",{score:g,user:a,map:e,duration:f})};d.prototype.getScores=function(a){return b.get(c+"scores/"+a)};d.prototype.resetPassword=function e(a){return b.get(c+"user/reset/"+a)};d.prototype.getTheme=function(a){return b.get("resources/bootswatch/"+a+".min.css",{cache:true})};d.prototype.updateUser=function(a,d,e,f,g,h){if(!g){g=null}if(a<0){throw"not registered"}return b.put(c+"users/"+a+"/"+d,{data:e,name:f,password:g,email:h})};d.prototype.createUser=function(a,d){return b.post(c+"users",{userName:a,password:d})};d.prototype.loadUser=function(a,d){return b.post(c+"users/validate",{name:a,password:d})};d.prototype.loadUserId=function(a,d){return b.get(c+"users/"+a+"/"+d)};d.prototype.loadExternalUser=function(a){return b.get(c+"users/"+a)};return new d}]); angular.module("angularApp.factories").factory("audio",["systemConfig",function a(b){"use strict";var c=document.createElement("audio");var d=Object.prototype.toString.call(c)!=="[object HTMLUnknownElement]";var e="wav";if(d&&c.canPlayType("audio/mpeg;"))e="mp3";function f(){if(!d)return;this.audiochannels=[];this.ext=e;this.preload();this.play=function(){}}f.prototype.preload=function(){if(!b.get(b.Keys.sound)||!d){return}var a=[];var c;for(var e in f.ESounds){if(f.ESounds.hasOwnProperty(e)){c=new Audio;c.src=f.ESounds[e].path+this.ext;c.oncanplaythrough=function(){console.log("audio loaded : "+this.src)};a.push(c)}}return a};f.prototype.resetConfig=function(){this.play=g.playFactory(b.get(b.Keys.sound))};f.prototype.playFactory=function h(a){if(!a||!d){return function(){}}else{return function(a){var b=new Date;for(var c=0;c<this.audiochannels.length;c+=1){if(this.audiochannels[c].endTime<b.getTime()){this.audiochannels[c].endTime=b.getTime()+a.duration;this.audiochannels[c].channel.src=a.path+this.ext;this.audiochannels[c].volume=.1;this.audiochannels[c].channel.load();this.audiochannels[c].channel.play();return}}var d={endTime:-1,channel:new Audio};d.endTime=b.getTime()+a.duration;d.channel.src=a.path+this.ext;d.channel.volume=.1;d.channel.load();d.channel.play();this.audiochannels.push(d)}}};f.ESounds={swap:{path:"resources/audio/jump.",duration:1e3},score:{path:"resources/audio/pop.",duration:1e3},end:{path:"resources/audio/shotgun.",duration:2e3}};f.prototype.ESounds=f.ESounds;var g=new f;g.resetConfig();return g}]); angular.module("angularApp.factories").factory("blockFactory",[function a(){"use strict";function a(){this.reset=function(){this.type=a.EType.Random();this.group=-1;this.state=a.EState.Blocked;this.verticalPosition=0;this.animationState=0;this.id=-1;this.threeObject=null;this.wasFalling=false};this.reset()}a.prototype.clone=function(){var b=new a;b.loadFrom(this);return b};a.prototype.loadFrom=function(a){this.type=a.type;this.group=a.group;this.state=a.state;this.verticalPosition=a.verticalPosition;this.animationState=a.animationState;this.id=a.id;this.threeObject=a.threeObject;this.wasFalling=a.wasFalling};a.prototype.setState=function(a){this.state=a;this.animationState=0};a.EState={Blocked:1,Falling:2,Disappearing:3,SwappedLeft:4,SwappedRight:5};a.EType={Purple:0,Red:1,Green:2,Blue:3,Grey:4,Orange:5,PlaceHolder:6,Random:function(){return Math.floor(Math.random()*a.EType.PlaceHolder)}};var b=[];return{releaseBlock:function(a){a.reset();b.push(a)},newBlock:function(){if(b.length==0){return new a}return b.pop()},cloneBlock:function(a){var b=this.newBlock();b.loadFrom(a);return b},EState:a.EState,EType:a.EType}}]); angular.module("angularApp.controllers").controller("ComputerConfigCtrl",["$scope","systemConfig","audio",function(a,b,c){"use strict";a.keys=b.Keys;a.data={antialiasing:b.get(b.Keys.antialiasing),lowtexture:b.get(b.Keys.useLambertMaterial),lowRez:b.get(b.Keys.cssScaling),score:b.get(b.Keys.scores),sound:b.get(b.Keys.sound),explosion:b.get(b.Keys.explosions),fps:b.get(b.Keys.fps),zoom:b.get(b.Keys.zoom),touchAndSlide:b.get(b.Keys.touchAndSlide)};a.updateCheckBox=function(a,d){b.set(a,!d);if(a===b.Keys.sound){c.resetConfig()}}}]); angular.module("angularApp.base").constant("TIC_PER_SEC",60).constant("SEC_PER_MIN",60).constant("EGameActions",{swap:0,down:1,up:2,left:3,right:4,speed:5});angular.module("angularApp.base").constant("map_hash",{f3d64714d1f6e7f71558d4252e84ab58:"classic","3ac54247ae527401610035b749cdbab6":"classicSplitScreen","93bc63e0b4f48fbbff568d9fc0dc3def":"sandbox",eb5c1399a871211c7e7ed732d15e3a8b:"small","38e0a50734a85ca916efedc8c4cd819d":"ultralarge","2add86b8e4cc3c18cecd3a6c5ad1208e":"ultralargecoop","78b492e07c9a2b6a3224f9de0cfe5b28":"campaign/timeLimit/timelimit_1","38b79c7ebcbd17a9e674ff880f88bbdb":"campaign/timeLimit/timelimit_10","6d3c0d9208fbafc6b33dbf3abba19284":"campaign/timeLimit/timelimit_2",c2b145c6633faab5814183199d0a6404:"campaign/timeLimit/timelimit_3","7cc06532e5ced726445c9c8b1d8d372f":"campaign/timeLimit/timelimit_4",c77ef72bc3c86d536ac159baf0236913:"campaign/timeLimit/timelimit_5","9650c3dd48f540961c33ad3e04654e79":"campaign/timeLimit/timelimit_6",a3b6f701dc6a487b2a92a9558c1617bb:"campaign/timeLimit/timelimit_7","8be886dc641752884f204f7ac0e159d9":"campaign/timeLimit/timelimit_8",d5d146f59734e7a929c5681109637af3:"campaign/timeLimit/timelimit_9","8e55c75c7d15ce306f716bdc894c5f58":"campaign/tetrisAttack/6/ta_6_1",bed3550cb8df5e0bf1b5d9423460148e:"campaign/tetrisAttack/6/ta_6_10","7bdc879c8891874cf602e2e2066aacdb":"campaign/tetrisAttack/6/ta_6_2","54d5dc20d87a4c6e98cabb2aa1747cb9":"campaign/tetrisAttack/6/ta_6_3","3a25ea10bf65ef43dc05bfffdc5ebb7d":"campaign/tetrisAttack/6/ta_6_4","2beee8ddc0cbe335545963e20ce02b78":"campaign/tetrisAttack/6/ta_6_5","129c89be922be02d993278d85ff79812":"campaign/tetrisAttack/6/ta_6_6","6d5af8bdce1b53faf99a8c5b0f3551c9":"campaign/tetrisAttack/6/ta_6_7",b43c447303d1200988e300209eb4bc93:"campaign/tetrisAttack/6/ta_6_8",c2f31eb57d42ee41e6e232639d87d00d:"campaign/tetrisAttack/6/ta_6_9","9dfdb85697930b7372a30611bb64dc57":"campaign/tetrisAttack/5/ta_5_1","0736d757eb48cf8957affe299d13648b":"campaign/tetrisAttack/5/ta_5_10","3a42c883fd263646b78cd142c691bdfc":"campaign/tetrisAttack/5/ta_5_2","394b85abe3ad1ab43755c920ddd79d11":"campaign/tetrisAttack/5/ta_5_3",af84d0dac1bcd10ab32d50525328eee5:"campaign/tetrisAttack/5/ta_5_4","97ee90ce501209a74525c36c2d85b1ec":"campaign/tetrisAttack/5/ta_5_5","5f79a4e33c0e1dc8b7cea53f50b1585f":"campaign/tetrisAttack/5/ta_5_6","6d98c092a62899a5f4d602438173f285":"campaign/tetrisAttack/5/ta_5_7",b5ad8d5c212b3da65b372e4f8dd95bd0:"campaign/tetrisAttack/5/ta_5_8",e31191acb39b955025c8dee1f11d3ba7:"campaign/tetrisAttack/5/ta_5_9",c94b9572ba4574c892cc39a673748e2b:"campaign/tetrisAttack/4/ta_4_1",fdd83e66c151241ca0486be1a706d005:"campaign/tetrisAttack/4/ta_4_10","0a2ca08b217c8df5df9f8f7398dd5a0f":"campaign/tetrisAttack/4/ta_4_2",dfa7147034cdfa6532275d5c5c025ea7:"campaign/tetrisAttack/4/ta_4_3","143eb12f3556f63f3fcf897448572885":"campaign/tetrisAttack/4/ta_4_4","2919abae61b027e9115e22117ef920f1":"campaign/tetrisAttack/4/ta_4_5",ea1db9b12ec7451ec59dfc7ba2b8655a:"campaign/tetrisAttack/4/ta_4_6","7d8ae77d235edf7d3fbc9c777d34edff":"campaign/tetrisAttack/4/ta_4_7",a830ce20f2c44f35c7efbc72422378c6:"campaign/tetrisAttack/4/ta_4_8",b87028628a45fbefffc1b94b69eadedd:"campaign/tetrisAttack/4/ta_4_9",af5426a81a7b0c5759d7bb4f345fef66:"campaign/tetrisAttack/3/ta_3_1","35ce0db306d24c6b5982435b6a579088":"campaign/tetrisAttack/3/ta_3_10","328ae6e4f93e64334638456a4cbd3a06":"campaign/tetrisAttack/3/ta_3_2",c39ad8c2fed1989378fd992832d5c1c5:"campaign/tetrisAttack/3/ta_3_3","2f664813c49bb8f3d3b837ffdcba90f1":"campaign/tetrisAttack/3/ta_3_4","429438aabe1686c76d3a2ffde5dfd9a4":"campaign/tetrisAttack/3/ta_3_5","589d6f396b4d1345755d3ffc0ca15f22":"campaign/tetrisAttack/3/ta_3_6","3a3c62f1d4bb4762c5f573acdaabc2b0":"campaign/tetrisAttack/3/ta_3_7",c847d520e5db0ccbe0d9be0922ab169f:"campaign/tetrisAttack/3/ta_3_8",ccb49e3158250c0da3b67f82e6b0a8da:"campaign/tetrisAttack/3/ta_3_9","1e12b4f7ffa17f3252901b70616e8905":"campaign/tetrisAttack/2/ta_2_1","420d72fd40ac1f4df1955d5189c3164b":"campaign/tetrisAttack/2/ta_2_10","31c0ef9e8354dac1274cca8bfa76b400":"campaign/tetrisAttack/2/ta_2_2","2025f73a997ea208a713649e6bac0a8d":"campaign/tetrisAttack/2/ta_2_3","145194ff03749bddc1656054e9848c82":"campaign/tetrisAttack/2/ta_2_4","4c82a7826e97543c22cfeab6a7deb593":"campaign/tetrisAttack/2/ta_2_5","82f87eaa3ff484f3d9ca35e4b9d13f3e":"campaign/tetrisAttack/2/ta_2_6",bcc8770ca51acbae4d1a10760f576aa7:"campaign/tetrisAttack/2/ta_2_7","4ac0c1077c320cb5bcd99d3180cc5f74":"campaign/tetrisAttack/2/ta_2_8","7b77b24b5f24a5462bf6c3e38bacbb59":"campaign/tetrisAttack/2/ta_2_9",bbc1b0f4e6044533af390fd4ed8686fb:"campaign/tetrisAttack/1/ta_1_1",e71c6d4f173ef6847f21c7de8971b9bb:"campaign/tetrisAttack/1/ta_1_10","349e57daad8e7a49adc9b180638bd44f":"campaign/tetrisAttack/1/ta_1_2","29275abde51d7a4d5d849411ba619e79":"campaign/tetrisAttack/1/ta_1_3","0bcc479eabe1fc77f0b175a137e02837":"campaign/tetrisAttack/1/ta_1_4","1a21dad13cafd1b724ccca2bb31b27a9":"campaign/tetrisAttack/1/ta_1_5",e1231bb1330ab48ee35dda100161a9e5:"campaign/tetrisAttack/1/ta_1_6",ad960e97f0f2370173b86b70575eca87:"campaign/tetrisAttack/1/ta_1_7",e93a1b76159aec2ed94c6ef75f465ce1:"campaign/tetrisAttack/1/ta_1_8","669e64124b28b6c748cf0173457135b5":"campaign/tetrisAttack/1/ta_1_9",ab6f418a2e0607cb488f7499981215d4:"campaign/puzzle/puzzle_1",cc5fbbd28a282761cc20f3f0b345ef51:"campaign/puzzle/puzzle_10","090c08f5bd14d49adc73ae947142bc79":"campaign/puzzle/puzzle_2",f98f59378760c53236be72914517a510:"campaign/puzzle/puzzle_3","9b15e6c59843c92810b1621831e117ee":"campaign/puzzle/puzzle_4",f5b6b9ff7859cdbed3a185b305ac43d9:"campaign/puzzle/puzzle_5",ee17a9619c7056eb88da4c506c177e76:"campaign/puzzle/puzzle_6",e6be5107ea1935870b8fbecc5d7a3a92:"campaign/puzzle/puzzle_7","7f923267fb3c0a87c6398f72d9642317":"campaign/puzzle/puzzle_8",a94b3157be95a56b46d34516e0e42777:"campaign/puzzle/puzzle_9",d2652ac1d0de107460e4d06e5e5e864d:"campaign/arcade/arcade_1",eacf1fc992485bbd48a934758c7a9ba6:"campaign/arcade/arcade_10","0be0c4c3d1ea6eccbbc537804802a6db":"campaign/arcade/arcade_2","0cfcfdaff103f2815bce39307d95ca6d":"campaign/arcade/arcade_3","5ae2d2faa749fe48a6e0e73ed704286e":"campaign/arcade/arcade_4","351f7c939eda4865c75ce31575e65888":"campaign/arcade/arcade_5","4267466af1df978832097565a13269b7":"campaign/arcade/arcade_6","7ab1925a5fbba6f350feef725ee01300":"campaign/arcade/arcade_7",d9d3e4aa93ee4a51ae92a83f52bf4603:"campaign/arcade/arcade_8",ef5854730828db3e8592dfe8785b0851:"campaign/arcade/arcade_9"}); angular.module("angularApp.factories").factory("cubeRenderElementFactory",["gameConstants","blockFactory","storage","systemConfig",function a(b,c,d,e){"use strict";function f(){this.cube=null;this.textures={};this.colors=[];this.cache={0:[],1:[],2:[],3:[],4:[],5:[],6:[]};this.hexColors=d.get(d.Keys.HexKeyColors)||[128,20480,4210752,6295568,10239491,2628162]}f.prototype.getHexColor=function l(a){return this.hexColors[a]};f.prototype.getColor=function m(a){if(!this.colors[a]){this.colors[a]=new THREE.Color(this.getHexColor(a))}return this.colors[a]};f.prototype.updateCubeDisplay=function n(a){var b=a.threeObject;if(a.type!=b.customColor){b.material.color=this.getColor(a.type);b.customColor=a.type}if(a.state===c.EState.Disappearing){var d=1/(1+a.animationState*a.animationState*a.animationState/1e5);b.scale.set(d,d,d)}};f.prototype.createTexture=function(a){if(!this.textures[a]){if(e.get(e.Keys.useLambertMaterial)){this.textures[a]=new THREE.MeshLambertMaterial({color:this.getHexColor(a),emissive:this.getHexColor(a)})}else{this.textures[a]=new THREE.MeshPhongMaterial({color:this.getHexColor(a),emissive:this.getHexColor(a)})}}return this.textures[a]};f.prototype.createGeometry=function(a){if(!this.cube){var c=b.pixelPerBox*.7;this.cube=new THREE.BoxGeometry(c,c,b.pixelPerBox/5);this.cube.center()}return this.cube};f.prototype.releaseCube=function(a){a.scale.set(1,1,1);this.cache[a.customColor].push(a)};f.prototype.createCube=function(a){if(this.cache[a].length>0){return this.cache[a].pop()}var b=new THREE.Mesh(this.createGeometry(a),this.createTexture(a));b.customObject=true;b.customColor=a;return b};function g(a){f.call(this)}g.prototype=new f;g.prototype.createGeometry=function(a){if(!this.cube){this.cube=new THREE.CylinderGeometry(b.pixelPerBox/2,b.pixelPerBox/3,b.pixelPerBox*.8,16)}return this.cube};function h(){f.call(this)}h.prototype=new f;h.prototype.createGeometry=function(a){if(!this.cube){var b=[];for(var c=0;c<50;c++){b.push(new THREE.Vector3(Math.sin(c*.2)*Math.sin(c*.1)*5.5+15,(c-5)*.7))}this.cube=new THREE.LatheGeometry(b);this.cube.rotateX(Math.PI/2)}this.cube.center();return this.cube};h.prototype.createCube=function(a){if(this.cache[a].length>0){return this.cache[a].pop()}var b=f.prototype.createCube.call(this,a);b.rotation.x=1.6;return b};function i(a){f.call(this);this.divisions=a}i.prototype=new f;i.prototype.createGeometry=function(a){if(!this.cube){var c=b.pixelPerBox*(this.divisions==0?.7:1);this.cube=new THREE.BoxGeometry(c,c,b.pixelPerBox/5);var d=new THREE.SubdivisionModifier(this.divisions);d.modify(this.cube)}return this.cube};function j(){f.call(this);this.cubes={}}j.prototype=new f;j.prototype.createGeometry=function(a){if(!this.cubes[a]){var c=b.pixelPerBox*(a%3?1:.7);this.cubes[a]=new THREE.BoxGeometry(c,c,b.pixelPerBox/5);var d=new THREE.SubdivisionModifier(a%3);d.modify(this.cubes[a])}return this.cubes[a]};function k(){f.call(this);this.cubes={}}k.prototype=new f;k.prototype.updateCubeDisplay=function o(a){var b=a.threeObject.geometry.attributes.size.array;var c=Date.now()*.005;for(var d=0;d<b.length;d++){b[d]=17+17*Math.sin(.1*d+c)}a.threeObject.geometry.attributes.size.needsUpdate=true};k.prototype.releaseCube=function(a){this.cache[a.customColor].push(a)};k.prototype.createCube=function(a){function c(a){var c=300;var d=new Float32Array(c*3);var e=new Float32Array(c*3);var f=new Float32Array(c);var g=new THREE.Vector3;for(var h=0;h<c;h++){g.x=Math.random()-.5;g.y=Math.random()-.5;g.z=Math.random()-.5;g.multiplyScalar(b.pixelPerBox*.7);g.toArray(d,h*3);a.toArray(e,h*3);f[h]=17}var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(d,3));i.addAttribute("customColor",new THREE.BufferAttribute(e,3));i.addAttribute("size",new THREE.BufferAttribute(f,1));return i}function d(){return new THREE.ShaderMaterial({uniforms:{amplitude:{value:1},color:{value:new THREE.Color(16777215)},texture:{value:(new THREE.TextureLoader).load("resources/imgs/spark.png")}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:false,transparent:true})}if(this.cache[a].length>0){return this.cache[a].pop()}if(!this.cubes[a]){var e=d();var f=c(this.getColor(a));this.cubes[a]=new THREE.Points(f,e)}var g=this.cubes[a].clone();g.customObject=true;g.customColor=a;return g};return{createFactory:function p(a){switch(a){case 0:return new f;case 1:case 2:case 3:case 4:return new i(a-1);case 5:return new j;case 6:return new k;case 7:return new g;case 8:return new h}return new f}}}]); angular.module("angularApp.controllers").controller("ModalInstanceCtrl",["$scope","$modalInstance","gameName","userStats","stateChecker","helpers","audio","TIC_PER_SEC",function(a,b,c,d,e,f,g,h){"use strict";a.isCampaign=c.indexOf("campaign")>-1;g.play(g.ESounds.end);a.won=e.victory(0);a.published=false;a.nextGame=function(){b.close()};a.stop=function(){b.dismiss("cancel")};a.stats=function(){function a(a,b,c){if(c===undefined){c=Math.floor}return c(a/b)}var b=d.getBestGameStats(c);var e=d.getTotalGameStats(c);var g=d.getCurrentGame();var h=[];h.push({name:"Score",value:g.score,best:b.score,sum:e.score,mean:a(e.score,e.gameCount)});h.push({name:"Time",value:f.timeFromTics(g.time),best:f.timeFromTics(b.time),sum:f.timeFromTics(e.time),mean:a(e.time,e.gameCount,f.timeFromTics)});h.push({name:"Blocks",value:g.blockDestroyed,best:b.blockDestroyed,sum:e.blockDestroyed,mean:a(e.blockDestroyed,e.gameCount)});h.push({name:"Swaps",value:g.swapCount,best:b.swapCount,sum:e.swapCount,mean:a(e.swapCount,e.gameCount)});h.push({name:"Apm",value:Math.floor(g.apm),best:Math.floor(b.apm),sum:"/",mean:Math.floor(e.apm)});h.push({name:"Efficiency",value:g.efficiency.toFixed(2),best:b.efficiency.toFixed(2),sum:"/",mean:e.efficiency.toFixed(2)});return h}()}]); angular.module("angularApp.factories").factory("game",["userInput","userStats","stateChecker","threeRendererFactory","tetrisFactory","TIC_PER_SEC","storage","systemConfig",function a(b,c,d,e,f,g,h,i){"use strict";function j(){this.scoreList=[[],[],[],[]];this.addTics=function(){for(var a=0;a<this.scoreList.length;a+=1){for(var b=0;b<this.scoreList[a].length;b+=1){this.scoreList[a][b].opacity-=.25}}};this.addScore=function(a,b){if(a<1){return}this.scoreList[b].push({opacity:100,value:a,object:null})}}function k(){if(i.get(i.Keys.fps)){var a=new Stats;a.setMode(0);a.domElement.style.position="absolute";a.domElement.style.left="0px";a.domElement.style.top="0px";document.body.appendChild(a.domElement);return a}else{return{begin:function(){},end:function(){}}}}function l(){this.last={swaps:0,score:0,actions:0,combo:1,tics:0};this.availableGrids=[];this.gridCount=0;this.reset();this.statCounter=k()}l.prototype.setConfiguration=function(a,b,c,e){this.config=a;this.grid=b;this.scope=e;this.gridCount=this.config.tetris.length;this.checkerId=[];for(var f=0;f<this.gridCount;++f){this.checkerId.push(d.create(a.victory))}if(c===undefined){this.callback=null}else{this.callback=c}this.tryToStart()};l.prototype.reset=function(){window.cancelAnimationFrame(this.id);this.id=-1;this.started=false;this.tetris=[];this.visual=[];this.tobefixed=[1,1];this.startTime=null;this.pause=false;this.scoreHandler=new j;this.last={swaps:0,score:0,actions:0,combo:1,tics:0};this.progress=0;this.timeCounter=0};l.prototype.startNewGame=function n(){function a(a,b){for(var c=0;c<a.length;c+=1){if(a[c].id==b){return a[c].node}}}this.reset();this.started=true;c.getCurrentGame().reset();c.getCurrentGame().gameCount+=1;for(var d=0;d<this.gridCount;d+=1){this.tetris.push(f.newTetris(this.grid,this.config.tetris[d].cursors));this.visual.push(e.newRenderer(this.config.tetris[d].cursors,h.get(h.Keys.CubeTheme),this.availableGrids[0].scaleX,this.availableGrids[0].scaleY));this.visual[d].linkDom(a(this.availableGrids,d));this.visual[d].renderTetris(this.tetris[d],[])}switch(this.tetris.length){case 2:this.tetris[0].playersId=[0,2];this.tetris[1].playersId=[1,3];break;case 4:this.tetris[0].playersId=[0];this.tetris[1].playersId=[1];this.tetris[2].playersId=[2];this.tetris[3].playersId=[3];break;case 1:default:this.tetris[0].playersId=[0,1,2,3];break}b.clear();this.renderingFct=this.render.bind(this);this.id=requestAnimationFrame(this.renderingFct)};l.prototype.stopGame=function o(){this.started=false;window.cancelAnimationFrame(this.id);this.gridCount=0;for(var a=0;a<this.checkerId.length;++a)d.free(this.checkerId[a]);this.checkerId=[]};l.prototype.tryToStart=function(){if(this.started||this.gridCount>this.availableGrids.length||this.gridCount==0){return}this.startNewGame()};l.prototype.linkToDom=function p(a,b,c,d){this.availableGrids.push({id:b,node:a,scaleX:c,scaleY:d});this.tryToStart()};l.prototype.unlinkToDom=function q(a,b){this.started=false;for(var c=0;c<this.availableGrids.length;c+=1){if(this.availableGrids[c].id===b){if(this.visual[b]){this.visual[b].clear();this.visual[b]=null}this.availableGrids.splice(c,1);break}}};l.prototype.splitScreenQuickFix=function(){if(this.tetris.length===2){while(this.tobefixed[0]<this.tetris[1].getDestroyed()/3+this.tetris[1].getScore()/10){this.tobefixed[0]+=2;this.tetris[0].randomFall()}while(this.tobefixed[1]<this.tetris[0].getDestroyed()/3+this.tetris[0].getScore()/10){this.tobefixed[1]+=2;this.tetris[1].randomFall()}}};l.prototype.togglePause=function(){if(!this.started){return false}this.pause=!this.pause;if(this.pause){window.cancelAnimationFrame(this.id)}else{this.id=requestAnimationFrame(this.renderingFct);this.startTime=null}b.clear();return this.pause};l.prototype.computeTic=function(){var a;var e=-1;for(var f=0;f<this.tetris.length;f+=1){a=this.tetris[f].oneTick();if(f==0)c.getCurrentGame().addLines(a.series,a.score);d.check(this.checkerId[f],this.tetris[f]);if(d.defeat(this.checkerId[f])||d.victory(this.checkerId[f]))e=f;this.scoreHandler.addScore(a.score,f)}b.clear();if(a.score!=0||this.last.combo!=a.combo){this.last.score+=a.score;this.last.combo=a.combo}if(e!=-1){this.visual[e].freezeGame();return false}return true};var m=1e3/g;l.prototype.render=function(a){this.statCounter.begin();if(this.startTime===null){this.startTime=a-this.last.tics*m}this.progress=a-this.startTime;var b=true;while(this.timeCounter<=this.progress){b=this.computeTic();this.last.tics+=1;this.timeCounter+=m;this.scoreHandler.addTics()}this.last.swaps=this.tetris[0].getSwaps();this.last.actions=this.tetris[0].getActions();this.scope.$broadcast("newTick",this.last);if(b){for(var c=0;c<this.tetris.length;c+=1){this.visual[c].renderTetris(this.tetris[c],this.scoreHandler.scoreList[c],d.getDangerLevel(this.checkerId[c]))}this.splitScreenQuickFix();this.statCounter.end();this.id=requestAnimationFrame(this.renderingFct)}else if(this.callback!==null){this.callback(this)}};l.prototype.slide=function(a,b,c,d){if(this.tetris.length!=1){return false}return this.tetris[0].slide(a,b,c,d)};l.prototype.touchSwap=function(a,b){if(this.tetris.length!=1){return false}return this.tetris[0].touchSwap(a,b)};return new l}]); angular.module("angularApp.factories").factory("gameConstants",["TIC_PER_SEC",function a(b){"use strict";var c={};c.reset=function d(){this.columnCount=6;this.displayedRowCount=10;this.hiddenRowCount=3;this.pixelPerBox=50;this.swapPerTic=12*60/b;this.fallSpeedPerTic=8*60/b;this.disapearSpeedPerTic=3*60/b;this.groundSpeedPerTic=.02*60/b;this.groundUpSpeedPerTic=3*60/b;this.groundAccelerationPerTic=.02/b/60;this.fallPeriod=500*60/b;this.gracePeriod=60*b;this.lostThreshold=(this.displayedRowCount+this.hiddenRowCount)*this.pixelPerBox;this.startRows=this.displayedRowCount-4};c.load=function e(a){this.reset();if(a==="sandbox"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.startRows=this.displayedRowCount+this.hiddenRowCount;this.groundAccelerationPerTic=0}if(a==="sandboxSmall"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.columnCount=4;this.startRows=this.displayedRowCount+this.hiddenRowCount;this.groundAccelerationPerTic=0}else if(a==="fixed"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.groundAccelerationPerTic=0;this.groundUpSpeedPerTic=0}else if(a==="fixedLarge"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.groundAccelerationPerTic=0;this.groundUpSpeedPerTic=0;this.columnCount=10}else if(a==="fixedNarrow"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.groundAccelerationPerTic=0;this.groundUpSpeedPerTic=0;this.columnCount=4}else if(a==="large"){this.columnCount=10}else if(a==="dual"){this.gracePeriod=0;this.groundSpeedPerTic=.07*60/b}else if(a==="largeDual"){this.gracePeriod=0;this.groundSpeedPerTic=.07*60/b;this.columnCount=10}else if(a==="small"){this.columnCount=4}if(a==="puzzle_8"){this.fallPeriod=0;this.startRows=this.displayedRowCount+this.hiddenRowCount-1;this.groundAccelerationPerTic=0}else if(a==="arcade_1"){this.groundSpeedPerTic=0;this.fallPeriod=0;this.groundAccelerationPerTic=0}else if(a==="arcade_2"){this.groundSpeedPerTic=0;this.fallPeriod=300*60/b;this.gracePeriod=0;this.groundAccelerationPerTic=0}else if(a==="arcade_3"){this.groundSpeedPerTic=0;this.fallPeriod=300*60/b;this.groundAccelerationPerTic=0;this.gracePeriod=0;this.columnCount=10}else if(a==="arcade_4"){this.groundSpeedPerTic=.07*60/b;this.groundSpeedPerTic*=1.5;this.gracePeriod=0;this.fallPeriod=200*60/b}else if(a==="arcade_6"){this.groundSpeedPerTic=.07*60/b;this.groundSpeedPerTic*=1.5;this.gracePeriod=0;this.columnCount=10}else if(a==="arcade_7"){this.groundSpeedPerTic=.07*60/b;this.fallPeriod=0;this.groundAccelerationPerTic=1/100/b;this.gracePeriod=0}else if(a==="arcade_8"){this.groundSpeedPerTic=.07*60/b;this.groundAccelerationPerTic=1/100/b;this.gracePeriod=0}else if(a==="arcade_9"){this.groundSpeedPerTic=.07*60/b;this.groundAccelerationPerTic=1/100/b;this.gracePeriod=0;this.columnCount=10}else if(a==="arcade_5"){this.groundSpeedPerTic=.07*60/b;this.columnCount=4;this.gracePeriod=0}else if(a==="arcade_10"){this.groundSpeedPerTic=.07*60/b;this.fallPeriod=150*60/b;this.groundAccelerationPerTic=0;this.gracePeriod=0;this.columnCount=10}};return c}]); angular.module("angularApp.controllers").controller("GameCtrl",["$scope","$http","$route","$routeParams","$modal","$window","game","gameConstants","achievements","userStats","storage","stateChecker","userAccount","api","map_hash",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p=false;a.gameName=o[d.hash]||d.hash||"classic";var q=a.gameName.indexOf("campaign")>-1;a.config={};a.config.splitScreen=a.gameName==="classicSplitScreen"||a.gameName==="2v2";a.gameConditions=null;a.pause={toggle:function(){if(!p){a.pause.active=g.togglePause()}},active:false};a.load=function(){b.get("resources/games/"+a.gameName+".json",{cache:true}).success(function(b){a.config.gameConfig=b;a.useGameConfig(b)}).error(function(a){console.log(a)})};a.load();angular.element(f).bind("blur",function(){return function(){a.pause.active=true;if(!g.pause){a.pause.active=g.togglePause()}a.$apply()}}());a.useGameConfig=function(c){h.load(c.rules);a.gameConditions=c.victory;a.$broadcast("newRulesSet",c.victory);if(c.grid==""){g.setConfiguration(c,"",a.endCallBack,a);if(q){a.openCampaignModal(c)}}else{b.get("resources/grids/"+c.grid+".json",{cache:true}).success(function(b){g.setConfiguration(c,b,a.endCallBack,a);if(q){a.openCampaignModal(c)}}).error(function(a){console.log(a)})}};a.endCallBack=function(b){p=true;if(b.tetris.length===1){if(l.victory(0)){k.set(k.MKeys.UserMap+a.gameName,true,false)}j.getCurrentGame().setTime(b.last.tics);j.getCurrentGame().setSwaps(b.tetris[0].getSwaps());j.getCurrentGame().setActions(b.tetris[0].getActions());j.addGame(j.getCurrentGame(),a.gameName);if(m.isRegistered()){i.check(j.getCurrentGame(),a.gameName)}if(m.isRegistered()&&!q){n.addScore(m.id,j.getCurrentGame().score,a.gameName,j.getCurrentGame().time).success(function(a){console.log(a+a.message)}).error(function(a){console.log(a+a.message)})}a.openModal()}};a.reset=function(){a.$broadcast("newGame",true);p=false;a.pause.active=false;if(g.pause){a.pause.active=g.togglePause()}g.startNewGame()};a.openModal=function(){var b=e.open({animation:true,templateUrl:"resources/templates/endGameModal.html",controller:"ModalInstanceCtrl",resolve:{gameName:function(){return a.gameName}}});b.result.then(function(){if(l.victory(0)&&a.config.gameConfig.next){if(a.config.gameConfig.next[0]==="#"){f.location.href=a.config.gameConfig.next}a.gameName=a.config.gameConfig.next;q=a.gameName.indexOf("campaign")>-1;c.updateParams({hash:CryptoJS.MD5(a.gameName)})}else{a.reset()}},function(){})};a.openCampaignModal=function(b){a.pause.active=g.togglePause();var c=e.open({animation:true,templateUrl:"resources/templates/objectivesModal.html",controller:"ObjectivesModalCtrl",size:300,resolve:{gameName:function(){return a.gameName},gameConfig:function(){return b}}});c.result.then(function(){a.pause.active=g.togglePause()},function(){a.pause.active=g.togglePause()})};a.$on("$destroy",function(){g.stopGame();angular.element(f).unbind("blur")})}]); angular.module("angularApp.factories").factory("gamePadInput",["EGameActions",function a(b){"use strict";var c="GamepadEvent"in window;if(!c){return{clear:function(){},getActions:function(){}}}function d(){return{0:false,1:false,4:false,5:false,6:false,7:false,12:false,13:false,14:false,15:false,axe:[[0,0],[0,0],[0,0],[0,0]]}}var e=function(){this.actions=[{},{},{},{}];var a=this;this.gamePads={};this.checkGP=function(){function c(a){if(typeof a=="object"){return a.pressed}else{return a==1}}function e(b,d,e){var f=c(b.buttons[d]);var g=a.gamePads[b.index];if(f!=g[d]){g[d]=f;if(g[d]){a.press(b.index,e)}}}function f(b,c,d,e,f){if(b<=-.5&&c[0]>=7){a.actions[f][d]=true;c[0]=0}else if(b>=.5&&c[1]>=7){a.actions[f][e]=true;c[1]=0}else{c[0]+=1;c[1]+=1}}var g=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(var h=0;h<g.length;++h){var i=g[h];if(!i)continue;if(!a.gamePads[i.index]){a.gamePads[i.index]=d()}e(i,0,b.swap);e(i,4,b.swap);e(i,5,b.swap);e(i,6,b.swap);e(i,7,b.swap);e(i,1,b.speed);e(i,12,b.up);e(i,14,b.left);e(i,15,b.right);e(i,13,b.down);for(var j=0;j<i.axes.length&&j<4;++j){f(i.axes[j],a.gamePads[i.index].axe[j],j%2?b.up:b.left,j%2?b.down:b.right,i.index)}}window.requestAnimationFrame(a.checkGP)};window.requestAnimationFrame(this.checkGP)};e.prototype.clear=function(){this.actions=[{},{},{},{}]};e.prototype.press=function(a,b){this.actions[a][b]=true};e.prototype.pressed=function(a,b){return this.actions[a][b]===true};e.prototype.getActions=function(a,c){if(this.pressed(a,b.swap)){c.push(b.swap)}if(this.pressed(a,b.down)){c.push(b.down)}if(this.pressed(a,b.up)){c.push(b.up)}if(this.pressed(a,b.left)){c.push(b.left)}if(this.pressed(a,b.right)){c.push(b.right)}if(this.pressed(a,b.speed)){c.push(b.speed)}};return new e}]); angular.module("angularApp.controllers").controller("GameStateCtrl",["$scope","TIC_PER_SEC","stateChecker",function(a,b,c){"use strict";var d=true;var e=0;a.state={rules:c.createRuleSet(a.$parent.$parent.gameConditions),score:0,time:0,apm:0,swaps:0,actions:0,combo:1};a.$on("newGame",function(){a.state.swaps=e;a.state.score=0;a.state.time=0;a.state.actions=0;a.state.apm=0;a.state.combo=1});a.$on("newTick",function(c,f){if(f.tics>=a.state.time/6){a.state.score=f.score;if(d){a.state.swaps=f.swaps}else{a.state.swaps=e-f.swaps}a.state.actions=f.actions;a.state.combo=f.combo;a.state.time=f.tics;var g=Math.max(10*b,a.state.time);a.state.apm=Math.floor(a.state.actions*b*60/g);a.$digest()}});a.$on("newRulesSet",function(b,f){d=!f||!f.swaps;if(!d){e=f.swaps;a.state.swaps=f.swaps}a.state.rules=c.createRuleSet(f)})}]); angular.module("angularApp.factories").factory("gameStatsFactory",["TIC_PER_SEC",function a(b){"use strict";function c(){this.reset()}c.prototype.reset=function d(){this.score=0;this.time=0;this.blockDestroyed=0;this.multilines=[0,0,0,0,0,0,0,0,0];this.lineSizes=[0,0,0,0,0,0,0,0,0];this.gameCount=0;this.swapCount=0;this.actions=0;this.apm=0;this.efficiency=0};c.prototype.addLines=function(a,b){this.score+=b;var c=a.length-2;if(c>=this.multilines.length){c=this.multilines.length-1}this.multilines[c]+=1;for(var d=0;d<a.length;d+=1){var e=[];$.each(a[d],function(a,b){if($.inArray(b,e)===-1){e.push(b)}});var f=e.length-3;if(f>=this.lineSizes.length){f=this.lineSizes.length-1}this.lineSizes[f]+=1;this.blockDestroyed+=e.length}};c.prototype.setTime=function e(a){this.time=a;this.apm=this.actions/this.time*b*60};c.prototype.setSwaps=function f(a){this.swapCount=a;this.efficiency=this.score/this.swapCount};c.prototype.setActions=function g(a){this.actions=a;this.apm=this.actions/this.time*b*60};c.prototype.append=function h(a){this.gameCount+=a.gameCount;this.score+=a.score;this.time+=a.time;this.blockDestroyed+=a.blockDestroyed;this.swapCount+=a.swapCount;this.actions+=a.actions;for(var c=0;c<this.multilines.length;c+=1){this.multilines[c]+=a.multilines[c]}for(c=0;c<this.lineSizes.length;c+=1){this.lineSizes[c]+=a.lineSizes[c]}this.apm=this.actions/this.time*b*60;this.efficiency=this.score/this.swapCount};c.prototype.keepBest=function i(a){this.efficiency=this.efficiency>a.efficiency?this.efficiency:a.efficiency;this.apm=this.apm>a.apm?this.apm:a.apm;this.gameCount+=a.gameCount;this.score=this.score>a.score?this.score:a.score;this.time=this.time>a.time?this.time:a.time;this.blockDestroyed=this.blockDestroyed>a.blockDestroyed?this.blockDestroyed:a.blockDestroyed;this.swapCount=this.swapCount>a.swapCount?this.swapCount:a.swapCount;for(var b=0;b<this.multilines.length&&b<a.multilines.length;b+=1){this.multilines[b]=this.multilines[b]>a.multilines[b]?this.multilines[b]:a.multilines[b]}for(b=0;b<this.lineSizes.length&&b<a.lineSizes.length;b+=1){this.lineSizes[b]=this.lineSizes[b]>a.lineSizes[b]?this.lineSizes[b]:a.lineSizes[b]}};return{newGameStats:function j(){return new c},newGameStatsFrom:function k(a){var b=new c;b.keepBest(a);return b}}}]); angular.module("angularApp.factories").factory("gridEvaluator",["gameConstants","blockFactory",function a(b,c){"use strict";var d=function(){this.data=[];this.free=function(a){a.length=0;this.data.push(a)};this.get=function(){if(this.data.length==0){return[]}return this.data.pop()}};var e=new d;var f=function(){this.series=[];this.falling=0;this.lastTriger=0;this.combo=1};f.prototype.evaluateColumn=function(a,d){var f=0;var g=null;var h=-1;for(var i=b.hiddenRowCount;i<a[d].length;i+=1){if(a[d][i].state!==c.EState.Blocked){f=0;g=null}else if(a[d][i].type!==g){g=a[d][i].type;f=1}else{f+=1;if(f===3){a[d][i].setState(c.EState.Disappearing);a[d][i-1].setState(c.EState.Disappearing);a[d][i-2].setState(c.EState.Disappearing);this.series.push(e.get());h=this.series.length-1;this.series[h].push(a[d][i].id);this.series[h].push(a[d][i-1].id);this.series[h].push(a[d][i-2].id);if(a[d][i].wasFalling||a[d][i-1].wasFalling||a[d][i-2].wasFalling){this.series[h].falling=true}}else if(f>3){a[d][i].setState(c.EState.Disappearing);this.series[h].push(a[d][i].id);if(a[d][i].wasFalling){this.series[h].falling=true}}}}};f.prototype.evaluateVertical=function(a){for(var c=0;c<b.columnCount;c+=1){this.evaluateColumn(a,c)}};f.prototype.findBlockIndex=function(a,c,d){var e=b.pixelPerBox*d;for(var f=b.hiddenRowCount;f<a[c].length;f+=1){if(a[c][f].verticalPosition===e){return f}}return-1};f.prototype.evaluateLine=function(a,d){var f,g,h,i=-1,j=-1,k=-1;h=0;g=null;var l=-1;for(f=0;f<b.columnCount;f+=1){k=j;j=i;i=this.findBlockIndex(a,f,d);if(i===-1){h=0;continue}var m=a[f][i];if(m.state===c.EState.Blocked||m.state===c.EState.Disappearing&&m.animationState===0){if(m.type!==g){g=a[f][i].type;h=0}h+=1;if(h===3){a[f][i].setState(c.EState.Disappearing);a[f-1][j].setState(c.EState.Disappearing);a[f-2][k].setState(c.EState.Disappearing);this.series.push(e.get());l=this.series.length-1;this.series[l].push(a[f][i].id);this.series[l].push(a[f-1][j].id);this.series[l].push(a[f-2][k].id);if(a[f][i].wasFalling||a[f-1][j].wasFalling||a[f-2][k].wasFalling){this.series[l].falling=true}}else if(h>3){a[f][i].setState(c.EState.Disappearing);this.series[l].push(a[f][i].id);if(a[f][i].wasFalling){this.series[l].falling=true}}}else{h=0}}};f.prototype.evaluateHorizontal=function(a){for(var c=b.hiddenRowCount;c<b.displayedRowCount+b.hiddenRowCount;c+=1){this.evaluateLine(a,c)}};f.prototype.getScore=function(){var a=this.series.length;var b=0;for(var c=0;c<this.series.length;c+=1){b+=Math.pow(this.series[c].length-2,1.5)*(this.series[c].falling?1.5:1)}return Math.ceil(b*(.5+Math.pow(a,1.5)/2))};f.prototype.getSerie=function(a,b){for(var c=0;c<b;c+=1){for(var d=0;d<this.series[c].length;d+=1){if(this.series[c][d]===a){return c}}}return-1};var g=function(a,b){e.free(a[b]);var c=a.length;while(b<c){a[b]=a[b+1];b++}a.length--};f.prototype.mergeSeries=function(){for(var a=this.series.length-1;a>=0;a-=1){for(var b=0;b<this.series[a].length;b+=1){var c=this.getSerie(this.series[a][b],a);if(c!==-1){var d=this.series[c].falling||this.series[a].falling;this.series[c]=this.series[c].concat(this.series[a]);this.series[c].falling=d;g(this.series,a);break}}}};f.prototype.evaluate=function(a){this.lastTriger-=1;if(this.lastTriger<=0){this.combo=1}while(this.series.length){e.free(this.series.pop())}this.evaluateVertical(a);this.evaluateHorizontal(a);this.mergeSeries();var b=this.getScore();var c=b;b*=this.combo;if(c>=this.combo){this.lastTriger=120;this.combo+=1}return{score:b,combo:this.combo,series:this.series}};return new f}]); angular.module("angularApp.factories").factory("gridFactory",["gameConstants","blockFactory","gridEvaluator",function a(b,c,d){"use strict";var e=function(a,b){var c=a.length;while(b<c){a[b]=a[b+1];b++}a.length-=1};function f(a){var d,e,f=b.groundUpSpeedPerTic!==0||b.groundSpeedPerTic!==0;this.container=new Array(b.columnCount);for(d=0;d<b.columnCount;d+=1){this.container[d]=new Array(b.hiddenRowCount);for(e=0;e<this.container[d].length;e+=1){this.container[d][e]=c.newBlock();this.container[d][e].verticalPosition=e*b.pixelPerBox;if(!f){this.container[d][e].type=c.EType.PlaceHolder;this.container[d][e].state=c.EState.Blocked}}}if(!a){var g=-1;for(d=0;d<b.columnCount;d+=1){for(e=this.container[d].length;e<b.startRows;e+=1){this.container[d].push(c.newBlock());while(e%2==0&&g===this.container[d][e].type||d%2==1&&this.container[d-1][e].type==this.container[d][e].type){this.container[d][e].type=c.EType.Random()}g=this.container[d][e].type;this.container[d][e].verticalPosition=e*b.pixelPerBox}}}else{this.load(a)}}f.prototype.addNewLine=function(){var a,d;for(a=0;a<b.columnCount;a+=1){for(d=0;d<this.container[a].length;d+=1){this.container[a][d].verticalPosition+=b.pixelPerBox}this.container[a].unshift(c.newBlock())}};f.prototype.removeBlockFixed=function(a,b){c.releaseBlock(this.container[a][b]);e(this.container[a],b);this.makeTopBlockFall(a,b)};f.prototype.insertBlock=function(a,b){for(var c=0;c<this.container[b].length;c+=1){if(this.container[b][c].verticalPosition>a.verticalPosition){this.container[b].splice(c,0,a);return}}this.container[b].push(a)};f.prototype.findBlock=function(a,b){var c=this.findBlockIndex(a,b);if(c===-1){return null}return this.container[a][c]};f.prototype.findBlockIndex=function(a,c){var d;for(d in this.container[a]){if(this.container[a].hasOwnProperty(d)&&this.container[a][d].verticalPosition===b.pixelPerBox*c){return parseInt(d)}}return-1};f.prototype.isBlockIndexFree=function(a,c){var d;for(d in this.container[a]){if(this.container[a].hasOwnProperty(d)&&this.container[a][d].verticalPosition>=b.pixelPerBox*c&&this.container[a][d].verticalPosition<b.pixelPerBox*(c+1)){return false}}return true};f.prototype.makeTopBlockFall=function(a,b){if(b<0){throw"Not my day"}for(var d=b;d<this.container[a].length;d+=1){if(this.container[a][d].state!==c.EState.Blocked){break}this.container[a][d].setState(c.EState.Falling)}};f.prototype.animateBlockFall=function(a,d,e,f){e.verticalPosition-=b.fallSpeedPerTic;if(e.verticalPosition<f){e.verticalPosition=f;if(this.container[a][d-1].state!==c.EState.Falling){e.setState(c.EState.Blocked);e.wasFalling=true}}return{min:e.verticalPosition+b.pixelPerBox,deltaY:0}};f.prototype.animateBlockDisappear=function(a,c,d,e){d.animationState+=b.disapearSpeedPerTic;if(d.animationState>100&&d.id===-1){this.removeBlockFixed(a,c);return{min:e,deltaY:-1}}return{min:d.verticalPosition+b.pixelPerBox,deltaY:0}};f.prototype.animateSwapped=function(a,d,e,f){e.animationState+=b.swapPerTic;if(e.animationState>100){if(e.type===c.EType.PlaceHolder){this.removeBlockFixed(a,d);return{min:f,deltaY:-1}}else if(this.container[a][d-1].state===c.EState.Falling||this.container[a][d-1].verticalPosition<e.verticalPosition-b.pixelPerBox){e.setState(c.EState.Falling);this.makeTopBlockFall(a,d+1)}else{e.setState(c.EState.Blocked)}}return{min:e.verticalPosition+b.pixelPerBox,deltaY:0}};f.prototype.animateBlock=function(a,d,e){var f=this.container[a][d];f.wasFalling=false;switch(f.state){case c.EState.Blocked:return{min:f.verticalPosition+b.pixelPerBox,deltaY:0};case c.EState.Disappearing:return this.animateBlockDisappear(a,d,f,e);case c.EState.Falling:return this.animateBlockFall(a,d,f,e);case c.EState.SwappedRight:case c.EState.SwappedLeft:return this.animateSwapped(a,d,f,e)}throw"Unsupported animation "+f.state};f.prototype.animateColumn=function(a){var c,d,e;d=b.hiddenRowCount*b.pixelPerBox;for(c=b.hiddenRowCount-1;c<this.container[a].length;c+=1){e=this.animateBlock(a,c,d);d=e.min;c+=e.deltaY}};f.prototype.animate=function(){for(var a=0;a<b.columnCount;a+=1){this.animateColumn(a)}};f.prototype.getMaxFixed=function(){var a,d,e=0;for(a=0;a<b.columnCount;a+=1){for(d=b.hiddenRowCount;d<this.container[a].length;d+=1){if(this.container[a][d].state!==c.EState.Blocked){break}if(this.container[a][d].verticalPosition>e){e=this.container[a][d].verticalPosition}}}return e};f.prototype.newBlockFall=function(a){var d=c.newBlock();d.setState(c.EState.Falling);d.verticalPosition=(b.hiddenRowCount+b.displayedRowCount+1)*b.pixelPerBox;this.container[a].push(d)};f.prototype.swap=function(a,b){var d=this.findBlock(a,b);var e=this.findBlock(a+1,b);if(d!==null&&e!==null){if(d.state===c.EState.Blocked&&e.state===c.EState.Blocked&&(d.type!==c.EType.PlaceHolder||e.type!=c.EType.PlaceHolder)){this.swapBlocks(d,e);return true}}else if(d!==null&&this.isBlockIndexFree(a+1,b)&&d.state===c.EState.Blocked){var f=c.newBlock();f.type=c.EType.PlaceHolder;f.state=c.EState.SwappedLeft;f.verticalPosition=d.verticalPosition;this.insertBlock(f,a+1);this.swapBlocks(d,f);return true}else if(e!==null&&this.isBlockIndexFree(a,b)&&e.state===c.EState.Blocked){var g=c.newBlock();g.type=c.EType.PlaceHolder;g.state=c.EState.SwappedRight;g.verticalPosition=e.verticalPosition;this.insertBlock(g,a);this.swapBlocks(g,e);return true}return false};var g=c.newBlock();f.prototype.swapBlocks=function(a,b){g.loadFrom(a);a.loadFrom(b);b.loadFrom(g);a.setState(c.EState.SwappedLeft);b.setState(c.EState.SwappedRight)};f.prototype.load=function(a){var d,e;for(d=0;d<a.grid.length;d+=1){for(e=0;e<a.grid[d].length;e+=1){var f=c.newBlock();f.state=a.grid[d][e].state;f.type=a.grid[d][e].type;f.verticalPosition=this.container[d].length*b.pixelPerBox;this.container[d].push(f)}}};f.prototype.evaluate=function(){return d.evaluate(this.container)};f.prototype.blockCount=function(){var a=0;for(var c=0;c<this.container.length;c+=1){a+=this.container[c].length-b.hiddenRowCount}return a};f.prototype.contains=function(a){var c=0;for(var d=0;d<this.container.length;d+=1){for(var e=b.hiddenRowCount;e<this.container[d].length;e+=1){if(this.container[d][e].type===a)c+=1}}return c};return{newGrid:function h(a){return new f(a)}}}]); angular.module("angularApp.factories").factory("helpers",["TIC_PER_SEC","SEC_PER_MIN",function a(b,c){"use strict";function d(a){var b=window.location.search.substring(1);var c=b.split("&");for(var d=0;d<c.length;d+=1){var e=c[d].split("=");if(e[0]===a){return e[1]}}return""}function e(a){if(isNaN(a)){return""}var d=Math.floor(a/b);var e=Math.floor(d/c);var f=d%c;var g=Math.floor(a%b/(b/10));return(e<10?"0"+e:e)+":"+(f<10?"0"+f:f)+"."+g}return{timeFromTics:e,getQueryVariable:d}}]); angular.module("angularApp.factories").factory("KeyboardInput",["EGameActions",function a(b){"use strict";var c=function(){this.keyCodes={};var a=this;this.onKeyDown=function(b){a.onKeyChange(b)};document.addEventListener("keydown",this.onKeyDown,false)};c.prototype.destroy=function(){document.removeEventListener("keydown",this.onKeyDown,false)};c.ALIAS={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,tab:9,enter:13};c.prototype.clear=function(){this.keyCodes={}};c.prototype.onKeyChange=function(a){var b=a.keyCode;this.keyCodes[b]=true;if(b===c.ALIAS.space||b>=c.ALIAS.left&&b<=c.ALIAS.down){a.preventDefault()}};c.prototype.press=function(a){this.keyCodes[a]=true};c.prototype.pressed=function(a){return this.keyCodes[a]===true};c.prototype.getActions=function(a,c){if(this.pressed(a.swap)){c.push(b.swap)}if(this.pressed(a.down)){c.push(b.down)}if(this.pressed(a.up)){c.push(b.up)}if(this.pressed(a.left)){c.push(b.left)}if(this.pressed(a.right)){c.push(b.right)}if(this.pressed(a.speed)){c.push(b.speed)}};c.prototype.leftMapping={swap:32,down:83,up:90,left:81,right:68,speed:65};c.prototype.rightMapping={swap:96,down:c.ALIAS.down,up:c.ALIAS.up,left:c.ALIAS.left,right:c.ALIAS.right,speed:c.ALIAS.enter};return new c}]); angular.module("angularApp.controllers").controller("LoginFormCtrl",["$scope","$modalInstance","userAccount",function(a,b,c){"use strict";a.submitEnabled=true;a.messageLogin="";a.messageRegister="";a.user={login:"",password:""};a.register={login:"",password:""};a.login=function(){if(a.signForm.$valid){a.submitEnabled=false;c.logIn(a.user.login,a.user.password,function(c,d){if(c){b.close()}else{a.submitEnabled=true;a.messageLogin=d?d:"Login failed : check your password !"}})}};a.register=function(){if(a.registerForm.$valid){a.submitEnabled=false;c.createUser(a.register.login,a.register.password,function(c,d){if(c){b.close()}else{a.submitEnabled=true;a.messageRegister=d?d:"Can't create user."}})}};a.close=function(){b.close()}}]); angular.module("angularApp.directives").directive("mngCompareTo",function(){"use strict";return{require:"ngModel",scope:{otherModelValue:"=mngCompareTo"},link:function(a,b,c,d){d.$validators.mngCompareTo=function(b){return b===a.otherModelValue};a.$watch("otherModelValue",function(){d.$validate()})}}}); angular.module("angularApp.directives").directive("mngTetrisGame",["$swipe","game","KeyboardInput","systemConfig",function(a,b,c,d){"use strict";return{restrict:"A",link:function(e,f,g){if(!Detector.webgl){Detector.addGetWebGLMessage(document.getElementById("game"));return}var h,i,j,k;var l=1;var m=-1;var n=!d.get(d.Keys.touchAndSlide);var o=function(a){var d=false;if(n){var e=f[0].getBoundingClientRect();j=a.clientX-e.left;k=a.clientY-e.top;d=b.touchSwap(j/l,600-k/l)}if(!d){var g=(new Date).getTime();if(g-m<300){c.press(13)}m=g}};if(document.documentElement.clientWidth<448){l=document.documentElement.clientWidth/448}if(document.documentElement.clientHeight<600&&document.documentElement.clientHeight/600<l){l=document.documentElement.clientHeight/600}f.bind("click",o);if(!n){a.bind(f,{start:function(a){var b=f[0].getBoundingClientRect();h=a.x-b.left;i=a.y-b.top},end:function(a){var c=f[0].getBoundingClientRect();j=a.x-c.left;k=a.y-c.top;if(Math.abs(h-j)/l>30){b.slide(h/l,600-i/l,j/l,600-k/l)}}})}b.linkToDom(f[0],g.mngTetrisGame,l,l);e.$on("$destroy",function(){b.unlinkToDom(f[0],g.mngTetrisGame)});e.test=function(a){console.log(a)}}}}]); angular.module("angularApp.directives").directive("ngEnter",["$document",function(a){"use strict";return{scope:{ngEnter:"&"},link:function(b,c,d){var e=function(c){if(c.which===13){b.ngEnter();a.unbind("keydown keypress",e)}};a.bind("keydown keypress",e)}}}]); angular.module("angularApp.directives").directive("ngCx",function(){return function(a,b,c){c.$observe("ngCx",function(a){b.attr("cx",a)})}}).directive("ngDx",function(){return function(a,b,c){c.$observe("ngDx",function(a){b.attr("dx",a)})}}).directive("ngCy",function(){return function(a,b,c){c.$observe("ngCy",function(a){b.attr("cy",a)})}}).directive("ngTransform",function(){return function(a,b,c){c.$observe("ngTransform",function(a){b.attr("transform",a)})}}); angular.module("angularApp.controllers").controller("PasswordRecoveryCtrl",["$scope","userAccount",function(a,b){"use strict";a.name="";a.resetPassword=function(){if(a.updateForm.$valid){a.submitEnabled=false;b.resetPassword(a.name,function(b){a.submitEnabled=true;a.message=b})}}}]); angular.module("angularApp.factories").factory("scoreRenderElementFactory",["systemConfig",function a(b){"use strict";var c=new THREE.FontLoader;var d=false;c.load("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json",function(a){d=a});function e(a){this.matGen=a;this.caches={};this.create=function(a){if(!this.caches[a]||!this.caches[a].length){var b=new THREE.TextGeometry(a,{size:30,height:2,curveSegments:2,font:d});return new THREE.Mesh(b,this.matGen.get())}this.caches[a].material=this.matGen.get();return this.caches[a].pop()};this.release=function(a,b){if(!this.caches[b]){this.caches[b]=[]}a.scale.set(1);this.caches[b].push(a)}}function f(){this.cache=[];for(var a=0;a<20;++a){this.cache.push(new THREE.MeshBasicMaterial({color:Math.random()*16777215}))}this.get=function(){return this.cache[Math.floor(Math.random()*20)]}}function g(a){this.value=0;this.mesh=null;this.particles=null;this.factory=a}g.prototype.updateAttributes=function(a,b){};g.prototype.updateVert=function(a){for(var b=0;b<a.length;b+=1){a[b]*=1.02}};g.prototype.animate=function(a){var b=a/100;if(this.mesh){var c=1/(1+Math.pow(100-a,2)/1e4);this.mesh.scale.set(c,c,c)}if(this.particles){b*=.7*12;var d=this.particles.geometry.attributes.size;this.updateAttributes(d,b);var e=this.particles.geometry.attributes.position.array;this.updateVert(e);this.particles.geometry.attributes.position.needsUpdate=true;d.needsUpdate=true}};g.prototype.createScore=function i(a){this.value=a;this.createText(a);this.createParticles(a)};g.prototype.createText=function(a){if(!b.get(b.Keys.scores)){return}var c=Math.floor(Math.random()*12);var d=260+85*(Math.floor(c/2)%6)-80*Math.random();var e=(c%2?-225:175)-50*Math.random();var f=this.factory.txtCache.create(a);f.position.setX(e);f.position.setY(d);f.position.setZ(-5);this.mesh=f};g.prototype.createParticles=function(a){if(!b.get(b.Keys.explosions)){return}var c=Math.random()*16777215;var d=220+80*Math.random();var e=-250+500*Math.random();var f=new THREE.ShaderMaterial({uniforms:{amplitude:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:this.factory.sparkTexture}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,blending:THREE.AdditiveBlending,depthTest:true,transparent:true});var g=100+a*30;var h=new THREE.BufferGeometry;var i=new THREE.Color(c);var j=new Float32Array(3*g);var k=new Float32Array(g);h.addAttribute("customColor",new THREE.BufferAttribute(j,3));h.addAttribute("size",new THREE.BufferAttribute(k,1));var l=new Float32Array(g*3);for(var m=0;m<100+a*30;m++){var n=new THREE.Vector3;do{n.x=Math.random()*2-1;n.y=Math.random()*2-1}while(n.x*n.x+n.y*n.y>1);n.multiplyScalar(70);n.z=-50;n.toArray(l,m*3);i.toArray(j,m*3);k[m]=8}h.addAttribute("position",new THREE.BufferAttribute(l,3));this.particles=new THREE.Points(h,f);this.particles.position.setX(e);this.particles.position.setY(d)};function h(){var a=this;var b=new THREE.TextureLoader;b.load("resources/imgs/spark.png",function(b){a.sparkTexture=b});this.matGen=new f;this.txtCache=new e(this.matGen);this.create=function(){return new g(this)};this.free=function(a){if(a.mesh){this.txtCache.release(a.mesh,a.value);a.mesh=null}}}return{createFactory:function(){return new h}}}]); angular.module("angularApp.factories").factory("stateChecker",["gameConstants","TIC_PER_SEC",function a(b,c){"use strict";function d(){}d.prototype.reset=function(a){this.defeatComponents=[];this.succesComponents=[];this.makeComponents(a);this.defeatComponents.push(new e);this.lastSuccessCheck=false;this.lastDefeatCheck=false;this.lastDangerLevel=0};d.prototype.defeat=function(){return this.lastDefeatCheck};d.prototype.victory=function(){return this.lastSuccessCheck};d.prototype.getDangerLevel=function(){return this.lastDangerLevel};d.prototype.check=function(a){this.lastSuccessCheck=this.succesComponents.length!==0;this.lastDefeatCheck=false;this.lastDangerLevel=0;for(var b=0;b<this.succesComponents.length;b+=1){this.lastSuccessCheck=this.succesComponents[b].check(a)&&this.lastSuccessCheck}for(b=0;b<this.defeatComponents.length;b+=1){this.lastDefeatCheck=this.defeatComponents[b].check(a)||this.lastDefeatCheck;this.lastDangerLevel=Math.max(this.lastDangerLevel,this.defeatComponents[b].getDangerLevel())}return};d.prototype.makeComponents=function(a){if(!a){return}if(a.blocksLeft!==undefined){this.succesComponents.push(new g(a.blocksLeft))}if(a.score!==undefined){this.succesComponents.push(new f(a.score))}if(a.destroy!==undefined){this.succesComponents.push(new h(a.destroy))}if(a.swaps!==undefined){this.defeatComponents.push(new j(a.swaps))}if(a.time!==undefined){this.defeatComponents.push(new k(a.time))}if(a.keep!==undefined){this.defeatComponents.push(new i(a.keep))}};function e(){this.level=0}e.prototype.check=function(a){if(a.getMaxFixed()>=b.lostThreshold)this.level+=1;else this.level-=(b.lostThreshold-a.getMaxFixed())/c;if(this.level<0)this.level=0;return this.level>=c*3};e.prototype.getDangerLevel=function(){return this.level/(c*3)*10};function f(a){this.val=a}f.prototype.check=function(a){return a.getScore()>=this.val};f.prototype.getDangerLevel=function(){return 0};function g(a){this.val=a}g.prototype.check=function(a){return a.grid.blockCount()<=this.val};g.prototype.getDangerLevel=function(){return 0};function h(a){this.val=a}h.prototype.check=function(a){return a.grid.contains(1)<=this.val};h.prototype.getDangerLevel=function(){return 0};function i(a){this.val=a}i.prototype.check=function(a){return a.grid.contains(3)<this.val};i.prototype.getDangerLevel=function(){return 0};function j(a){this.val=a}j.prototype.check=function(a){return a.getSwaps()>this.val};j.prototype.getDangerLevel=function(){return 0};function k(a){this.val=a;this.danger=0}k.prototype.check=function(a){this.danger=this.val-a.tics/c;return a.tics/c>this.val};k.prototype.getDangerLevel=function(){if(this.danger<10)return 10-this.danger;return 0};return{checkers:[],create:function(a){for(var b=0;b<this.checkers.length;++b){if(!this.checkers[b].used){this.checkers[b].used=true;this.checkers[b].check.reset(a);return b}}this.checkers.push({check:new d,used:true});this.checkers[this.checkers.length-1].check.reset(a);return this.checkers.length-1},free:function(a){this.checkers[a].used=false},defeat:function(a){return this.checkers[a].check.defeat()},victory:function(a){return this.checkers[a].check.victory()},getDangerLevel:function(a){return this.checkers[a].check.getDangerLevel()},check:function(a,b){return this.checkers[a].check.check(b)},createRuleSet:function(a){var b=[];if(!a){b.push({success:true,message:"Try to stay alive !"});return b}if(a.destroy!==undefined){b.push({success:true,message:"Destroy all the green blocks"})}if(a.keep!==undefined){b.push({success:false,message:"Don't destroy any red block before your last swap"})}if(a.blocksLeft!==undefined){if(a.blocksLeft===0){b.push({success:true,message:"Destroy each block"})}else{b.push({success:true,message:"Reduce the blocks to "+a.blocksLeft})}}if(a.score!==undefined){b.push({success:true,message:"Get "+a.score+" points"})}if(a.swaps!==undefined){b.push({success:false,message:"Max "+a.swaps+(a.swaps>1?" swaps":" swap")})}if(a.time!==undefined){b.push({success:false,message:"Max "+a.time+" seconds"})}return b}}}]); angular.module("angularApp.factories").factory("storage",["api",function a(b){"use strict";function c(){this.storage={};this.inSave=false;this.waitingToSave=false;this.eventHandler=[];this.id=-1;this.hash=null;this.realStorage}c.prototype.createTemp=function(a){var b=new c;b.storage=JSON.parse(a);return b};c.prototype.impersonate=function(a){this.realStorage=this.storage;this.storage=JSON.parse(a)};c.prototype.restore=function(){this.storage=this.realStorage};c.prototype.load=function d(a,b,c){a=JSON.parse(a);if(!a)this.storage={};else this.storage=a;this.id=b;this.hash=c};c.prototype.unload=function e(){this.storage={};this.id=-1;this.hash=null};c.prototype.get=function(a){var b=this.storage[a];return b};c.prototype.set=function(a,b,c){if(c===undefined){c=true}this.storage[a]=b;if(c){this.flush()}};c.prototype.flush=function(){if(this.id!==-1){this.save()}};c.prototype.save=function(){if(this.inSave){this.waitingToSave=true}else{this.waitingToSave=false;this.inSave=true;var a=this;b.updateUser(this.id,this.hash,JSON.stringify(this.storage)).success(function(b){a.inSave=false;if(a.waitingToSave){a.save()}}).error(function(b){console.log(b);a.inSave=false;if(a.waitingToSave){a.save()}})}};c.prototype.Keys={CubeTheme:"CubeTheme",WebTheme:"WebTheme",Achievements:"Achievements",HexKeyColors:"HexKeyColors"};c.prototype.MKeys={UserMap:"UserMap",BestGameStats:"BestGameStats",TotalGameStats:"TotalGameStats"};return new c}]); angular.module("angularApp.factories").factory("systemConfig",["storage",function a(b){"use strict";var c={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return c.Android()||c.BlackBerry()||c.iOS()||c.Opera()||c.Windows()}};function d(){var a=c.any()!=null;this.isMobile=a}d.prototype.set=function(a,b){if(b==undefined)b=null;localStorage.setItem("systemConfig_"+a,JSON.stringify(b))};d.prototype.get=function(a){var b=localStorage.getItem("systemConfig_"+a);if(b!=null){try{b=JSON.parse(b)}catch(c){console.log(c);b=null}}if(b!=null){return b}if(this.isMobile){return this.defaultMobile(a)}return this.defaultDesktop(a)};d.prototype.defaultDesktop=function(a){switch(a){case this.Keys.antialiasing:return true;case this.Keys.useLambertMaterial:return false;case this.Keys.sound:return true;case this.Keys.scores:return true;case this.Keys.explosions:return true;case this.Keys.zoom:return false;case this.Keys.cssScaling:return false;case this.Keys.fps:return false;case this.Keys.touchAndSlide:return true}throw"what key is that"};d.prototype.defaultMobile=function(a){switch(a){case this.Keys.antialiasing:return false;case this.Keys.useLambertMaterial:return true;case this.Keys.sound:return false;case this.Keys.scores:return false;case this.Keys.explosions:return false;case this.Keys.zoom:return true;case this.Keys.cssScaling:return true;case this.Keys.fps:return false;case this.Keys.touchAndSlide:return true}throw"what key is that"};d.prototype.Keys={antialiasing:0,useLambertMaterial:1,sound:2,scores:3,explosions:4,zoom:5,cssScaling:6,fps:7,touchMode:8};return new d}]); angular.module("angularApp.factories").factory("tetrisFactory",["gameConstants","userInput","gridFactory","systemConfig","audio","EGameActions",function a(b,c,d,e,f,g){"use strict";function h(a,c){this.zoom=e.get(e.Keys.zoom)&&b.columnCount<8;this.grid=d.newGrid(a);this.score=0;this.blockDestroyed=0;this.cursor=[];if(c===undefined){c=1}for(var f=0;f<c;f+=1){this.cursor.push({x:2+f*2,y:b.hiddenRowCount+b.displayedRowCount/2})}this.counters={swap:0,move:0,speed:0};this.groundSpeed=b.groundSpeedPerTic;this.baseGroundSpeed=b.groundSpeedPerTic;this.groundPos=0;this.playersId=[];this.tics=0}function i(a){var c=0;if(a){c=45+(6-b.columnCount)*30;return c+30}c=10+(10-b.columnCount)*21.5;return c+21.5}function j(a){var c=0;if(a){c=45+(6-b.columnCount)*30+(b.columnCount-1)*60;return c}c=10+(10-b.columnCount)*21.5+(b.columnCount-1)*43;return c}h.prototype.touchSwap=function(a,b){if(a>i(this.zoom))a-=this.zoom?30:21.5;if(a>j(this.zoom))a-=this.zoom?30:21.5;return this.slide(a,b,a+1,b)};h.prototype.slide=function(a,c,d,e){var f=this;function g(a){if(f.zoom){a-=45;a=a/60;a-=(6-b.columnCount)/2}else{a-=10;a=a/43;a-=(10-b.columnCount)/2}return Math.floor(a)}function h(a){if(f.zoom){a-=6;a-=f.groundPos/b.pixelPerBox*55;a=a/55}else{a-=95;a-=f.groundPos/b.pixelPerBox*43;a=a/43}a+=b.hiddenRowCount;return Math.floor(a)}var i=g(a);var j=h(c);if(a>d){i=i-1}if(i<0||j<b.hiddenRowCount-1||i>=b.columnCount-1){return false}return this.swap(i,j)};h.prototype.oneTick=function(){var a=this.grid.evaluate();for(var c=0;c<a.series.length;c+=1){this.blockDestroyed+=a.series.length}this.score+=a.score;if(a.score>0){f.play(f.ESounds.score)}this.handleUserInput();this.tics+=1;if(b.fallPeriod!==0&&this.tics%b.fallPeriod===0&&b.gracePeriod<this.tics){this.randomFall()}this.grid.animate();this.groundPos+=this.groundSpeed;this.groundSpeed+=b.groundAccelerationPerTic;this.baseGroundSpeed+=b.groundAccelerationPerTic;if(this.groundPos>=b.pixelPerBox){this.groundPos-=b.pixelPerBox;this.grid.addNewLine();for(var c=0;c<this.cursor.length;c+=1){this.cursor[c].y+=1}this.groundSpeed=this.baseGroundSpeed}return a};h.prototype.getMaxFixed=function(){return this.grid.getMaxFixed()};h.prototype.isMoving=function(){return this.grid.isMoving()};h.prototype.getScore=function(){return this.score};h.prototype.getDestroyed=function(){return this.blockDestroyed};h.prototype.getSwaps=function(){return this.counters.swap};h.prototype.getActions=function(){return this.counters.swap+this.counters.move+this.counters.speed};function k(a,b){return Math.floor(Math.random()*(b-a+1))+a}h.prototype.randomFall=function(){var a=3;var c=k(0,b.columnCount-a);for(var d=c;d<c+a;d+=1){this.grid.newBlockFall(d)}};h.prototype.swap=function l(a,b){var c=this.grid.swap(a,b);if(c){this.counters.swap+=1;f.play(f.ESounds.swap)}return c};h.prototype.handleUserInput=function(){var a;for(var d=0;d<this.playersId.length;d+=1){var e=this.cursor[d%this.cursor.length];var f=e.x;var h=e.y;a=c.getActions(this.playersId[d]);for(var i=0;i<a.length;i+=1){switch(a[i]){case g.swap:this.swap(e.x,e.y);break;case g.down:e.y=Math.max(b.hiddenRowCount-1,e.y-1);break;case g.up:e.y=Math.min(b.hiddenRowCount+b.displayedRowCount,e.y+1);break;case g.left:e.x=Math.max(0,e.x-1);break;case g.right:e.x=Math.min(b.columnCount-2,e.x+1);break;case g.speed:if(this.groundSpeed!=b.groundUpSpeedPerTic){this.counters.speed+=1;this.groundSpeed=b.groundUpSpeedPerTic}break}}if(h!=e.y||e.x!=f){this.counters.move+=1}}};return{newTetris:function(a,b){return new h(a,b)}}}]); angular.module("angularApp.factories").factory("threeRendererFactory",["gameConstants","blockFactory","cubeRenderElementFactory","scoreRenderElementFactory","systemConfig",function a(b,c,d,e,f){"use strict";function g(a,c,g,h){this.scale={x:+g,y:+h};this.mode=+c;this.zoom=f.get(f.Keys.zoom)&&b.columnCount<8;if(a===undefined){a=1}this.camera=this.createCamera();this.cursor=[this.createCursor(32896)];for(var i=1;i<a;i+=1){this.cursor.push(this.createCursor(8388736))}this.offset=0;this.id=String.fromCharCode(65+Math.floor(Math.random()*26))+Date.now();this.type=c;this.cubeFactory=d.createFactory(this.type);this.scoreFactory=e.createFactory();this.displayCursor=!f.isMobile;this.scene=this.createScene()}g.prototype.clear=function(){this.renderer.clear();for(var a=this.scene.children.length-1;a>=0;a-=1){if(this.scene.children[a].customObject){var b=this.scene.children[a];this.scene.remove(b);this.cubeFactory.releaseCube(b)}}this.cubeFactory=d.createFactory(this.type);this.scoreFactory=e.createFactory();this.scene=null;this.camera=null;this.renderer=null};g.prototype.createScene=function(){var a=new THREE.Scene;var c=new THREE.PointLight(16777215,.5);c.position.set(0,100,800);a.add(c);var d=new THREE.PointLight(16777215,.5);d.position.set(600,-100,800);a.add(d);if(this.displayCursor){for(var e=0;e<this.cursor.length;e+=1){a.add(this.cursor[e])}}var f=new THREE.BoxGeometry(1e3,3,3);var g=new THREE.MeshPhongMaterial({color:3342336,emissive:10027008});var h=new THREE.Mesh(f,g);h.position.set(0,(b.hiddenRowCount+b.displayedRowCount)*b.pixelPerBox-27,10);a.add(h);f=new THREE.BoxGeometry(1e3,3,3);g=new THREE.MeshPhongMaterial({color:13056,emissive:39168});h=new THREE.Mesh(f,g);h.position.set(0,b.hiddenRowCount*b.pixelPerBox-b.pixelPerBox/2+5,10);a.add(h);return a};g.prototype.createCamera=function(){var a=new THREE.PerspectiveCamera(this.zoom?62:75,this.zoom?448/650:448/600,.3,1e3);a.position.z=450;a.position.x=-27;a.position.y=this.zoom?390:360;return a};g.prototype.createRenderer=function(a){var b=new THREE.WebGLRenderer({canvas:a,antialias:f.get(f.Keys.antialiasing)});b.setClearColor(0);if(f.get(f.Keys.cssScaling)){b.setSize(448*this.scale.x/2,600*this.scale.y/2);$(a).addClass("scaledCanvas");$(a).closest(".gameResizer").css("width",448*this.scale.x);$(a).closest(".gameResizer").css("height",600*this.scale.y)}else{b.setSize(448*this.scale.x,600*this.scale.y)}return b};function h(a,d){if(a.state===c.EState.SwappedLeft){return d+b.pixelPerBox/100*(100-a.animationState)}if(a.state===c.EState.SwappedRight){return d-b.pixelPerBox/100*(100-a.animationState)}return d}function i(a){var b=0;if(a.state===c.EState.SwappedLeft||a.state===c.EState.SwappedRight){if(a.animationState<51){b=2500-(50-a.animationState)*(50-a.animationState)}else{b=2500-(a.animationState-50)*(a.animationState-50)}b/=80;if(a.state===c.EState.SwappedRight){b=-b}}else if(a.state===c.EState.Disappearing){b=-a.animationState}return b}g.prototype.updateCube=function(a,b){if(b.id===-1){b.threeObject=this.cubeFactory.createCube(b.type);this.scene.add(b.threeObject);b.id=b.threeObject.id}var c=b.threeObject;c.position.setY(b.verticalPosition+this.offset);c.position.setX(h(b,a));c.position.setZ(i(b));this.cubeFactory.updateCubeDisplay(b);if(b.animationState>100){this.scene.remove(c);this.cubeFactory.releaseCube(c);b.id=-1;b.threeObject=null}};g.prototype.render=function(){this.renderer.render(this.scene,this.camera)};g.prototype.linkDom=function(a){a.scrollIntoView(true);this.renderer=this.createRenderer(a)};g.prototype.createCursor=function(a){var b=new THREE.Shape;b.absarc(72,-13,10,-Math.PI/2,0,false);b.lineTo(82,0);b.absarc(72,13,10,0,Math.PI/2,false);b.lineTo(35,20);b.lineTo(35,0);b.absarc(-2,-13,10,3*Math.PI/2,Math.PI,true);b.lineTo(-12,0);b.absarc(-2,13,10,Math.PI,Math.PI/2,true);b.lineTo(35,-20);return new THREE.Points(b.createPointsGeometry(),new THREE.PointsMaterial({color:a,size:4}))};g.prototype.drawCursorOn=function(a,c,d){if(d===undefined){d=0}this.cursor[d].position.set((a-b.columnCount/2)*b.pixelPerBox-10,c*(b.pixelPerBox-.5)+this.offset+5,7)};g.prototype.freezeGame=function(){this.renderer.setClearColor(new THREE.Color(0,0,0),1);for(var a=0;a<this.cursor.length;a+=1){this.scene.remove(this.cursor[a])}this.camera.position.z+=100;if(this.zoom)this.camera.position.y+=60;else this.camera.position.y+=100;this.render()};g.prototype.renderTetris=function(a,d,e){this.renderer.setClearColor(new THREE.Color(e/50,0,0),1);this.offset=a.groundPos;var f;for(var g=0;g<b.columnCount;g+=1){for(var h=0;h<a.grid.container[g].length;h+=1){f=a.grid.container[g][h];if(f.type!==c.EType.PlaceHolder){this.updateCube((g-b.columnCount/2)*b.pixelPerBox,f)}}}if(b.columnCount<=6&&!this.zoom){for(g=0;g<d.length;g+=1){if(!d[g].threeObject){d[g].threeObject=this.scoreFactory.create();d[g].threeObject.createScore(d[g].value);if(d[g].threeObject.mesh)this.scene.add(d[g].threeObject.mesh);if(d[g].threeObject.particles)this.scene.add(d[g].threeObject.particles)}if(d[g].opacity<=0){if(d[g].threeObject.mesh)this.scene.remove(d[g].threeObject.mesh);if(d[g].threeObject.particles)this.scene.remove(d[g].threeObject.particles);this.scoreFactory.free(d[g].threeObject);d.splice(g,1);g-=1}else{d[g].threeObject.animate(d[g].opacity)}}}for(g=0;g<a.cursor.length;g+=1){this.drawCursorOn(a.cursor[g].x,a.cursor[g].y,g)}this.render()};return{newRenderer:function j(a,b,c,d){return new g(a,b||0,c||1,d||1)}}}]); angular.module("angularApp.factories").factory("userAccount",["$q","$rootScope","$route","$window","$timeout","storage","api",function a(b,c,d,e,f,g,h){"use strict";function i(){this.eventHandler=[];this.username=null;this.id=-1;this.hash=null;this.started=false;this.email=null}i.prototype.start=function(){var a=this;return b(function(b,c){if(a.started){b(a.username);return}if(!localStorage.getItem("Usr_LastUserId")||!localStorage.getItem("Usr_hash")){b(null);return}h.loadUserId(localStorage.getItem("Usr_LastUserId"),localStorage.getItem("Usr_hash")).success(function(c){if(c.success){a.started=true;a.username=c.name;a.email=c.email;a.id=c.id;a.hash=c.hash;g.load(c.data,a.id,a.hash);a.loadTheme();a.broadcast();b(a.username)}else{localStorage.removeItem("Usr_hash");localStorage.removeItem("Usr_LastUserId");b(null)}}).error(function(a){localStorage.removeItem("Usr_hash");localStorage.removeItem("Usr_LastUserId");b(null)})})};i.prototype.registerToEvent=function(a,b){this.eventHandler.push({objet:a,callback:b})};i.prototype.createUser=function j(a,b,c){var d=this;h.createUser(a,b).success(function(e){if(e.success){d.username=a;d.logIn(a,b,c)}else{console.log(e.message);c(false)}}).error(function(a){if(a){console.log(a+a.message)}c(false,"An error occurred while contacting our server, please retry later.")})};i.prototype.resetPassword=function k(a,b){var c=this;h.resetPassword(a).success(function(a){if(a.success){b("An email as been sent to your account, it may go in your spam.")}else{b(a.message);console.log(a)}}).error(function(a){if(a){console.log(a+a.message)}b("An error occurred while contacting our server, please retry later.")})};i.prototype.updateUser=function l(a,b,c,d){var e=this;h.updateUser(this.id,this.hash,null,a,b,c).success(function(c){if(c.success){e.username=a;e.id=c.id;e.hash=c.hash;e.logIn(a,b,d);e.email=c.email}else{d(false);console.log(c.error)}})};i.prototype.broadcast=function(){for(var a=0;a<this.eventHandler.length;a+=1){this.eventHandler[a].callback.apply(this.eventHandler[a].objet,[this.username])}};i.prototype.logout=function m(){localStorage.removeItem("Usr_hash");localStorage.removeItem("Usr_LastUserId");this.login=null;g.unload();this.broadcast();e.location.href="#!/";e.location.reload()};i.prototype.isRegistered=function n(){return this.username!==null};i.prototype.loadTheme=function(){var a=g.get(g.Keys.WebTheme)||"cyborg";a=a.toLowerCase();var b=localStorage.getItem("dynamic_css_name");if(b!=a){h.getTheme(a).success(function(b){localStorage.setItem("dynamic_css_name",a);localStorage.setItem("dynamic_css_content",b);document.getElementById("switchableTheme").innerHTML=b;var c=document.getElementById("switchableThemeCss");if(c)c.parentNode.removeChild(c)}).error(function(a){console.log("can't load theme "+a)})}};i.prototype.setTheme=function(a){g.set(g.Keys.WebTheme,a.toLowerCase());this.loadTheme()};i.prototype.logIn=function o(a,b,c){var e=this;h.loadUser(a,b).success(function(b){if(b.success){localStorage.setItem("Usr_LastUserId",b.id);localStorage.setItem("Usr_hash",b.hash);e.username=a;e.id=b.id;e.hash=b.hash;g.load(b.data,e.id,e.hash);e.broadcast();e.loadTheme();d.reload();c(true,b.message)}else{console.log(b.message);c(false)}}).error(function(a){if(a){console.log(a+a.message)}c(false,"An error occurred while contacting our server, please retry later.")})};return new i}]); angular.module("angularApp.controllers").controller("UserAccountCtrl",["$scope","userAccount",function(a,b){"use strict";a.user={name:b.username,email:b.email};a.updateRegistration=function(){if(a.updateForm.$valid){a.submitEnabled=false;b.updateUser(a.user.name,a.user.password,a.user.email,function(c){if(c){a.user.name=b.username;a.user.email=b.email;a.submitEnabled=true}else{a.submitEnabled=true;a.message="Can't update user."}})}}}]); angular.module("angularApp.controllers").controller("UserConfigCtrl",["$scope","$http","$timeout","userAccount","storage","achievements",function(a,b,c,d,e,f){"use strict";a.cubeType=e.get(e.Keys.CubeTheme)||0;a.selectedCss=e.get(e.Keys.WebTheme)||"Slate";a.themes=[{Picture:"./resources/imgs/themes/plain.png",Name:"Plain cubes",Require:-1},{Picture:"./resources/imgs/themes/fancy.png",Name:"Fancy cubes",Require:f.List.Beginner},{Picture:"resources/imgs/themes/mines.png",Name:"Mines",Require:f.List.Nostalgic},{Picture:"resources/imgs/themes/candy.png",Name:"Candy",Require:f.List.RetroGamer},{Picture:"resources/imgs/themes/candyhd.png",Name:"Candy HD",Require:f.List.Sherlock},{Picture:"resources/imgs/themes/smash.png",Name:"Smash bros",Require:f.List.Flash},{Picture:"resources/imgs/themes/light.png",Name:"Lights",Require:f.List.Pacman},{Picture:"resources/imgs/themes/thirsty.png",Name:"Thirsty",Require:f.List.BiggerIsBetter},{Picture:"resources/imgs/themes/cup.png",Name:"Cup",Require:f.List.God}];a.requireStatus=function(a){if(a===-1)return true;return f.isWon(a)};a.updateStyle=function(b){if(a.requireStatus(a.themes[b].Require)){a.cubeType=b;e.set(e.Keys.CubeTheme,a.cubeType)}};var g=["Cerulean","Cosmo","Cyborg","Darkly","Flatly","Journal","Lumen","Paper","Readable","Sandstone","Simplex","Slate","Spacelab","Superhero","United","Yeti"];a.cssThemes=[a.selectedCss];for(var h=0;h<g.length;h+=1){if(g[h]!=a.cssThemes[0]){a.cssThemes.push(g[h])}}a.requireText=function(b){if(!a.requireStatus(b)){return"Unlocked by success : "+f.List.getName(b)}return""};a.loadStyle=function(a){d.setTheme(a)};c(function(){$('[data-toggle="tooltip"]').tooltip()},0);var i=[128,20480,4210752,6295568,10239491,2628162];a.resetColors=function(a){var b=a||e.get(e.Keys.HexKeyColors)||i;for(var c=0;c<6;++c){$("#picker_"+c).spectrum({color:"#"+("000000"+b[c].toString(16)).slice(-6),flat:false,showInput:false,showAlpha:false,showButtons:false})}};a.saveColors=function(){var b=[];for(var c=0;c<6;++c){b.push(parseInt($("#picker_"+c).spectrum("get").toHex(),16))}e.set(e.Keys.HexKeyColors,b);a.resetColors()};a.defaultColors=function(){a.resetColors(i);a.saveColors()};a.resetColors(null)}]); angular.module("angularApp.factories").factory("userInput",["KeyboardInput","gamePadInput",function a(b,c){"use strict";function d(){}d.prototype.clear=function(){b.clear();c.clear()};d.prototype.getActions=function(a){var d=[];switch(a){case 0:b.getActions(b.leftMapping,d);c.getActions(2,d);break;case 1:b.getActions(b.rightMapping,d);c.getActions(3,d);break;case 2:c.getActions(0,d);break;case 3:c.getActions(1,d);break}return d};d.prototype.getAllActions=function(){var a=[];b.getActions(b.leftMapping,a);c.getActions(2,a);b.getActions(b.rightMapping,a);c.getActions(3,a);c.getActions(0,a);c.getActions(1,a);return a};return new d}]); angular.module("angularApp.controllers").controller("UserMenuCtrl",["$scope","$modal","$timeout","userAccount",function(a,b,c,d){"use strict";a.registered=d.username!==null;a.userName=d.username;a.resetState=function e(b){c(function(){a.registered=b!==null;a.userName=b},0)};a.loginPopup=function(){b.open({animation:true,templateUrl:"resources/templates/user/login.html",controller:"LoginFormCtrl",size:400})};a.logout=function f(){d.logout()};d.registerToEvent(a,a.resetState)}]); angular.module("angularApp.factories").factory("userStats",["storage","gameStatsFactory",function a(b,c){"use strict";function d(){this.currentGame=c.newGameStats()}d.prototype.getCurrentGame=function(){return this.currentGame};d.prototype.addGame=function(a,c){var d=c.indexOf("campaign")>-1;var e=this.getBestGameStats(c);e.keepBest(a);b.set(b.MKeys.BestGameStats+c,e,false);if(!d){var f=this.getTotalGameStats(c);f.append(a);b.set(b.MKeys.TotalGameStats+c,f,false)}b.flush()};d.prototype.getBestGameStats=function(a,d){if(d===undefined){d=b}var e=d.get(b.MKeys.BestGameStats+a);if(e){return c.newGameStatsFrom(e)}return c.newGameStats()};d.prototype.getTotalGameStats=function(a,d){if(d===undefined){d=b}var e=d.get(b.MKeys.TotalGameStats+a);if(e){return c.newGameStatsFrom(e)}return c.newGameStats()};return new d}]);