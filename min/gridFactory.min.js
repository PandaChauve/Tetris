angular.module("angularApp.factories").factory("gridFactory",["gameConstants","blockFactory","gridEvaluator",function(a,b,c){"use strict";function d(c){var d,e,f=0!==a.groundUpSpeedPerTic||0!==a.groundSpeedPerTic;for(this.container=new Array(a.columnCount),d=0;d<a.columnCount;d+=1)for(this.container[d]=new Array(a.hiddenRowCount),e=0;e<this.container[d].length;e+=1)this.container[d][e]=b.newBlock(),this.container[d][e].verticalPosition=e*a.pixelPerBox,f||(this.container[d][e].type=b.EType.PlaceHolder,this.container[d][e].state=b.EState.Blocked);if(c)this.load(c);else for(d=0;d<a.columnCount;d+=1)for(e=this.container[d].length;e<a.startRows;e+=1)this.container[d].push(b.newBlock()),this.container[d][e].verticalPosition=e*a.pixelPerBox}return d.prototype.addNewLine=function(){var c,d;for(c=0;c<a.columnCount;c+=1){for(d=0;d<this.container[c].length;d+=1)this.container[c][d].verticalPosition+=a.pixelPerBox;this.container[c].unshift(b.newBlock())}},d.prototype.removeBlockFixed=function(a,b){var c=this.container[a][b];return this.container[a].splice(b,1),this.makeTopBlockFall(a,b),c},d.prototype.removeBlock=function(a,b){var c=this.findBlockIndex(a,b);if(-1===c)throw"Not my day";return this.removeBlockFixed(a,c)},d.prototype.insertBlock=function(a,b){for(var c=0;c<this.container[b].length;c+=1)if(this.container[b][c].verticalPosition>a.verticalPosition)return void this.container[b].splice(c,0,a);this.container[b].push(a)},d.prototype.findBlock=function(a,b){var c=this.findBlockIndex(a,b);return-1===c?null:this.container[a][c]},d.prototype.findBlockIndex=function(b,c){var d;for(d in this.container[b])if(this.container[b].hasOwnProperty(d)&&this.container[b][d].verticalPosition===a.pixelPerBox*c)return parseInt(d);return-1},d.prototype.isBlockIndexFree=function(b,c){var d;for(d in this.container[b])if(this.container[b].hasOwnProperty(d)&&this.container[b][d].verticalPosition>=a.pixelPerBox*c&&this.container[b][d].verticalPosition<a.pixelPerBox*(c+1))return!1;return!0},d.prototype.makeTopBlockFall=function(a,c){if(0>c)throw"Not my day";for(var d=c;d<this.container[a].length&&this.container[a][d].state===b.EState.Blocked;d+=1)this.container[a][d].setState(b.EState.Falling)},d.prototype.animateBlockFall=function(c,d,e,f){return e.verticalPosition-=a.fallSpeedPerTic,e.verticalPosition<f&&(e.verticalPosition=f,this.container[c][d-1].state!==b.EState.Falling&&e.setState(b.EState.Blocked)),{min:e.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateBlockDisappear=function(b,c,d,e){return d.animationState+=a.disapearSpeedPerTic,d.animationState>100&&-1===d.id?(this.container[b].splice(c,1),this.makeTopBlockFall(b,c),{min:e,deltaY:-1}):{min:d.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateSwapped=function(c,d,e,f){if(e.animationState+=15,e.animationState>100){if(e.type===b.EType.PlaceHolder)return this.removeBlockFixed(c,d),{min:f,deltaY:-1};this.container[c][d-1].state===b.EState.Falling||this.container[c][d-1].verticalPosition<e.verticalPosition-a.pixelPerBox?(e.setState(b.EState.Falling),this.makeTopBlockFall(c,d+1)):e.setState(b.EState.Blocked)}return{min:e.verticalPosition+a.pixelPerBox,deltaY:0}},d.prototype.animateBlock=function(c,d,e){var f=this.container[c][d];switch(f.state){case b.EState.Blocked:return{min:f.verticalPosition+a.pixelPerBox,deltaY:0};case b.EState.Disappearing:return this.animateBlockDisappear(c,d,f,e);case b.EState.Falling:return this.animateBlockFall(c,d,f,e);case b.EState.SwappedRight:case b.EState.SwappedLeft:return this.animateSwapped(c,d,f,e)}throw"Unsupported animation "+f.state},d.prototype.animateColumn=function(b){var c,d,e;for(d=a.hiddenRowCount*a.pixelPerBox,c=a.hiddenRowCount;c<this.container[b].length;c+=1)e=this.animateBlock(b,c,d),d=e.min,c+=e.deltaY},d.prototype.animate=function(){for(var b=0;b<a.columnCount;b+=1)this.animateColumn(b)},d.prototype.getMaxFixed=function(){var c,d,e=0;for(c=0;c<a.columnCount;c+=1)for(d=a.hiddenRowCount;d<this.container[c].length&&this.container[c][d].state===b.EState.Blocked;d+=1)this.container[c][d].verticalPosition>e&&(e=this.container[c][d].verticalPosition);return e},d.prototype.newBlockFall=function(c){var d=b.newBlock();d.setState(b.EState.Falling),d.verticalPosition=(a.hiddenRowCount+a.displayedRowCount+1)*a.pixelPerBox,this.container[c].push(d)},d.prototype.swap=function(a,c){var d=this.findBlock(a,c),e=this.findBlock(a+1,c);if(null!==d&&null!==e){if(d.state===b.EState.Blocked&&e.state===b.EState.Blocked)return this.swapBlocks(d,e),!0}else{if(null!==d&&this.isBlockIndexFree(a+1,c)&&d.state===b.EState.Blocked){var f=b.newBlock();return f.type=b.EType.PlaceHolder,f.state=b.EState.SwappedLeft,f.verticalPosition=d.verticalPosition,this.insertBlock(f,a+1),this.swapBlocks(d,f),!0}if(null!==e&&this.isBlockIndexFree(a,c)&&e.state===b.EState.Blocked){var g=b.newBlock();return g.type=b.EType.PlaceHolder,g.state=b.EState.SwappedRight,g.verticalPosition=e.verticalPosition,this.insertBlock(g,a),this.swapBlocks(g,e),!0}}return!1},d.prototype.swapBlocks=function(a,c){var d=b.cloneBlock(a);a.loadFrom(c),c.loadFrom(d),a.setState(b.EState.SwappedLeft),c.setState(b.EState.SwappedRight)},d.prototype.load=function(c){var d,e;for(d=0;d<c.grid.length;d+=1)for(e=0;e<c.grid[d].length;e+=1){var f=b.newBlock();f.state=c.grid[d][e].state,f.type=c.grid[d][e].type,f.verticalPosition=this.container[d].length*a.pixelPerBox,this.container[d].push(f)}},d.prototype.evaluate=function(){return c.evaluate(this.container)},d.prototype.blockCount=function(){for(var b=0,c=0;c<this.container.length;c+=1)b+=this.container[c].length-a.hiddenRowCount;return b},{newGrid:function(a){return new d(a)}}}]);