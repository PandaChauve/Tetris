angular.module("angularApp.factories").factory("gameFactory",["helpers","userInput","userStats","stateChecker","threeRendererFactory","tetrisFactory","TIC_PER_SEC",function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){this.config=a,this.grid=b,this.tetris=[],this.visual=[],d.reset(a.victory),this.tobefixed=[2,2],this.stop=!1,this.start=null,this.pause=!1,this.tics=0,c.getCurrentGame().reset(),c.getCurrentGame().gameCount+=1,void 0===e?this.callback=null:this.callback=e,this.init(),this.id=requestAnimationFrame(this.createRenderingFct())}return h.prototype.stopGame=function(){window.cancelAnimationFrame(this.id),this.stop=!0;for(var a=0;a<this.visual.length;a+=1)this.visual[a].clear(),this.visual[a]=null},h.prototype.createRenderingFct=function(){var a=this;return function(b){a.render(b)}},h.prototype.init=function(){for(var a=0;a<this.config.tetris.length;a+=1){this.tetris.push(f.newTetris(this.grid,this.config.tetris[a].cursors,this.stats));for(var c=0;c<this.config.tetris[a].mappings.length;c+=1)this.tetris[a].keyBoardMappings.push(b.getMapping(this.config.tetris[a].mappings[c]));this.visual.push(e.newRenderer(this.config.tetris[a].cursors)),this.visual[a].linkDom(this.config.tetris[a].gameBox),this.visual[a].renderTetris(this.tetris[a])}},h.prototype.splitScreenQuickFix=function(){if(2===this.tetris.length){for(;this.tobefixed[0]<this.tetris[1].getScore()/3;)this.tobefixed[0]+=1,this.tetris[0].randomFall();for(;this.tobefixed[1]<this.tetris[0].getScore()/3;)this.tobefixed[1]+=1,this.tetris[1].randomFall()}},h.prototype.togglePause=function(a){return this.stop?!1:(void 0===a?this.pause=!this.pause:this.pause=a,this.pause?window.cancelAnimationFrame(this.id):(this.id=requestAnimationFrame(this.createRenderingFct()),this.start=null),b.clear(),this.pause)},h.prototype.render=function(c){var e;null===this.start&&(this.start=c-this.tics/g*1e3);var f=c-this.start;$(".timeBox").html(a.timeFromTics(this.tics));for(var h=!0,i=0;this.tics<f*g/1e3&&h&&10>i;){for(i+=1,this.tics+=1,e=0;e<this.tetris.length;e+=1)this.tetris[e].oneTick(),$("#"+this.config.tetris[e].scoreBox).html(this.tetris[e].getScore()),d.check(this.tetris[e]),d.defeat()||d.victory()?(h=!1,this.visual[e].freezeGame()):void 0!==this.config.victory&&void 0!==this.config.victory.swaps?$("#"+this.config.tetris[e].swapBox).html(this.config.victory.swaps-this.tetris[e].getSwaps()):$("#"+this.config.tetris[e].swapBox).html(this.tetris[e].getSwaps());b.clear()}if(h&&!this.stop){for(e=0;e<this.tetris.length;e+=1)this.visual[e].renderTetris(this.tetris[e]);this.splitScreenQuickFix(),this.id=requestAnimationFrame(this.createRenderingFct(this))}else h||null!==this.callback&&this.callback(this)},{newGame:function(a,b,c){return new h(a,b,c)}}}]);