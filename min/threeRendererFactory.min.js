angular.module("angularApp.factories").factory("threeRendererFactory",["gameConstants","blockFactory",function(a,b){"use strict";function c(a){void 0===a&&(a=1),this.camera=this.createCamera(),this.renderer=this.createRenderer(),this.light=this.createLight(),this.cursor=[this.createCursor(32896)];for(var b=1;a>b;b+=1)this.cursor.push(this.createCursor(8388736));this.scene=this.createScene(),this.offset=0,this.id=String.fromCharCode(65+Math.floor(26*Math.random()))+Date.now()}function d(c,d){return c.state===b.EState.SwappedLeft?d+a.pixelPerBox/100*(100-c.animationState):c.state===b.EState.SwappedRight?d-a.pixelPerBox/100*(100-c.animationState):d}return c.prototype.clear=function(){this.scene=null,this.light=null,this.camera=null,this.cursor=null,this.renderer=null},c.prototype.createLight=function(){var a=new THREE.DirectionalLight(13421772);return a.position.set(500,1e3,2e3),a.castShadow=!0,a.shadowCameraVisible=!1,a.shadowDarkness=.2,a.shadowMapWidth=a.shadowMapHeight=1e3,a},c.prototype.createScene=function(){var b=new THREE.Scene;b.add(this.light);for(var c=0;c<this.cursor.length;c+=1)b.add(this.cursor[c]);var d=new THREE.PlaneGeometry(1e3,400),e=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!0,opacity:.5}),f=new THREE.Mesh(d,e);f.rotation.x+=1.62,f.position.setY(a.hiddenRowCount*a.pixelPerBox-a.pixelPerBox/2),f.renderDepth=1,b.add(f),d=new THREE.BoxGeometry(1e3,3,3),e=new THREE.MeshPhongMaterial({color:3342336,emissive:10027008});var g=new THREE.Mesh(d,e);return g.position.set(0,(a.hiddenRowCount+a.displayedRowCount)*a.pixelPerBox,10),b.add(g),d=new THREE.BoxGeometry(1e3,3,3),e=new THREE.MeshPhongMaterial({color:13056,emissive:39168}),g=new THREE.Mesh(d,e),g.position.set(0,a.hiddenRowCount*a.pixelPerBox-a.pixelPerBox/2+5,10),b.add(g),b},c.prototype.createCamera=function(){var a=new THREE.PerspectiveCamera(75,.7,.3,1e3);return a.position.z=450,a.position.x=-27,a.position.y=410,a},c.prototype.createRenderer=function(){var a=new THREE.WebGLRenderer({antialias:!0});return a.setClearColor(0),a.setSize(420,600),a.shadowMapEnabled=!0,a.shadowMapSoft=!0,a},c.prototype.addCube=function(b){var c=new THREE.BoxGeometry(.7*a.pixelPerBox,.7*a.pixelPerBox,a.pixelPerBox/4),d=new THREE.MeshPhongMaterial({color:b,emissive:1118481}),e=new THREE.Mesh(c,d);return this.scene.add(e),e.id},c.prototype.updateCube=function(a,c){var e=this.scene.getObjectById(c.id);e.position.setY(c.verticalPosition+this.offset),e.position.setX(d(c,a)),e.material.color=new THREE.Color(c.getHexColor()),c.state===b.EState.Disappearing&&(e.material.opacity=Math.max(1-c.animationState/100,0),e.material.transparent=!0),0===e.material.opacity&&(this.scene.remove(e),c.id=-1)},c.prototype.render=function(){this.light.position.setY(1e3+this.offset),this.renderer.render(this.scene,this.camera)},c.prototype.linkDom=function(a){this.renderer.domElement.setAttribute("id",this.id);var b=$("#"+a+" .gamePlaceHolder");if(0===b.length)throw a+"missing gameplaceHolder";b.empty(),b.append($(this.renderer.domElement))},c.prototype.unlinkDom=function(){var a=document.getElementById(this.id);null!==a&&a.parentNode.removeChild(a)},c.prototype.createCursor=function(a){var b=new THREE.Shape;return b.absarc(72,-13,10,-Math.PI/2,0,!0),b.lineTo(82,0),b.absarc(72,13,10,0,Math.PI/2,!0),b.lineTo(35,20),b.lineTo(35,0),b.absarc(-2,-13,10,3*Math.PI/2,Math.PI,!0),b.lineTo(-12,0),b.absarc(-2,13,10,Math.PI,Math.PI/2,!0),b.lineTo(35,-20),new THREE.PointCloud(b.createPointsGeometry(),new THREE.PointCloudMaterial({color:a,size:4}))},c.prototype.drawCursorOn=function(b,c,d){void 0===d&&(d=0),this.cursor[d].position.set((b-a.columnCount/2)*a.pixelPerBox-10,c*(a.pixelPerBox-.5)+this.offset+5,7)},c.prototype.freezeGame=function(){for(var a=0;a<this.cursor.length;a+=1)this.scene.remove(this.cursor[a]);this.render()},c.prototype.renderTetris=function(c){this.offset=c.groundPos;for(var d,e=0;e<a.columnCount;e+=1)for(var f=0;f<c.grid.container[e].length;f+=1)d=c.grid.container[e][f],d.type!==b.EType.PlaceHolder&&(-1===d.id&&(d.id=this.addCube(d.getHexColor())),this.updateCube((e-a.columnCount/2)*a.pixelPerBox,d));for(e=0;e<c.cursor.length;e+=1)this.drawCursorOn(c.cursor[e].x,c.cursor[e].y,e);this.render()},{newRenderer:function(a){return new c(a)}}}]);