angular.module("angularApp.factories").factory("gridEvaluator",["gameConstants","userStats","blockFactory",function(a,b,c){"use strict";var d=function(){this.series=[]};return d.prototype.evaluateColumn=function(b,d){for(var e=0,f=null,g=-1,h=a.hiddenRowCount;h<b[d].length;h+=1)b[d][h].state!==c.EState.Blocked?(e=0,f=null):b[d][h].type!==f?(f=b[d][h].type,e=1):(e+=1,3===e?(b[d][h].setState(c.EState.Disappearing),b[d][h-1].setState(c.EState.Disappearing),b[d][h-2].setState(c.EState.Disappearing),this.series.push([]),g=this.series.length-1,this.series[g].push(b[d][h].id),this.series[g].push(b[d][h-1].id),this.series[g].push(b[d][h-2].id)):e>3&&(b[d][h].setState(c.EState.Disappearing),this.series[g].push(b[d][h].id)))},d.prototype.evaluateVertical=function(b){for(var c=0;c<a.columnCount;c+=1)this.evaluateColumn(b,c)},d.prototype.findBlockIndex=function(b,c,d){var e;for(e in b[c])if(b[c].hasOwnProperty(e)&&b[c][e].verticalPosition===a.pixelPerBox*d)return parseInt(e);return-1},d.prototype.evaluateLine=function(b,d){var e,f,g,h=-1,i=-1,j=-1;g=0,f=null;var k=-1;for(e=0;e<a.columnCount;e+=1)if(j=i,i=h,h=this.findBlockIndex(b,e,d),-1!==h){var l=b[e][h];l.state===c.EState.Blocked||l.state===c.EState.Disappearing&&0===l.animationState?(l.type!==f&&(f=b[e][h].type,g=0),g+=1,3===g?(b[e][h].setState(c.EState.Disappearing),b[e-1][i].setState(c.EState.Disappearing),b[e-2][j].setState(c.EState.Disappearing),this.series.push([]),k=this.series.length-1,this.series[k].push(b[e][h].id),this.series[k].push(b[e-1][i].id),this.series[k].push(b[e-2][j].id)):g>3&&(b[e][h].setState(c.EState.Disappearing),this.series[k].push(b[e][h].id))):g=0}else g=0},d.prototype.evaluateHorizontal=function(b){for(var c=a.hiddenRowCount;c<a.displayedRowCount+a.hiddenRowCount;c+=1)this.evaluateLine(b,c)},d.prototype.getScore=function(){for(var a=this.series.length,b=0,c=0;a>c;c+=1)b+=(this.series[c].length-2)*a;return b},d.prototype.getSerie=function(a,b){for(var c=b-1;c>=0;c-=1)for(var d=0;d<this.series[c].length;d+=1)if(this.series[c][d]===a)return c;return-1},d.prototype.mergeSeries=function(){for(var a=this.series.length-1;a>=0;a-=1)for(var b=0;b<this.series[a].length;b+=1){var c=this.getSerie(this.series[a][b],a);if(-1!==c){this.series[c]=this.series[c].concat(this.series[a]),this.series.splice(a,1);break}}},d.prototype.evaluate=function(a){return this.series=[],this.evaluateVertical(a),this.evaluateHorizontal(a),this.mergeSeries(),b.getCurrentGame().addLines(this.series,this.getScore()),this.getScore()},new d}]);