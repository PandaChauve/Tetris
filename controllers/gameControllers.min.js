var gameControllers=angular.module("angularApp.controllers");
gameControllers.controller("GameCtrl",["$scope","$http","$route","$routeParams","$modal","$window",function(a,g,k,h,d,c){a.gameName=h.name||"classic";a.confi={};a.game=null;a.confi.splitScreen="classicSplitScreen"===a.gameName;a.load=function(){g.get("games/"+a.gameName+".json",{cache:!1}).success(function(b){a.useGameConfig(b)}).error(function(a){console.log(a)})};a.load();a.pause={toggle:function(){a.pause.active=a.game.TogglePause()},active:!1};a.$on("$routeChangeStart",function(){a.game&&(a.game.Stop(),
a.game=null)});a.reset=function(){a.game.Stop();a.game=new Game(a.game.config,a.game.grid,a.endCallBack);a.game.Start()};angular.element(c).bind("blur",function(){return function(){a.game&&(a.pause.active=!0,a.game.TogglePause(!0),a.$apply())}}());a.useGameConfig=function(b){CONFIG=GetConfig(b.config);""==b.grid?(a.game=new Game(b,"",a.endCallBack),a.game.Start()):g.get("grids/"+b.grid+".json",{cache:!1}).success(function(e){a.game=new Game(b,e,a.endCallBack);a.game.Start()}).error(function(a){console.log(a)})};
a.endCallBack=function(b){b.stats.SetTime(b.tics);b.stats.SetSwaps(b.tetris[0].swapCount);var c=UserStats.GetUserStats();c.AddGame(b.stats,a.gameName);(new AchievementsState).check(b.stats,c,a.gameName);a.open(b.stateChecker.lastSuccessCheck,b.stats)};a.open=function(b,c){d.open({animation:!0,templateUrl:"templates/modal.html",controller:"ModalInstanceCtrl",size:300,resolve:{won:function(){return b},gameName:function(){return a.gameName},statistics:function(){return c}}}).result.then(function(){b&&
a.game.config.next?(a.gameName=a.game.config.next,k.updateParams({name:a.gameName}),a.load()):a.reset()},function(){})}}]);
gameControllers.controller("ModalInstanceCtrl",["$scope","$modalInstance","won","gameName","statistics",function(a,g,k,h,d){a.won=k;a.published=!1;a.publish=function(){if(!a.published){a.published=!0;var c=UserStorage.GetStorage(),b=c.Get("UserName")||"";(b=prompt("Who are you ?",b))?(c.Set("UserName",b),c=stringToHex(des("wireshar","yop"+stats.score,1,0)),$.get("http://sylvain.luthana.be/api.php?add&name="+b+"&value="+c+"&map="+h)):a.published=!1}};a.nextGame=function(){g.close()};a.stop=function(){g.dismiss("cancel")};
a.stats=function(){function a(b,c,d){void 0===d&&(d=Math.floor);return d(b/c)}var b=UserStats.GetUserStats(),e=b.GetBestGameStats(h),b=b.GetTotalGameStats(h),f=[];f.push({name:"Score",value:d.score,best:e.score,sum:b.score,mean:a(b.score,b.gameCount)});f.push({name:"Time",value:TimeFromTics(d.time),best:TimeFromTics(e.time),sum:TimeFromTics(b.time),mean:a(b.time,b.gameCount,TimeFromTics)});f.push({name:"Blocks",value:d.blockDestroyed,best:e.blockDestroyed,sum:b.blockDestroyed,mean:a(b.blockDestroyed,
b.gameCount)});f.push({name:"Swaps",value:d.swapCount,best:e.swapCount,sum:b.swapCount,mean:a(b.swapCount,b.gameCount)});f.push({name:"Efficiency",value:(d.score/d.swapCount).toFixed(2),best:"/",sum:"/",mean:(b.score/b.swapCount).toFixed(2)});return f}()}]);
